<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Necessary</title>
</head>


<body>
<div class="head">
<h1>Theory Necessary</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Necessary
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Computation.html">Computation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> necessary' <span class="main">=</span> knft<span class="main">:</span> kNFT <span class="quoted"><span class="free">ninit</span></span> <span class="quoted"><span class="free">nδ</span></span> <span class="quoted"><span class="free">naccept</span></span> <span class="quoted"><span class="free">nQ</span></span> <span class="main">+</span> koTDFA <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ninit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nδ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'b</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">naccept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nQ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span> Al <span class="main">×</span> <span class="tfree">'b</span> Al <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span> option"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> set"</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.τ <span class="main">=</span> τ"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fδ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'b</span> Al <span class="main">×</span> <span class="tfree">'a</span> Al <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fδ</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">b1</span><span class="main">,</span> <span class="bound">b2</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">b2</span><span class="main">,</span> <span class="bound">b1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> flip<span class="main">:</span> oTDFA <span class="quoted"><span class="free">init</span></span> <span class="quoted">fδ</span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_Q init_in_Q closed move_left move_right no_step move_one
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> flip_comp_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> flip.computation <span class="free">q</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> flip_comp_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"flip.computation <span class="free">q</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> flip.computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flip_comp_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"flip.computation <span class="free">q</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟷</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flip_comp_intro flip_comp_dest
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> flip_comp_to_states <span class="main">=</span> flip.comp_to_states<span class="main">[</span><span class="operator">unfolded</span> flip_comp_eq<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> flip_states_to_comp <span class="main">=</span> flip.states_to_comp<span class="main">[</span><span class="operator">unfolded</span> flip_comp_eq<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> flip_split_outs <span class="main">=</span> flip.split_outs<span class="main">[</span><span class="operator">unfolded</span> flip_comp_eq<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> split_long<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span> <span class="bound">v''</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">v'</span> <span class="main">@</span> <span class="bound">v''</span> <span class="main">∧</span> length <span class="bound">v''</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id diff_diff_cancel length_drop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concat_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qbs</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="free">ns</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">⟹</span>
  concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">,</span> <span class="bound">tqs</span><span class="main">)</span><span class="main">.</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">,</span> <span class="bound">tqs</span><span class="main">)</span><span class="main">.</span> <span class="bound">bs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span>
  <span class="main">(</span>zip <span class="free">ns</span> <span class="main">(</span>zip <span class="free">qbs</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map snd <span class="free">qbs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">qbs</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x xs y ys ns
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> concat_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="bound">tqs</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">,</span> <span class="bound">tqs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">qss'</span> <span class="main">⟹</span> length <span class="bound">bs</span> <span class="main">≤</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟹</span>
  length <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">,</span> <span class="bound">tqs</span><span class="main">)</span><span class="main">.</span> <span class="bound">bs</span><span class="main">)</span> <span class="free">qss'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">qss'</span> <span class="main">*</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">qss'</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="free">xs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_le nth_eq_iff_index_eq sorted_iff_nth_mono_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map2_zip<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qbs</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="free">qbs</span> <span class="main">=</span> length <span class="free">ns</span> <span class="main">⟹</span>
  <span class="free">qbs</span> <span class="main">=</span> map2 <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="main">(</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">,</span> <span class="bound">tqs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span> <span class="free">ns</span> <span class="main">(</span>zip <span class="free">qbs</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">qbs</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x xs y ys ns
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> map2_zip'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">qbs</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="free">qbs</span> <span class="main">=</span> length <span class="free">ns</span> <span class="main">⟹</span>
  <span class="free">xs</span> <span class="main">=</span> map2 <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="main">(</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">bs'</span><span class="main">,</span> <span class="bound">q'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">bs'</span><span class="main">,</span> <span class="bound">q'</span><span class="main">)</span><span class="main">)</span> <span class="free">ns</span> <span class="main">(</span>zip <span class="free">qbs</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">qbs</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x xs y ys ns
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ys</span> <span class="bound">ys'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ys'</span> <span class="main">∧</span>
  length <span class="bound">ys</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> length <span class="bound">ys'</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> n xs
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons length_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_two<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">n'</span> <span class="main">⟹</span> <span class="free">n'</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">ys</span> <span class="bound">ys'</span> <span class="bound">ys''</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ys'</span> <span class="main">@</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n'</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ys''</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span>
  length <span class="bound">ys'</span> <span class="main">=</span> <span class="free">n'</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">ys''</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">(</span><span class="free">n'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n'</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 split_one<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">xs'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> n'_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">n'</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">xs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="skolem"><span class="skolem">ys''</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ys'</span> <span class="main">@</span> <span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys''</span>"</span></span>
      <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys'</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys''</span> <span class="main">=</span> length <span class="skolem">xs</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">n'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> n'_shift<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">x</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">ys</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> split Suc<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wits<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="free">P</span> <span class="bound">w</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws</span><span class="main">.</span> length <span class="bound">ws</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="bound">ws</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">w</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">w</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws_def<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">ws</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> w_def ws_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">#</span> <span class="skolem">ws</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sel1</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sel1'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sel2</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sel2'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sel3</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">z</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sel3'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sel4</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">z</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sel4'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">w</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wits3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="free">P</span> <span class="bound">w</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws</span><span class="main">.</span> length <span class="bound">ws</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="bound">ws</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">w</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wits<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted">sel1</span> <span class="quoted">sel2</span> <span class="quoted">sel3</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sel1_def sel2_def sel3_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'x</span> list list <span class="main">⇒</span> <span class="tfree">'x</span> list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">trans</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">=</span> map hd <span class="free"><span class="bound"><span class="entity">xss</span></span></span> <span class="main">#</span> <span class="free">trans</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>map tl <span class="free"><span class="bound"><span class="entity">xss</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> len_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>trans <span class="free">n</span> <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trans.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> set <span class="free">xss</span> <span class="main">⟹</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span>
  set <span class="main">(</span>trans <span class="free">n</span> <span class="free">xss</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">=</span> length <span class="free">xss</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trans.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">n</span> <span class="skolem">xss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>trans <span class="skolem">n</span> <span class="main">(</span>map tl <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">=</span> length <span class="main">(</span>map tl <span class="skolem">xss</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.set_sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> length_greater_0_conv list.set_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subsetD zero_less_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> trans_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> set <span class="free">xss</span> <span class="main">⟹</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xss</span> <span class="main">⟹</span> trans <span class="free">n</span> <span class="free">xss</span> <span class="main">!</span> <span class="free">i</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="free">xss</span> <span class="main">!</span> <span class="free">j</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trans.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> One_nat_def Suc_pred hd_conv_nth imageE length_0_conv length_tl less_Suc_eq_0_disj
      nat.inject nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_Cons_0 nth_Cons_Suc nth_map nth_mem nth_tl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> one_loop_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">s</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">nQ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">v</span> <span class="main">≥</span> <span class="main">(</span>card <span class="free">nQ</span> <span class="main">*</span> card <span class="free">Q</span> <span class="main">^</span> length <span class="free">ws</span><span class="main">)</span> <span class="main">*</span> knft.output_speed <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u''</span> <span class="bound">v''</span><span class="main">.</span> length <span class="bound">v''</span> <span class="main">&lt;</span> length <span class="free">v</span> <span class="main">∧</span> knft.computation <span class="free">s</span> <span class="main">(</span><span class="bound">u''</span><span class="main">,</span> <span class="bound">v''</span><span class="main">)</span> <span class="free">s'</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span><span class="main">.</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">u''</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span>
    safe_hd <span class="free">u</span> <span class="main">=</span> safe_hd <span class="bound">u''</span> <span class="main">∧</span> safe_hd <span class="free">v</span> <span class="main">=</span> safe_hd <span class="bound">v''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qbs</span></span> <span class="keyword2"><span class="keyword">where</span></span> qbs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.computation_ext <span class="free">s</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="skolem">qbs</span><span class="main">)</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> concat <span class="main">(</span>map snd <span class="skolem">qbs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.computation_ext_complete<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> qbs_output_speed <span class="main">=</span> knft.output_speed_ext_computation<span class="main">[</span><span class="operator">OF</span> qbs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> len_qbs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qbs</span> <span class="main">=</span> length <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.computation_ext_length<span class="main">[</span><span class="operator">OF</span> qbs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tqss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> tqss'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">tqss'</span> <span class="main">=</span> length <span class="free">ws</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tqs</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">tqs</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">tqss'</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⟹</span>
      flip.computation_ext <span class="bound">r</span> <span class="main">(</span><span class="bound">tqs</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wits3<span class="main">[</span><span class="operator">OF</span> flip.comp_to_ext<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> set_tqss'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tqs</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">tqs</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">tqss'</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⟹</span> set <span class="bound">tqs</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flip.ext_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tqss'_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_zip_rightD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_tqss'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tqs</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">tqs</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">tqss'</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⟹</span> length <span class="bound">tqs</span> <span class="main">=</span> length <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flip.comp_ext_length<span class="main">[</span><span class="operator">OF</span> tqss'_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tqss</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tqss</span> <span class="main">=</span> trans <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="skolem">tqss'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qss</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qss</span> <span class="main">=</span> zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">qbs</span><span class="main">]</span> <span class="main">(</span>zip <span class="skolem">qbs</span> <span class="skolem">tqss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> len_tqss<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">tqss</span> <span class="main">=</span> length <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tqss_def len_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_qss<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qss</span> <span class="main">=</span> length <span class="skolem">qbs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_qbs len_tqss
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qss_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fst_qss_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">qss</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="skolem">qss</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_qbs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qss_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fst_set_qss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">qss</span> <span class="main">⟹</span> fst <span class="bound">x</span> <span class="main">&lt;</span> length <span class="skolem">qss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_qbs len_tqss
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qss_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qss'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">,</span> <span class="bound">tqs</span><span class="main">)</span><span class="main">.</span> <span class="bound">bs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">qss</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> fst_set_qss'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">qss'</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">qss</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qss'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">,</span> <span class="bound">tqs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">tqs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qss'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> qss'_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">qss'</span> <span class="main">⟹</span>
    fst <span class="main">(</span><span class="skolem">qss'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">qss</span> <span class="main">∧</span> <span class="skolem">qss'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">qss</span> <span class="main">!</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">qss'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst_qss_at fst_set_qss' fst_set_qss
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> fst_set_qss' in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> qss'_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="bound">tqs</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">,</span> <span class="bound">tqs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">qss'</span> <span class="main">⟹</span> <span class="bound">bs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qss'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sorted_fst_qss<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">qss</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">qss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_qbs len_tqss
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qss_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sorted_fst_qss'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">qss'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">qss'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> qss'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_filter<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sorted_fst_qss<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">rule</span> distinct_map_filter<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sorted_fst_qss<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">=</span> length <span class="skolem">qss'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_qbs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">qbs</span> <span class="main">⟹</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">nQ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.computation_ext_closed<span class="main">[</span><span class="operator">OF</span> qbs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> tqs_tqss'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tqs</span><span class="main">.</span> <span class="bound">tqs</span> <span class="main">∈</span> set <span class="skolem">tqss'</span> <span class="main">⟹</span> set <span class="bound">tqs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> length <span class="bound">tqs</span> <span class="main">=</span> length <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tqs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tqs</span> <span class="main">∈</span> set <span class="skolem">tqss'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">tqss'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tqss'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">tqs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tqs</span><span class="main">,</span> fst <span class="main">(</span><span class="free">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span>snd <span class="main">(</span><span class="free">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>snd <span class="main">(</span><span class="free">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">tqss'</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tqss'_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">tqs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> length <span class="skolem">tqs</span> <span class="main">=</span> length <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> len_tqss' set_tqss'
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> concat_qss'<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">,</span> <span class="bound">tqs</span><span class="main">)</span><span class="main">.</span> <span class="bound">bs</span><span class="main">)</span> <span class="skolem">qss'</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map snd <span class="skolem">qbs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> concat_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">qbs</span></span> <span class="quoted"><span class="skolem">tqss</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">qbs</span><span class="main">]</span>"</span></span><span class="main">]</span> len_qbs len_tqss
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qss'_def qss_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_v_le<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">v</span> <span class="main">≤</span> length <span class="skolem">qss'</span> <span class="main">*</span> knft.output_speed"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> concat_qss'<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> qbs_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> concat_length<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">qss'</span></span></span></span> <span class="quoted"><span class="quoted">knft.output_speed</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> qbs_output_speed
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qss'_def qss_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD set_zip_rightD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_qs_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">≥</span> card <span class="free">nQ</span> <span class="main">*</span> card <span class="free">Q</span> <span class="main">^</span> length <span class="free">ws</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>length <span class="skolem">qs</span> <span class="main">≥</span> card <span class="free">nQ</span> <span class="main">*</span> card <span class="free">Q</span> <span class="main">^</span> length <span class="free">ws</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">*</span> knft.output_speed <span class="main">≤</span>
      <span class="main">(</span>card <span class="free">nQ</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">Q</span> <span class="main">^</span> <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> knft.output_speed"</span></span>
      <span class="keyword1"><span class="command">using</span></span> knft.output_speed_pos
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le_trans<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> len_v_le<span class="main">]</span> le_trans
      <span class="keyword1"><span class="command">unfolding</span></span> len_qs<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> qs_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">qs</span> <span class="main">⊆</span> <span class="free">nQ</span> <span class="main">×</span> <span class="main">{</span><span class="bound">tqs</span><span class="main">.</span> set <span class="bound">tqs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> length <span class="bound">tqs</span> <span class="main">=</span> length <span class="free">ws</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_qbs set_trans<span class="main">[</span><span class="operator">OF</span> tqs_tqss'<span class="main">]</span> len_qbs len_tqss tqss'_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qs_def qss'_def qss_def tqss_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD set_zip_rightD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> not_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="skolem">qs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span> distinct <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">qs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> card_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="skolem">qs</span><span class="main">)</span> <span class="main">≥</span> card <span class="free">nQ</span> <span class="main">*</span> card <span class="free">Q</span> <span class="main">^</span> length <span class="free">ws</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_card<span class="main">[</span><span class="operator">OF</span> contr<span class="main">]</span> len_qs_ge
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> finite_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">tqs</span><span class="main">.</span> set <span class="bound">tqs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> length <span class="bound">tqs</span> <span class="main">=</span> length <span class="free">ws</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> card_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">tqs</span><span class="main">.</span> set <span class="bound">tqs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> length <span class="bound">tqs</span> <span class="main">=</span> length <span class="free">ws</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span>card <span class="free">Q</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_lists_length_eq<span class="main">[</span><span class="operator">OF</span> finite_Q<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="free">ws</span>"</span></span><span class="main">]</span>
        card_lists_length_eq<span class="main">[</span><span class="operator">OF</span> finite_Q<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="free">ws</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> finite_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">nQ</span> <span class="main">×</span> <span class="main">{</span><span class="bound">tqs</span><span class="main">.</span> set <span class="bound">tqs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> length <span class="bound">tqs</span> <span class="main">=</span> length <span class="free">ws</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> knft.finite_Q finite_lists
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> card_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">nQ</span> <span class="main">×</span> <span class="main">{</span><span class="bound">tqs</span><span class="main">.</span> set <span class="bound">tqs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span> length <span class="bound">tqs</span> <span class="main">=</span> length <span class="free">ws</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
      card <span class="free">nQ</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">Q</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> card_cartesian_product card_lists <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_qs card_mono<span class="main">[</span><span class="operator">OF</span> finite_prod qs_sub<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qc</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="skolem"><span class="skolem">qs''</span></span> <span class="skolem"><span class="skolem">qs'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> qs_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">=</span> <span class="skolem">qs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">qc</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">qs''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">qc</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">qs'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_distinct_decomp<span class="main">[</span><span class="operator">OF</span> not_distinct<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">qss'</span> <span class="main">!</span> length <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">qss'</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">qs'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="skolem">qs''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_idx<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs'</span> <span class="main">&lt;</span> length <span class="skolem">qss'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="skolem">qs''</span> <span class="main">&lt;</span> length <span class="skolem">qss'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qs_split len_qs len_qss
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> qs_split_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">qs'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">qc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">qs'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="skolem">qs''</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">qc</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qs_split
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right nth_Cons_Suc nth_append_length nth_append_length_plus<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> n_n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">n'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> length <span class="skolem">qbs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qss</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">qss'</span> <span class="main">!</span> length <span class="skolem">qs'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">qss</span> <span class="main">!</span> <span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">qss'</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">qs'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="skolem">qs''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qss'_at<span class="main">[</span><span class="operator">OF</span> valid_idx<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">folded</span> n_def<span class="main">]</span> qss'_at<span class="main">[</span><span class="operator">OF</span> valid_idx<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">folded</span> n'_def<span class="main">]</span>
          len_qss valid_idx sorted_dest<span class="main">[</span><span class="operator">OF</span> sorted_fst_qss'<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def n'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> n_len_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> length <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n_n'<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> len_qbs
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> qbs_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qbs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">,</span> <span class="bound">tqs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map2_zip<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">qbs</span></span> <span class="quoted"><span class="skolem">tqss</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">qbs</span><span class="main">]</span>"</span></span><span class="main">]</span> len_qbs len_tqss
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qss_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qbs'</span></span> <span class="skolem"><span class="skolem">qbs''</span></span> <span class="skolem"><span class="skolem">qbs'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qbs</span> <span class="main">=</span> <span class="skolem">qbs'</span> <span class="main">@</span> <span class="skolem">qbs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">#</span> <span class="skolem">qbs''</span> <span class="main">@</span> <span class="skolem">qbs</span> <span class="main">!</span> <span class="skolem">n'</span> <span class="main">#</span> <span class="skolem">qbs'''</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">qbs'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qbs''</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qbs'''</span> <span class="main">=</span> length <span class="skolem">qbs</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">n'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_two<span class="main">[</span><span class="operator">OF</span> n_n'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> bs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qbs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span>fst <span class="skolem">qc</span><span class="main">,</span> <span class="skolem">bs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qbs_map n_n' qs_def len_qs qs_split_at<span class="main">(</span>1<span class="main">)</span> valid_idx<span class="main">(</span>1<span class="main">)</span> qss'_nonempty
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> bs''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qbs</span> <span class="main">!</span> <span class="skolem">n'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="skolem">qc</span><span class="main">,</span> <span class="skolem">bs''</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs''</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qbs_map n_n' qs_def len_qs qs_split_at<span class="main">(</span>2<span class="main">)</span> valid_idx<span class="main">(</span>2<span class="main">)</span> qss'_nonempty
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tqss_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tqss</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> snd <span class="skolem">qc</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qs_split_at<span class="main">(</span>1<span class="main">)</span> qs_def qss'_at<span class="main">[</span><span class="operator">OF</span> valid_idx<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">folded</span> n_def<span class="main">]</span> valid_idx<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qss_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tqss_n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tqss</span> <span class="main">!</span> <span class="skolem">n'</span> <span class="main">=</span> snd <span class="skolem">qc</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qs_split_at<span class="main">(</span>2<span class="main">)</span> qs_def qss'_at<span class="main">[</span><span class="operator">OF</span> valid_idx<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">folded</span> n'_def<span class="main">]</span> valid_idx<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qss_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="skolem"><span class="skolem">cs''</span></span> <span class="skolem"><span class="skolem">cs'''</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="skolem"><span class="skolem">c''</span></span> <span class="skolem"><span class="skolem">bs'a</span></span> <span class="skolem"><span class="skolem">bs'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> new_comp<span class="main">:</span>
    <span class="quoted"><span class="quoted">"knft.computation <span class="free">s</span> <span class="main">(</span><span class="skolem">cs'</span> <span class="main">@</span> <span class="skolem">c'</span> <span class="main">#</span> <span class="skolem">cs'''</span><span class="main">,</span> <span class="skolem">bs'a</span> <span class="main">@</span> <span class="skolem">bs'</span> <span class="main">@</span> <span class="skolem">bs'''</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">bs'a</span> <span class="main">=</span> concat <span class="main">(</span>map snd <span class="skolem">qbs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'''</span> <span class="main">=</span> concat <span class="main">(</span>map snd <span class="skolem">qbs'''</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">cs'</span> <span class="main">@</span> <span class="skolem">c'</span> <span class="main">#</span> <span class="skolem">cs''</span> <span class="main">@</span> <span class="skolem">c''</span> <span class="main">#</span> <span class="skolem">cs'''</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs'</span> <span class="main">=</span> length <span class="skolem">qbs'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs''</span> <span class="main">=</span> length <span class="skolem">qbs''</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">cs'''</span> <span class="main">=</span> length <span class="skolem">qbs'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.computation_ext_rem<span class="main">[</span><span class="operator">OF</span> qbs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> decomp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> bs'_def bs''_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> new_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">bs'a</span> <span class="main">@</span> <span class="skolem">bs'</span> <span class="main">@</span> <span class="skolem">bs'''</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_comp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> qbs_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> decomp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bs'_def bs''_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> rem_tqss'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span> <span class="main">⟹</span>
    flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs'</span> <span class="main">@</span> <span class="skolem">c'</span> <span class="main">#</span> <span class="skolem">cs'''</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">r</span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">assume</span></span> in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">ws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tqss'_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tqs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tqs</span> <span class="main">=</span> <span class="skolem">tqss'</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> in_set_zip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tqs</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">tqss'</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set i_def tqss'_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth tqs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> len_tqs <span class="main">=</span> len_tqss'<span class="main">[</span><span class="operator">OF</span> in_set_zip<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> trans_n<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="skolem">tqss'</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">tqss'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> tqs_tqss' n_len_u<span class="main">(</span>1<span class="main">)</span> i_def<span class="main">(</span>1<span class="main">)</span> tqss'_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> trans_n'<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="skolem">tqss'</span> <span class="main">!</span> <span class="skolem">n'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">tqss'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">!</span> <span class="skolem">n'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> tqs_tqss' n_len_u<span class="main">(</span>2<span class="main">)</span> i_def<span class="main">(</span>1<span class="main">)</span> tqss'_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> tqs_n_n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tqs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">tqs</span> <span class="main">!</span> <span class="skolem">n'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tqss_n tqss_n'
      <span class="keyword1"><span class="command">unfolding</span></span> tqs_def trans_n<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> trans_n'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> tqss_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="skolem"><span class="skolem">ys''</span></span> <span class="keyword2"><span class="keyword">where</span></span> tqs_split<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">tqs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">tqs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ys'</span> <span class="main">@</span> <span class="skolem">tqs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ys''</span>"</span></span>
      <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys'</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys''</span> <span class="main">=</span> length <span class="skolem">tqs</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">n'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_two<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">n'</span></span> <span class="quoted"><span class="skolem">tqs</span></span><span class="main">]</span> n_n'<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> len_qbs len_tqs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tqs_n_n'<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> comp_orig<span class="main">:</span> <span class="quoted"><span class="quoted">"flip.computation_ext <span class="skolem">r</span>
      <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">tqs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ys'</span> <span class="main">@</span> <span class="skolem">tqs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ys''</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs'</span> <span class="main">@</span> <span class="skolem">c'</span> <span class="main">#</span> <span class="skolem">cs''</span> <span class="main">@</span> <span class="skolem">c''</span> <span class="main">#</span> <span class="skolem">cs'''</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tqss'_def<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> in_set_zip<span class="main">,</span> <span class="operator">unfolded</span> new_comp<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tqs_split<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> comp_new<span class="main">:</span> <span class="quoted"><span class="quoted">"flip.computation_ext <span class="skolem">r</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">tqs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ys''</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs'</span> <span class="main">@</span> <span class="skolem">c'</span> <span class="main">#</span> <span class="skolem">cs'''</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> flip.ext_rem_loop<span class="main">[</span><span class="operator">OF</span> comp_orig<span class="main">]</span> tqs_split<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> decomp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> new_comp<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flip.computation <span class="skolem">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs'</span> <span class="main">@</span> <span class="skolem">c'</span> <span class="main">#</span> <span class="skolem">cs'''</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> flip.ext_to_comp<span class="main">[</span><span class="operator">OF</span> comp_new<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_hd <span class="free">u</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="skolem">cs'</span> <span class="main">@</span> <span class="skolem">c'</span> <span class="main">#</span> <span class="skolem">cs'''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> new_comp<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_hd_app_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_hd <span class="free">v</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="skolem">bs'a</span> <span class="main">@</span> <span class="skolem">bs'</span> <span class="main">@</span> <span class="skolem">bs'''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> qbs_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> decomp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> safe_hd_app'' bs'_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bs'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> new_comp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> new_length new_comp<span class="main">(</span>1<span class="main">)</span> rem_tqss'
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tcard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tcard</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span>card <span class="free">nQ</span> <span class="main">*</span> card <span class="free">Q</span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> knft.output_speed"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> one_loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">s</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">nQ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">v</span> <span class="main">≥</span> tcard <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u''</span> <span class="bound">v''</span><span class="main">.</span> length <span class="bound">v''</span> <span class="main">&lt;</span> length <span class="free">v</span> <span class="main">∧</span> knft.computation <span class="free">s</span> <span class="main">(</span><span class="bound">u''</span><span class="main">,</span> <span class="bound">v''</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="free">s'</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span><span class="main">.</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">u''</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span>
    safe_hd <span class="free">u</span> <span class="main">=</span> safe_hd <span class="bound">u''</span> <span class="main">∧</span> safe_hd <span class="main">(</span><span class="free">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="bound">v''</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">as'</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span>
    <span class="quoted"><span class="quoted">"knft.computation <span class="free">s</span> <span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">s''</span>"</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s''</span> <span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">as'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">@</span> <span class="free">v'</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs</span> <span class="main">≤</span> length <span class="free">v</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">v</span> <span class="main">-</span> length <span class="skolem">cs</span> <span class="main">≤</span> knft.output_speed"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.computation_split_out<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> v_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">es</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_app<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> split<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="free">v'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> v_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">rs''</span> <span class="main">=</span> length <span class="free">ws</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r''</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">r''</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">rs''</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⟹</span>
      flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">as'</span> <span class="main">@</span> <span class="free">u'</span><span class="main">)</span> <span class="bound">r''</span> <span class="main">∧</span> flip.computation <span class="bound">r''</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wits3<span class="main">[</span><span class="operator">OF</span> flip.comp_splitL<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ws</span></span> <span class="quoted">sel1'</span> <span class="quoted">sel2'</span> <span class="quoted">sel3'</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sel1'_def sel2'_def sel3'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r''</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">rs''</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ws'_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> rs''_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws'_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_zip_rightD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> comp_ws'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws'</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">as'</span> <span class="main">@</span> <span class="free">u'</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rs''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_ws'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws'</span> <span class="main">=</span> length <span class="free">ws</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rs''_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="free">nQ</span> <span class="main">*</span> card <span class="free">Q</span> <span class="main">^</span> length <span class="skolem">ws'</span><span class="main">)</span> <span class="main">*</span> knft.output_speed <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> length <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> split<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> len_ws'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tcard_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> rem<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">v''</span> <span class="main">&lt;</span> length <span class="skolem">cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"knft.computation <span class="free">s</span> <span class="main">(</span><span class="skolem">u''</span><span class="main">,</span> <span class="skolem">v''</span><span class="main">)</span> <span class="skolem">s''</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws'</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">,</span> <span class="skolem">as'</span> <span class="main">@</span> <span class="free">u'</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"safe_hd <span class="skolem">as</span> <span class="main">=</span> safe_hd <span class="skolem">u''</span>"</span></span> <span class="quoted"><span class="quoted">"safe_hd <span class="skolem">cs</span> <span class="main">=</span> safe_hd <span class="skolem">v''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> one_loop_aux<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> comp_ws' ws'_Q len_cs<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> F1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rem<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> v_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> F3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span> <span class="main">@</span> <span class="skolem">as'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">r</span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">ws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">=</span> <span class="skolem">rs''</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r''</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rs''_def<span class="main">(</span>1<span class="main">)</span> i_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws'_def r''_def<span class="main">)</span>
         <span class="main">(</span><span class="operator">smt</span> case_prod_conv image_iff len_ws' length_map nth_mem nth_zip ws'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> comp1<span class="main">:</span> <span class="quoted"><span class="quoted">"flip.computation <span class="skolem">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">,</span> <span class="skolem">as'</span> <span class="main">@</span> <span class="free">u'</span><span class="main">)</span> <span class="skolem">r''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rem<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r''</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">rs''</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rs''_def<span class="main">(</span>1<span class="main">)</span> i_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r''_def in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> comp2<span class="main">:</span> <span class="quoted"><span class="quoted">"flip.computation <span class="skolem">r''</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rs''_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flip.computation <span class="skolem">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span> <span class="main">@</span> <span class="skolem">as'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> flip.comp_transR<span class="main">[</span><span class="operator">OF</span> comp1 comp2<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> F4<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">as'</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="skolem">u''</span> <span class="main">@</span> <span class="skolem">as'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rem<span class="main">(</span>4<span class="main">)</span> safe_hd_app
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> F5<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">es</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rem<span class="main">(</span>5<span class="main">)</span> safe_hd_app
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">u''</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">as'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">v''</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">es</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> F1 knft.comp_trans<span class="main">[</span><span class="operator">OF</span> rem<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> F3 F4 F5
    <span class="keyword1"><span class="command">unfolding</span></span> split<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> cs'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> one_conflict_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">s</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">nQ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">v</span> <span class="main">≥</span> tcard <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u''</span> <span class="bound">v''</span><span class="main">.</span> length <span class="bound">v''</span> <span class="main">&lt;</span> length <span class="free">v</span> <span class="main">∧</span> knft.computation <span class="free">s</span> <span class="main">(</span><span class="bound">u''</span><span class="main">,</span> <span class="bound">v''</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="free">s'</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span><span class="main">.</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span>
    safe_hd <span class="free">u</span> <span class="main">=</span> safe_hd <span class="bound">u''</span> <span class="main">∧</span> safe_hd <span class="main">(</span><span class="free">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="bound">v''</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="free">ws</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ws</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len_v<span class="main">:</span> <span class="quoted"><span class="quoted">"tcard <span class="main">(</span>length <span class="skolem">ws</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> length <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>1<span class="main">,</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> rem<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">v''</span> <span class="main">&lt;</span> length <span class="skolem">v</span>"</span></span>
    <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s</span> <span class="main">(</span><span class="skolem">u''</span><span class="main">,</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"safe_hd <span class="skolem">u</span> <span class="main">=</span> safe_hd <span class="skolem">u''</span>"</span></span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> one_loop<span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> comp 0<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> len_v<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> new_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>1<span class="main">)</span> rem<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> rem<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> new_comp rem<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> wss_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span> <span class="main">=</span> length <span class="skolem">ws</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">t</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">ts</span> <span class="skolem">ws</span><span class="main">)</span> <span class="main">⟹</span>
      flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span> <span class="main">∧</span> flip.computation <span class="bound">t</span> <span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">ts</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span>
        fδ <span class="bound">t</span> <span class="main">(</span>safe_hd <span class="bound">w</span><span class="main">,</span> safe_hd <span class="skolem">cs'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flip.split_outss<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ws</span></span><span class="main">,</span> <span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> Suc<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits prod.splits<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">bs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> knft_split<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s</span> <span class="main">(</span><span class="skolem">cs</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">s''</span>"</span></span>
    <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s''</span> <span class="main">(</span><span class="skolem">cs'</span><span class="main">,</span> <span class="skolem">bs'</span><span class="main">)</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">@</span> <span class="free">v'</span> <span class="main">=</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">bs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.computation_split<span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wss_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> v_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">bs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft_split<span class="main">(</span>3<span class="main">)</span> append_eq_conv_conj
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> v'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">bs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft_split<span class="main">(</span>3<span class="main">)</span> append_eq_conv_conj
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">vm</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vm</span> <span class="main">=</span> tcard <span class="main">(</span>length <span class="skolem">ws</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> vm_len_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vm</span> <span class="main">≤</span> length <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vm_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">≥</span> <span class="skolem">vm</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> take <span class="skolem">vm</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es'</span> <span class="main">=</span> drop <span class="skolem">vm</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">es''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es''</span> <span class="main">=</span> drop <span class="skolem">vm</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> bs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> es'_def es_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> v_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vm_len_v
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> v_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">≥</span> length <span class="skolem">v</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def es''_def True<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> drop_take le_add_diff_inverse take_add<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">ts</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> len_ws'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws'</span> <span class="main">=</span> length <span class="skolem">ws</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wss_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> comp_ws'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws'</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wss_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ws'_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws'_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_zip_rightD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> len_es<span class="main">:</span> <span class="quoted"><span class="quoted">"tcard <span class="main">(</span>length <span class="skolem">ws'</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> length <span class="skolem">es</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_ws' es_def vm_def<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> rem<span class="main">:</span>
      <span class="quoted"><span class="quoted">"length <span class="skolem">v''</span> <span class="main">&lt;</span> length <span class="skolem">es</span>"</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s</span> <span class="main">(</span><span class="skolem">u''</span><span class="main">,</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">es'</span><span class="main">)</span> <span class="skolem">s''</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws'</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
      <span class="quoted"><span class="quoted">"safe_hd <span class="skolem">cs</span> <span class="main">=</span> safe_hd <span class="skolem">u''</span>"</span></span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">es'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> one_loop<span class="main">[</span><span class="operator">OF</span> knft_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> bs_def<span class="main"><span class="main">]</span></span> Suc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> comp_ws' ws'_Q len_es<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">@</span> <span class="free">v'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es''</span><span class="main">)</span> <span class="main">@</span> <span class="free">v'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> v_def'
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> v''_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">es'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">es''</span><span class="main">)</span> <span class="main">@</span> <span class="free">v'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bs_def knft_split<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> F1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">es''</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rem<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> v_def'<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> F3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span> <span class="main">@</span> <span class="skolem">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">r</span> <span class="skolem">r'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> in_set_zip_ts_ws<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">ts</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wss_def<span class="main">(</span>2<span class="main">)</span> i_def<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> i_def<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> comp_old<span class="main">:</span> <span class="quoted"><span class="quoted">"flip.computation <span class="skolem">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"flip.computation <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wss_def<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> comp_new<span class="main">:</span> <span class="quoted"><span class="quoted">"flip.computation <span class="skolem">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rem<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> in_set_zip_ts_ws image_iff
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws'_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flip.computation <span class="skolem">r</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span> <span class="main">@</span> <span class="skolem">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> flip.comp_trans<span class="main">[</span><span class="operator">OF</span> comp_new comp_old<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> F4<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="skolem">u''</span> <span class="main">@</span> <span class="skolem">cs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rem<span class="main">(</span>4<span class="main">)</span> safe_hd_app
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> F5<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="main">(</span><span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs'</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">es'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rem<span class="main">(</span>5<span class="main">)</span> safe_hd_app
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">u''</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">cs'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">v''</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">es''</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> F1 knft.comp_trans<span class="main">[</span><span class="operator">OF</span> rem<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> knft_split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> F3 F4 F5
      <span class="keyword1"><span class="command">unfolding</span></span> v''_app<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> wss_def<span class="main">(</span>1<span class="main">)</span> knft_split<span class="main">(</span>3<span class="main">)</span> bs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> es_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">es</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_app<span class="main">[</span><span class="operator">OF</span> knft_split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> False Suc<span class="main">(</span>7<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vm_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> bs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="free">v'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> knft_split<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ts</span>"</span></span>
      <span class="quoted"><span class="quoted">"fδ <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>safe_hd <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> safe_hd <span class="skolem">cs'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wss_def<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> wsi_def<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> flip.move_left<span class="main">[</span><span class="operator">OF</span> i_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ts'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts'</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="skolem">ts</span> <span class="main">@</span> <span class="skolem">t'</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="main">(</span>map fst <span class="skolem">ws</span><span class="main">)</span> <span class="main">@</span> tl <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>map fst <span class="skolem">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> <span class="bound">r'</span><span class="main">)</span> <span class="skolem">ws</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">wss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wss'</span> <span class="main">=</span> zip <span class="skolem">ws'</span> <span class="main">(</span>zip <span class="skolem">ts'</span> <span class="skolem">rs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> len'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts'</span> <span class="main">=</span> length <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws'</span> <span class="main">=</span> length <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">rs'</span> <span class="main">=</span> length <span class="skolem">ts</span>"</span></span>
      <span class="quoted"><span class="quoted">"length <span class="skolem">wss'</span> <span class="main">=</span> length <span class="skolem">ws</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i_def<span class="main">(</span>1<span class="main">)</span> wss_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts'_def ws'_def rs'_def wss'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> map_fst_wss'<span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">wss'</span> <span class="main">=</span> <span class="skolem">ws'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> len'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wss'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>concat <span class="main">(</span>take <span class="skolem">i</span> <span class="main">(</span>map fst <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
      <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>concat <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>map fst <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i_def<span class="main">(</span>1<span class="main">)</span> wss_def<span class="main">(</span>2<span class="main">)</span>
        arg_cong<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> id_take_nth_drop<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">ws</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wsi_def take_map drop_map<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="skolem">wss'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_fst_wss' ws'_def wsi_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> comp_wss'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">wss'</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">r</span> <span class="skolem">r'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">wss'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">ws'</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">ts'</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="skolem">rs'</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> len'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wss'_def in_set_conv_nth<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flip.computation <span class="skolem">r</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⇒</span> flip.computation <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i_def<span class="main">(</span>1<span class="main">)</span> wss_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> i_def wss_def<span class="main">(</span>2<span class="main">)</span> wsi_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> j_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> True ts'_def ws'_def rs'_def nth_append safe_hd_def
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> flip.computation.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> fst <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">ts</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False i_def<span class="main">(</span>1<span class="main">)</span> wss_def<span class="main">(</span>2<span class="main">)</span> j_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws'_def ts'_def rs'_def nth_append min_def in_set_conv_nth
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> wss_def<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> len_es<span class="main">:</span> <span class="quoted"><span class="quoted">"tcard <span class="main">(</span>length <span class="skolem">wss'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="skolem">wss'</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> length <span class="skolem">es</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> es_def<span class="main">]</span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> l_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> len'<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> vm_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> s''_nQ <span class="main">=</span> knft.comp_closed<span class="main">[</span><span class="operator">OF</span> knft_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> wss'_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">wss'</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">wss'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">ts'</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> len'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wss'_def in_set_conv_nth<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> fst <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">ts</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i_def<span class="main">(</span>1<span class="main">)</span> wss_def<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flip.computation <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> fst <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wss_def<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flip.comp_closed<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>6<span class="main">)</span> i_def<span class="main">(</span>1<span class="main">)</span> wss_def<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> flip.closed<span class="main">[</span><span class="operator">OF</span> _ i_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> i_def<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> j_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> True ts'_def nth_append min_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> fst <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">ts</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j_def<span class="main">(</span>1<span class="main">)</span> wss_def<span class="main">(</span>2<span class="main">)</span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth j_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ts'_def nth_append min_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flip.computation <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> fst <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wss_def<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flip.comp_closed<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>6<span class="main">)</span> j_def<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">v''</span> <span class="main">&lt;</span> length <span class="skolem">es</span>"</span></span>
      <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s''</span> <span class="main">(</span><span class="skolem">u''</span><span class="main">,</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">wss'</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
      <span class="quoted"><span class="quoted">"safe_hd <span class="skolem">cs'</span> <span class="main">=</span> safe_hd <span class="skolem">u''</span>"</span></span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="skolem">es</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> l_def knft_split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> bs'_def<span class="main"><span class="main">]</span></span> s''_nQ comp_wss' wss'_Q len_es<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> flip_comp_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws</span> <span class="main">⟹</span>
      flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">r</span> <span class="skolem">r'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> comp_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"flip.computation <span class="skolem">r</span> <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjunct1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wss_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> j_def wss_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flip.computation <span class="skolem">r</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> w_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j_def<span class="main">(</span>2<span class="main">)</span> wsi_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">wss'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i_def<span class="main">(</span>1<span class="main">)</span> wss_def<span class="main">(</span>2<span class="main">)</span> j_def<span class="main">(</span>2<span class="main">)</span> len' wsi_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth True wss'_def ws'_def ts'_def rs'_def nth_append min_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> comp_snd'<span class="main">:</span> <span class="quoted"><span class="quoted">"flip.computation <span class="skolem">t'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ind<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> comp_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"flip.computation <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> w_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flip.step_TF<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ comp_snd'<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> i_def<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wsi_def ind<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> safe_hd_Cons<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> flip.comp_trans<span class="main">[</span><span class="operator">OF</span> comp_fst<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> True<span class="main"><span class="main">]</span></span> comp_snd<span class="main">]</span> ind<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">wss'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i_def<span class="main">(</span>1<span class="main">)</span> wss_def<span class="main">(</span>2<span class="main">)</span> j_def len' False
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth wss'_def ws'_def ts'_def rs'_def nth_append min_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> comp_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"flip.computation <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ind<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> flip.comp_trans<span class="main">[</span><span class="operator">OF</span> comp_fst comp_snd<span class="main">]</span> ind<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">cs</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">u''</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">bs</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">v''</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ind<span class="main">(</span>1<span class="main">)</span> knft.comp_trans<span class="main">[</span><span class="operator">OF</span> knft_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ind<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> flip_comp_trans ind<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def wss_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> safe_hd_app'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> one_conflict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">s</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">nQ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span> <span class="main">⟹</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="free">ws</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">v</span> <span class="main">≥</span> tcard <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u''</span> <span class="bound">v''</span><span class="main">.</span> length <span class="bound">v''</span> <span class="main">&lt;</span> length <span class="free">v</span> <span class="main">∧</span>
    length <span class="free">v</span> <span class="main">-</span> <span class="main">(</span>tcard <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> length <span class="bound">v''</span> <span class="main">∧</span>
    knft.computation <span class="free">s</span> <span class="main">(</span><span class="bound">u''</span><span class="main">,</span> <span class="bound">v''</span><span class="main">)</span> <span class="free">s'</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span><span class="main">.</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span>
    safe_hd <span class="free">u</span> <span class="main">=</span> safe_hd <span class="bound">u''</span> <span class="main">∧</span> safe_hd <span class="free">v</span> <span class="main">=</span> safe_hd <span class="bound">v''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> tcard <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> knft_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">s</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> take <span class="skolem">l</span> <span class="free">v</span> <span class="main">@</span> drop <span class="skolem">l</span> <span class="free">v</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len_take<span class="main">:</span> <span class="quoted"><span class="quoted">"tcard <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> length <span class="main">(</span>take <span class="skolem">l</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">v''</span> <span class="main">&lt;</span> length <span class="main">(</span>take <span class="skolem">l</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"knft.computation <span class="free">s</span> <span class="main">(</span><span class="skolem">u''</span><span class="main">,</span> <span class="skolem">v''</span> <span class="main">@</span> drop <span class="skolem">l</span> <span class="free">v</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">∈</span>set <span class="free">ws</span><span class="main">.</span> flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"safe_hd <span class="free">u</span> <span class="main">=</span> safe_hd <span class="skolem">u''</span>"</span></span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span>take <span class="skolem">l</span> <span class="free">v</span> <span class="main">@</span> drop <span class="skolem">l</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> drop <span class="skolem">l</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> one_conflict_aux<span class="main">[</span><span class="operator">OF</span> knft_comp assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> len_take<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u''</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">v''</span></span> <span class="main"><span class="main">@</span></span> drop <span class="skolem"><span class="skolem">l</span></span> <span class="free"><span class="free">v</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> aux
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">minv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minv</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span>knft.sg <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">Q</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>knft.sg <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> knft.output_speed"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minv</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> tcard <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>sum_list <span class="main">(</span>map <span class="free">minv</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> knft.output_speed<span class="main">)</span> <span class="main">*</span>
    Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> knft.output_speed <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> minv.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sminv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sminv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> sum_list <span class="main">(</span>map minv <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sminv_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"sminv <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> sminv <span class="free">n</span> <span class="main">+</span> minv <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sminv_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sminv_ge_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"minv <span class="main">0</span> <span class="main">≤</span> sminv <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sminv_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tcard_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"tcard <span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> knft.output_speed_pos
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tcard_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sminv_Suc_ge_os<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.output_speed <span class="main">≤</span> sminv <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sminv_Suc minv.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> minv_Suc_ge_sminv_os<span class="main">:</span> <span class="quoted"><span class="quoted">"sminv <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> knft.output_speed <span class="main">≤</span> minv <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map minv <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> minv <span class="free">n</span> <span class="main">+</span> knft.output_speed <span class="main">≤</span>
    tcard <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>sum_list <span class="main">(</span>map minv <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> minv <span class="free">n</span> <span class="main">+</span> knft.output_speed<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tcard_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> tcard <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>sum_list <span class="main">(</span>map minv <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> minv <span class="free">n</span> <span class="main">+</span> knft.output_speed <span class="main">+</span>
    <span class="main">(</span>sum_list <span class="main">(</span>map minv <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> minv <span class="free">n</span> <span class="main">+</span> knft.output_speed<span class="main">)</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minv.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sminv_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_concat_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">ws</span><span class="main">.</span> <span class="bound">ws</span> <span class="main">∈</span> set <span class="free">wss</span> <span class="main">⟹</span> length <span class="bound">ws</span> <span class="main">≤</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> length <span class="main">(</span>concat <span class="free">wss</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">*</span> length <span class="free">wss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">wss</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trans_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">P'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="bound">xs'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="bound">xs'</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x'</span> <span class="main">∈</span> set <span class="bound">xs'</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="skolem">x'</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">xs</span> <span class="skolem">xs'</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x'</span> <span class="main">∈</span> set <span class="skolem">xs'</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">x'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs'</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_cong'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">xs'</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">⟹</span> map <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> map <span class="free">f'</span> <span class="free">xs'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">xs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span> <span class="main">⟹</span> distinct <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conflict_rec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">ninit</span> <span class="main">(</span><span class="free">u0</span><span class="main">,</span> <span class="free">v0</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">s</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">naccept</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u0</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v0</span> <span class="main">@</span> <span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="free">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">v'</span> <span class="main">≤</span> minv <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"sminv <span class="free">n</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="main">≤</span> sminv <span class="free">n</span> <span class="main">+</span> knft.output_speed"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u''</span> <span class="bound">v''</span> <span class="bound">ws</span><span class="main">.</span> safe_hd <span class="free">u</span> <span class="main">=</span> safe_hd <span class="bound">u''</span> <span class="main">∧</span> length <span class="bound">ws</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span>
    knft.computation <span class="free">s</span> <span class="main">(</span><span class="bound">u''</span><span class="main">,</span> <span class="bound">v''</span><span class="main">)</span> <span class="free">s'</span> <span class="main">∧</span>
    length <span class="bound">v''</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="main">∧</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span><span class="main">)</span> <span class="bound">ws</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">ws</span><span class="main">.</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u0</span><span class="main">,</span> <span class="bound">u''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v0</span> <span class="main">@</span> <span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span> <span class="main">∧</span>
      <span class="bound">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">cw</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">r'</span> <span class="main">∧</span>
      length <span class="bound">v''</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">,</span>7<span class="main">,</span>8<span class="main">,</span>9<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u0</span></span> <span class="quoted"><span class="free">v0</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">v</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">v'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sminv_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_v'_le_sminv<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">v'</span> <span class="main">≤</span> sminv <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>6<span class="main">)</span> sminv_ge_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">v'</span> <span class="main">≤</span> minv <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>6<span class="main">)</span> sminv_ge_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> minv_Suc_ge_sminv_os<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_v_ge_sminv<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">v</span> <span class="main">≥</span> sminv <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>7<span class="main">)</span> minv_Suc_ge_sminv_os<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sminv_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">v</span> <span class="main">≥</span> sminv <span class="skolem">n</span> <span class="main">-</span> length <span class="skolem">v'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> es_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">es'</span> <span class="main">=</span> sminv <span class="skolem">n</span> <span class="main">-</span> length <span class="skolem">v'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_long
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> len_es_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">=</span> length <span class="skolem">v</span> <span class="main">-</span> sminv <span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">v'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_v_ge_sminv len_v'_le_sminv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≥</span> minv <span class="main">(</span><span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sminv_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> len_es_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"minv <span class="main">(</span><span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">es</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> len_es_le<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">≤</span> minv <span class="main">(</span><span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> knft.output_speed"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>8<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> es_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sminv_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> knft_es<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> s_nQ <span class="main">=</span> knft.comp_closed<span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> knft.init_in_Q<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">as'</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> knft_split<span class="main">:</span>
    <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s</span> <span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">s''</span>"</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s''</span> <span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">as'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="skolem">v'</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs</span> <span class="main">≤</span> length <span class="skolem">es</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">-</span> length <span class="skolem">cs</span> <span class="main">≤</span> knft.output_speed"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.computation_split_out<span class="main">[</span><span class="operator">OF</span> knft_es s_nQ<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> s''_nQ <span class="main">=</span> knft.comp_closed<span class="main">[</span><span class="operator">OF</span> knft_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s_nQ<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> es_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">fs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="skolem">fs'</span> <span class="main">@</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="skolem">v'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft_split<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_append_conv_if append_eq_conv_conj<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">fs'</span> <span class="main">≤</span> knft.output_speed"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft_split<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r''</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="skolem"><span class="skolem">ds'</span></span> <span class="keyword2"><span class="keyword">where</span></span> tdfa_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">ds'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">as'</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ds</span><span class="main">,</span> <span class="skolem">ds'</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span><span class="skolem">r''</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">r''</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="free">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_split<span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> knft_split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> knft_fst <span class="main">=</span> knft.comp_trans<span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> knft_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> knft_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s''</span> <span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="main">(</span><span class="skolem">fs'</span> <span class="main">@</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="skolem">ds</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ds'</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft_split<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tdfa_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tdfa_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u0</span> <span class="main">@</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">fs'</span> <span class="main">@</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="skolem">ds</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span><span class="skolem">r''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> tdfa_split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> knft_split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tdfa_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> es_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> es_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sminv_le<span class="main">:</span> <span class="quoted"><span class="quoted">"sminv <span class="skolem">n</span> <span class="main">≤</span> length <span class="main">(</span><span class="main">(</span><span class="skolem">fs'</span> <span class="main">@</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="skolem">ds</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ds'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>7<span class="main">)</span> es_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tdfa_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sminv_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sminv_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="main">(</span><span class="skolem">fs'</span> <span class="main">@</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="skolem">ds</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ds'</span><span class="main">)</span> <span class="main">≤</span> sminv <span class="skolem">n</span> <span class="main">+</span> knft.output_speed"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_v'_le_sminv len_fs'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tdfa_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_ds'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ds'</span> <span class="main">≤</span> minv <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tdfa_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="skolem">as'</span> <span class="main">=</span> safe_hd <span class="skolem">u''</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s''</span> <span class="main">(</span><span class="skolem">u''</span><span class="main">,</span> <span class="skolem">v''</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">v''</span> <span class="main">≤</span> length <span class="main">(</span><span class="main">(</span><span class="skolem">fs'</span> <span class="main">@</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="skolem">ds</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ds'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cv</span> <span class="bound">cw</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws</span> <span class="main">⟹</span> <span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u0</span> <span class="main">@</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">@</span> <span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">)</span><span class="bound">r</span> <span class="main">∧</span>
      <span class="bound">r</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="bound">r'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">r'</span> <span class="main">∧</span> length <span class="skolem">v''</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span> <span class="main">∧</span>
      length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="main">(</span><span class="skolem">fs'</span> <span class="main">@</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="skolem">ds</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ds'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> knft_fst knft_snd tdfa_fst tdfa_split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> len_ds' sminv_le sminv_ge<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> safe_hd_u''_as<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe_hd_app'<span class="main">[</span><span class="operator">OF</span> rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> knft_split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">=</span> length <span class="skolem">ws'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="skolem">ws</span> <span class="skolem">ws'</span><span class="main">)</span><span class="main">.</span>
    <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">case</span> <span class="bound">x'</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">cv'</span><span class="main">,</span> <span class="bound">cw'</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span> <span class="main">=</span> <span class="bound">cv'</span> <span class="main">@</span> <span class="bound">cw'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x'</span> <span class="main">∈</span> set <span class="skolem">ws'</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x'</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">cv'</span><span class="main">,</span> <span class="bound">cw'</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u0</span><span class="main">,</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v0</span> <span class="main">@</span> <span class="bound">cv'</span><span class="main">,</span> <span class="bound">cw'</span><span class="main">)</span><span class="bound">s</span> <span class="main">∧</span>
      <span class="bound">s</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="bound">cw'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="bound">s'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">s'</span> <span class="main">∧</span> length <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">v''</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="bound">cv'</span> <span class="main">@</span> <span class="bound">cw'</span><span class="main">)</span> <span class="main">∧</span>
      length <span class="main">(</span><span class="bound">cv'</span> <span class="main">@</span> <span class="bound">cw'</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">cw'</span> <span class="main">≤</span> sminv <span class="skolem">n</span> <span class="main">+</span> knft.output_speed"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> trans_list<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x_in_ws<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">ws</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cv</span></span> <span class="skolem"><span class="skolem">cw</span></span> <span class="skolem"><span class="skolem">cr</span></span> <span class="skolem"><span class="skolem">cr'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">cv</span><span class="main">,</span> <span class="skolem">cw</span><span class="main">,</span> <span class="skolem">cr</span><span class="main">,</span> <span class="skolem">cr'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> comp_cr_cr'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cr</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cw</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="skolem">cr'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rec<span class="main">(</span>6<span class="main">)</span> x_in_ws
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> rec_props <span class="main">=</span> rec<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x_in_ws<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> x_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nv</span></span> <span class="skolem"><span class="skolem">nw</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> ns_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cv</span> <span class="main">=</span> <span class="skolem">nv</span> <span class="main">@</span> <span class="skolem">nw</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u0</span><span class="main">,</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">nv</span><span class="main">,</span> <span class="skolem">nw</span> <span class="main">@</span> <span class="skolem">cw</span><span class="main">)</span><span class="skolem">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">nw</span><span class="main">,</span> <span class="skolem">cw</span><span class="main">)</span><span class="skolem">cr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> det_comp_safe<span class="main">[</span><span class="operator">OF</span> conjunct1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rec_props<span class="main"><span class="main">]</span></span> _ safe_hd_u''_as<span class="main">]</span>
        Suc<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def es_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> len_cv_cw<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">nv</span> <span class="main">+</span> length <span class="skolem">nw</span> <span class="main">+</span> length <span class="skolem">cw</span> <span class="main">≤</span> length <span class="main">(</span><span class="main">(</span><span class="skolem">fs'</span> <span class="main">@</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="skolem">ds</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ds'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rec_props
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> len_v_v'_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs</span> <span class="main">+</span> length <span class="skolem">nv</span> <span class="main">+</span> <span class="main">(</span>length <span class="skolem">nw</span> <span class="main">+</span> length <span class="skolem">cw</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">v</span> <span class="main">+</span> length <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> len_cv_cw
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tdfa_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> es_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> comp_init_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u0</span><span class="main">,</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v0</span> <span class="main">@</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">nv</span><span class="main">,</span> <span class="skolem">nw</span> <span class="main">@</span> <span class="skolem">cw</span><span class="main">)</span><span class="skolem">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ns_def<span class="main">(</span>2<span class="main">)</span> safe_hd_app'<span class="main">[</span><span class="operator">OF</span> rec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> comp_swap_same_hd
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> comp_ns_cr'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">nw</span> <span class="main">@</span> <span class="skolem">cw</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="skolem">cr'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> ns_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> comp_cr_cr'<span class="main">]</span> rec<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">case</span> <span class="bound">x'</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">cv'</span><span class="main">,</span> <span class="bound">cw'</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="skolem">cs</span> <span class="main">@</span> <span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span> <span class="main">=</span> <span class="bound">cv'</span> <span class="main">@</span> <span class="bound">cw'</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x'</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">cv'</span><span class="main">,</span> <span class="bound">cw'</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u0</span><span class="main">,</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v0</span> <span class="main">@</span> <span class="bound">cv'</span><span class="main">,</span> <span class="bound">cw'</span><span class="main">)</span><span class="bound">s</span> <span class="main">∧</span>
        <span class="bound">s</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="bound">cw'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="bound">s'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">s'</span> <span class="main">∧</span> length <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">v''</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="bound">cv'</span> <span class="main">@</span> <span class="bound">cw'</span><span class="main">)</span> <span class="main">∧</span>
        length <span class="main">(</span><span class="bound">cv'</span> <span class="main">@</span> <span class="bound">cw'</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">cw'</span> <span class="main">≤</span> sminv <span class="skolem">n</span> <span class="main">+</span> knft.output_speed<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">cs</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">nv</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">nw</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">cw</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">ns</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">cr'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ns_def rec_props knft_split<span class="main">(</span>5<span class="main">)</span> comp_init_ns comp_ns_cr' len_v_v'_ge sminv_ge
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> set_ws'_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cv'</span> <span class="bound">cw'</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="bound">cv'</span><span class="main">,</span> <span class="bound">cw'</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws'</span> <span class="main">⟹</span>
    <span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u0</span><span class="main">,</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v0</span> <span class="main">@</span> <span class="bound">cv'</span><span class="main">,</span> <span class="bound">cw'</span><span class="main">)</span><span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="bound">cw'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="bound">s'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">s'</span> <span class="main">∧</span>
    length <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">v''</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="bound">cv'</span> <span class="main">@</span> <span class="bound">cw'</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span><span class="bound">cv'</span> <span class="main">@</span> <span class="bound">cw'</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∧</span>
    length <span class="bound">cw'</span> <span class="main">≤</span> sminv <span class="skolem">n</span> <span class="main">+</span> knft.output_speed"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ws'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u0</span> <span class="main">@</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="skolem">v0</span> <span class="main">@</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">v''</span><span class="main">)</span> <span class="main">∈</span> τ"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.comp_trans<span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> knft.comp_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> knft_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rec<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> knft.τ_def equiv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nr'</span></span> <span class="keyword2"><span class="keyword">where</span></span> new_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u0</span> <span class="main">@</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="skolem">v0</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nr'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="skolem">nr'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> τ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> safe_hd_u_as<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="skolem">u</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe_hd_app' rec<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> knft_split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nw</span></span> <span class="skolem"><span class="skolem">nw'</span></span> <span class="skolem"><span class="skolem">nr</span></span> <span class="keyword2"><span class="keyword">where</span></span> nr_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">=</span> <span class="skolem">nw</span> <span class="main">@</span> <span class="skolem">nw'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u0</span><span class="main">,</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">nw</span><span class="main">,</span> <span class="skolem">nw'</span><span class="main">)</span><span class="skolem">nr</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">nr</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">nw'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="skolem">nr'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command">using</span></span> det_comp_safe<span class="main">[</span><span class="operator">OF</span> new_comp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Suc<span class="main">(</span>4<span class="main">)</span> safe_hd_u_as
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> es_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_nw'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">nw'</span> <span class="main">≤</span> sminv <span class="skolem">n</span> <span class="main">+</span> knft.output_speed"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec<span class="main">(</span>4<span class="main">)</span> sminv_ge
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nr_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nws</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nws</span> <span class="main">=</span> <span class="skolem">ws'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">nw</span><span class="main">,</span> <span class="skolem">nw'</span><span class="main">,</span> <span class="skolem">nr</span><span class="main">,</span> <span class="skolem">nr'</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> len_nws<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">nws</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nws_def ws'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> flip_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cw</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="skolem">nws</span><span class="main">)</span> <span class="main">⟹</span>
    flip.computation <span class="bound">r</span> <span class="main">(</span><span class="main">(</span><span class="bound">cw</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nr_def<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flip_comp_eq nws_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_ws'_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tdfa_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">nws</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_closed<span class="main">[</span><span class="operator">OF</span> _ init_in_Q<span class="main">]</span> nr_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nws_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_ws'_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_ws_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">=</span> length <span class="main">(</span>map fst <span class="main">(</span>map snd <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> comp_s_s' <span class="main">=</span> knft.comp_trans<span class="main">[</span><span class="operator">OF</span> knft_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rec<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> length_nws_ws<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">nws</span> <span class="main">=</span> length <span class="main">(</span>map fst <span class="main">(</span>map snd <span class="skolem">nws</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len_concat_sminv<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="main">(</span>map snd <span class="skolem">nws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
    <span class="main">(</span>sminv <span class="skolem">n</span> <span class="main">+</span> knft.output_speed<span class="main">)</span> <span class="main">*</span> length <span class="skolem">nws</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> length_nws_ws<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> length_concat_le<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> len_nw'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nws_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_ws'_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_cs_v''<span class="main">:</span> <span class="quoted"><span class="quoted">"tcard <span class="main">(</span>length <span class="main">(</span>map snd <span class="skolem">nws</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
    <span class="main">(</span>length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="main">(</span>map snd <span class="skolem">nws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">v''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tcard <span class="main">(</span>length <span class="main">(</span>map snd <span class="skolem">nws</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="main">(</span>map snd <span class="skolem">nws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span>
      tcard <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>sminv <span class="skolem">n</span> <span class="main">+</span> knft.output_speed<span class="main">)</span> <span class="main">*</span> length <span class="skolem">nws</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> len_concat_sminv
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_nws<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> minv <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> knft.output_speed"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sminv_Suc minv.simps sminv_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> len_nws
      <span class="keyword1"><span class="command">using</span></span> knft.output_speed_pos
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> knft_split<span class="main">(</span>6<span class="main">)</span> len_es_ge
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="skolem"><span class="skolem">v'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> conflict<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">v'''</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">v''</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">v''</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>tcard <span class="main">(</span>length <span class="main">(</span>map snd <span class="skolem">nws</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
      <span class="main">(</span>length <span class="main">(</span>concat <span class="main">(</span>map fst <span class="main">(</span>map snd <span class="skolem">nws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>  <span class="main">≤</span> length <span class="skolem">v'''</span>"</span></span>
    <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s</span> <span class="main">(</span><span class="skolem">u'''</span><span class="main">,</span> <span class="skolem">v'''</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>map snd <span class="skolem">nws</span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u'''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="skolem">u'''</span>"</span></span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">v''</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="skolem">v'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> one_conflict<span class="main">[</span><span class="operator">OF</span> comp_s_s' s_nQ flip_comp tdfa_closed len_cs_v''<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flip_comp_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> safe_hd_u_u'''<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="skolem">u</span> <span class="main">=</span> safe_hd <span class="skolem">u'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe_hd_u_as conflict<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nr_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u0</span><span class="main">,</span> <span class="skolem">u'''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">nw</span><span class="main">,</span> <span class="skolem">nw'</span><span class="main">)</span><span class="skolem">nr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nr_def<span class="main">(</span>2<span class="main">)</span> comp_swap_same_hd<span class="main">[</span><span class="operator">OF</span> _ conflict<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> refl<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> len_cs_v''_le<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">v''</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft_split<span class="main">(</span>4<span class="main">)</span> rec<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> es_split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tdfa_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_v'''_le<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">v'''</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conflict<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> M1<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ws</span> <span class="main">=</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> length <span class="skolem">cs</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> M2<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ws</span> <span class="main">=</span>
    map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ws'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> map_cong'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ws'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ws'_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⇒</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ws'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> M1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinct_inj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ rec<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> distinct_nws<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⇒</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span><span class="main">)</span> <span class="skolem">nws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nws_def nr_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_ws'_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nws_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="skolem">nws</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u0</span><span class="main">,</span> <span class="skolem">u'''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v0</span> <span class="main">@</span> <span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">)</span><span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u'''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="bound">r'</span> <span class="main">∧</span>
    <span class="free">accept</span> <span class="bound">r'</span> <span class="main">∧</span> length <span class="skolem">v'''</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nr_swap new_comp<span class="main">(</span>2<span class="main">)</span> conflict<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> len_cs_v''_le comp_swap_same_hd<span class="main">[</span><span class="operator">OF</span> _ conflict<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> refl<span class="main">]</span>
      set_ws'_dest
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nws_def nr_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">u'''</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">v'''</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">nws</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> safe_hd_u_u''' len_nws conflict<span class="main">(</span>3<span class="main">)</span> len_v'''_le distinct_nws nws_props
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conflict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">ninit</span> <span class="main">(</span><span class="free">u0</span><span class="main">,</span> <span class="free">v0</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">s</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">naccept</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u0</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v0</span> <span class="main">@</span> <span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="free">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">v'</span> <span class="main">≤</span> minv <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"sminv <span class="free">n</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u''</span> <span class="bound">v''</span> <span class="bound">ws</span><span class="main">.</span> length <span class="bound">ws</span> <span class="main">=</span> Suc <span class="free">n</span> <span class="main">∧</span> distinct <span class="bound">ws</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">cw</span> <span class="main">∈</span> set <span class="bound">ws</span><span class="main">.</span> <span class="main">(</span><span class="free">u0</span> <span class="main">@</span> <span class="bound">u''</span><span class="main">,</span> <span class="free">v0</span> <span class="main">@</span> <span class="bound">v''</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> es_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">@</span> <span class="free">v'</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">es'</span> <span class="main">=</span> sminv <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_long assms<span class="main">(</span>8<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> s_nQ <span class="main">=</span> knft.comp_closed<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> knft.init_in_Q<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">as'</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> knft_split<span class="main">:</span>
    <span class="quoted"><span class="quoted">"knft.computation <span class="free">s</span> <span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">s''</span>"</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s''</span> <span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">as'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs</span> <span class="main">≤</span> length <span class="skolem">es</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">-</span> length <span class="skolem">cs</span> <span class="main">≤</span> knft.output_speed"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.computation_split_out<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> es_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> s_nQ<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r''</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="skolem"><span class="skolem">fs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> tdfa_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">=</span> <span class="skolem">fs</span> <span class="main">@</span> <span class="skolem">fs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">fs</span><span class="main">,</span> <span class="skolem">fs'</span><span class="main">)</span><span class="skolem">r''</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">r''</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">fs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="free">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_split<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> knft_split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">v'</span> <span class="main">≤</span> length <span class="skolem">es'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">)</span> sminv_ge_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> minv_Suc_ge_sminv_os<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> es_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sminv_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs</span> <span class="main">≤</span> length <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> es_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">length</span><span class="main">]</span> knft_split<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> cs'_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="skolem">cs''</span> <span class="main">@</span> <span class="free">v'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_app'<span class="main">[</span><span class="operator">OF</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> es_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> knft_split<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> v_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trans<span class="main">[</span><span class="operator">OF</span> es_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> knft_split<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cs'_split<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> comp_init_r''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u0</span> <span class="main">@</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v0</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">cs''</span> <span class="main">@</span> <span class="skolem">fs</span><span class="main">,</span> <span class="skolem">fs'</span><span class="main">)</span><span class="skolem">r''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> tdfa_split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> knft_split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tdfa_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> v_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> knft_comp_s''_s'<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s''</span> <span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="main">(</span><span class="skolem">cs''</span> <span class="main">@</span> <span class="skolem">fs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">fs'</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft_split<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cs'_split tdfa_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> knft_comps <span class="main">=</span> knft.comp_trans<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> knft_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> len_fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">fs'</span> <span class="main">≤</span> minv <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tdfa_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sminv_le<span class="main">:</span> <span class="quoted"><span class="quoted">"sminv <span class="free">n</span> <span class="main">≤</span> length <span class="main">(</span><span class="main">(</span><span class="skolem">cs''</span> <span class="main">@</span> <span class="skolem">fs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">fs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sminv <span class="free">n</span> <span class="main">=</span> length <span class="skolem">es'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> es_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="skolem">cs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> knft_split<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">length</span><span class="main">]</span> knft_split<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">(</span><span class="main">(</span><span class="skolem">cs''</span> <span class="main">@</span> <span class="skolem">fs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">fs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cs'_split tdfa_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> sminv_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="main">(</span><span class="skolem">cs''</span> <span class="main">@</span> <span class="skolem">fs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">fs'</span><span class="main">)</span> <span class="main">≤</span> sminv <span class="free">n</span> <span class="main">+</span> knft.output_speed"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="main">(</span><span class="skolem">cs''</span> <span class="main">@</span> <span class="skolem">fs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">fs'</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">cs'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cs'_split tdfa_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sminv <span class="free">n</span> <span class="main">+</span> knft.output_speed"</span></span>
      <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> knft_split<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">length</span><span class="main">]</span> knft_split<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> sminv_Suc_ge_os<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> es_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> conflict<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">s''</span> <span class="main">(</span><span class="skolem">u''</span><span class="main">,</span> <span class="skolem">v''</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">v''</span> <span class="main">≤</span> length <span class="main">(</span><span class="main">(</span><span class="skolem">cs''</span> <span class="main">@</span> <span class="skolem">fs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">fs'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">ws</span><span class="main">.</span>
       <span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u0</span> <span class="main">@</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">u''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v0</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">@</span> <span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">)</span><span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="bound">r'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">r'</span> <span class="main">∧</span>
       length <span class="skolem">v''</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conflict_rec<span class="main">[</span><span class="operator">OF</span> knft_comps knft_comp_s''_s' assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> comp_init_r'' tdfa_split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span>
      len_fs' sminv_le sminv_ge<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ws</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ws'_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cw</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">cw</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ws'</span> <span class="main">⟹</span>
    <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u0</span> <span class="main">@</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="free">v0</span> <span class="main">@</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">r'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">r'</span> <span class="main">∧</span> length <span class="skolem">v''</span> <span class="main">&lt;</span> length <span class="bound">cw</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conflict<span class="main">(</span>5<span class="main">)</span> comp_trans
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> map_ws_ws'<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">cv</span><span class="main">,</span> <span class="bound">cw</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span><span class="bound">cv</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ws</span> <span class="main">=</span> map <span class="main">(</span>length <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">ws'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws'_def in_set_zip<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">ws'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conflict<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_ws_ws'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ws'</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> distinct_v''_ws'<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">v''</span> <span class="main">#</span> map fst <span class="skolem">ws'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ws'_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_ws'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws'</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conflict<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ws'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> new_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u0</span> <span class="main">@</span> <span class="skolem">as</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="free">v0</span> <span class="main">@</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">v''</span><span class="main">)</span> <span class="main">∈</span> τ"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.comp_trans<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> knft.comp_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> knft_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> conflict<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> knft.τ_def equiv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">as</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">u''</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">cs</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">v''</span></span> <span class="main"><span class="main">#</span></span> map fst <span class="skolem"><span class="skolem">ws'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> len_ws' distinct_v''_ws' ws'_comp new_pair
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> τ_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">K</span><span class="main">.</span> knft.bounded <span class="bound">K</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="comment1">(* home stretch *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span>knft.sg <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">Q</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="comment1">(* trail length *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> sminv <span class="free">kv</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">K</span><span class="main">.</span> knft.bounded <span class="bound">K</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> unbounded<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">ninit</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"knft.active <span class="skolem">q</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">ninit</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">q'</span>"</span></span> <span class="quoted"><span class="quoted">"knft.active <span class="skolem">q'</span> <span class="skolem">w</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">&gt;</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> knft.bounded_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> less_or_eq_imp_le neqE<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> q_nQ <span class="main">=</span> knft.comp_closed<span class="main">[</span><span class="operator">OF</span> unbounded<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> knft.init_in_Q<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> q'_nQ <span class="main">=</span> knft.comp_closed<span class="main">[</span><span class="operator">OF</span> unbounded<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> knft.init_in_Q<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="skolem"><span class="skolem">v1</span></span> <span class="skolem"><span class="skolem">nqf</span></span> <span class="keyword2"><span class="keyword">where</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u1</span><span class="main">,</span> <span class="skolem">v1</span><span class="main">)</span> <span class="skolem">nqf</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">naccept</span> <span class="skolem">nqf</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">u1</span> <span class="main">≤</span> knft.sg"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">v1</span> <span class="main">≤</span> knft.sg <span class="main">*</span> knft.output_speed"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.active_Nil_dest_sg<span class="main">[</span><span class="operator">OF</span> unbounded<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> q_nQ<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u2</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="skolem"><span class="skolem">nqf'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ext'<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">q'</span> <span class="main">(</span><span class="skolem">u2</span><span class="main">,</span> <span class="skolem">w</span> <span class="main">@</span> <span class="skolem">v2</span><span class="main">)</span> <span class="skolem">nqf'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">naccept</span> <span class="skolem">nqf'</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">v2</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> knft.sg<span class="main">)</span> <span class="main">*</span> knft.output_speed"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.active_dest<span class="main">[</span><span class="operator">OF</span> unbounded<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> q'_nQ<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> length <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unbounded<span class="main">(</span>5<span class="main">)</span> sminv_ge_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">kv</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def t_def minv.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> w_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">@</span> <span class="skolem">v''</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">v''</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_long<span class="main">[</span><span class="operator">OF</span> len_w<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">ninit</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u1</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v1</span><span class="main">)</span> <span class="skolem">nqf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.comp_trans<span class="main">[</span><span class="operator">OF</span> unbounded<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ext<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> w_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qf</span></span> <span class="keyword2"><span class="keyword">where</span></span> qf_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u1</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v1</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qf</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="skolem">qf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ext<span class="main">(</span>2<span class="main">)</span> equiv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> knft.τ_def τ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"knft.computation <span class="free">ninit</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u2</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v2</span><span class="main">)</span> <span class="skolem">nqf'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.comp_trans<span class="main">[</span><span class="operator">OF</span> unbounded<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ext'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> w_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qf'</span></span> <span class="keyword2"><span class="keyword">where</span></span> qf'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u2</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v2</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qf'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="skolem">qf'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ext'<span class="main">(</span>2<span class="main">)</span> equiv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> knft.τ_def τ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> u_not_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> knft.output_speed_computation<span class="main">[</span><span class="operator">OF</span> unbounded<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> knft.init_in_Q<span class="main">]</span>
      unbounded<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> t_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> v''_not_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> w_def<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> h_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> safe_hd_v''<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe_hd_app''<span class="main">[</span><span class="operator">OF</span> v''_not_Nil<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> safe_hd_u1_u2<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u1</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe_hd_app''<span class="main">[</span><span class="operator">OF</span> u_not_Nil<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> u_Nil_contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u_not_Nil<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">using</span></span> first_reaches<span class="main">[</span><span class="operator">OF</span> qf_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">OF</span> u_Nil_contr<span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws</span> <span class="bound">ws'</span> <span class="bound">q''</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span> <span class="main">=</span> <span class="bound">ws</span> <span class="main">@</span> <span class="bound">ws'</span> <span class="main">∧</span> <span class="bound">ws'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="bound">ws</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">q''</span> <span class="main">∧</span>
      <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u1</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v1</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">qf</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="keyword2"><span class="keyword">where</span></span> tail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span> <span class="main">=</span> <span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">ws'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ws</span><span class="main">,</span> <span class="skolem">ws'</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u1</span> <span class="main">@</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ws'</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">@</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">qf</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">(</span><span class="skolem">u1</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> card <span class="free">Q</span> <span class="main">≤</span> <span class="main">(</span>knft.sg <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> card <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ext<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le_trans<span class="main">[</span><span class="operator">OF</span> lin_bounded<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tail<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> qf_def<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> le<span class="main">]</span> w_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> h_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws</span> <span class="bound">ws'</span> <span class="bound">q''</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">=</span> <span class="bound">ws</span> <span class="main">@</span> <span class="bound">ws'</span> <span class="main">∧</span> <span class="bound">ws'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span><span class="bound">q''</span> <span class="main">∧</span>
      <span class="bound">q''</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">ws'</span> <span class="main">@</span> <span class="skolem">u1</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v1</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="skolem">qf</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="keyword2"><span class="keyword">where</span></span> tail'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">ws'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">ws</span><span class="main">,</span> <span class="skolem">ws'</span> <span class="main">@</span> <span class="skolem">u1</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">ws'</span> <span class="main">@</span> <span class="skolem">u1</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v1</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">qf</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> u2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u2</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">#</span> <span class="skolem">fs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> knft.output_speed_computation<span class="main">[</span><span class="operator">OF</span> ext'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> q'_nQ<span class="main">]</span> len_w
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> comp_init_q''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">ws</span><span class="main">,</span> <span class="skolem">ws'</span> <span class="main">@</span> <span class="skolem">u2</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v2</span><span class="main">)</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> comp_swap_same_hd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tail'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_hd_app'' tail'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> v''_not_Nil<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> comp_q''_qf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">ws'</span> <span class="main">@</span> <span class="skolem">f</span> <span class="main">#</span> <span class="skolem">fs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v2</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qf'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> comp_pull<span class="main">[</span><span class="operator">OF</span> comp_init_q''<span class="main">]</span> qf'_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tail'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> u2_def<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="skolem"><span class="skolem">ds'</span></span> <span class="keyword2"><span class="keyword">where</span></span> tail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">ws'</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">#</span> <span class="skolem">fs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">ds</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">f</span> <span class="main">#</span> <span class="skolem">fs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">ds'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qf'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">@</span> <span class="skolem">v2</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">ds'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> comp_split<span class="main">[</span><span class="operator">OF</span> comp_q''_qf'<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> r_Q <span class="main">=</span> comp_closed<span class="main">[</span><span class="operator">OF</span> tail<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> comp_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tail'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> init_in_Q<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> comp'<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.computation <span class="skolem">q'</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">#</span> <span class="skolem">fs</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v'</span> <span class="main">@</span> <span class="skolem">ds</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ds'</span><span class="main">)</span> <span class="skolem">nqf'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ext'<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> w_def u2_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> tail<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> len_ds'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ds'</span> <span class="main">≤</span> minv <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> tail<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">length</span><span class="main">]</span> w_def<span class="main">(</span>2<span class="main">)</span> ext'<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minv.simps h_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> comp_init_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">#</span> <span class="skolem">fs</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span> <span class="main">@</span> <span class="skolem">ds</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span><span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> comp_init_q'' tail<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tail'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> u2_def tail<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> len_v'<span class="main">:</span> <span class="quoted"><span class="quoted">"sminv <span class="free">kv</span> <span class="main">≤</span> length <span class="main">(</span><span class="main">(</span><span class="skolem">v'</span> <span class="main">@</span> <span class="skolem">ds</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ds'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unbounded<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tail<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> w_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> t_def<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> conflict<span class="main">:</span>
      <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">=</span> Suc <span class="free">kv</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cw</span><span class="main">.</span> <span class="bound">cw</span><span class="main">∈</span>set <span class="skolem">ws</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="bound">cw</span><span class="main">)</span> <span class="main">∈</span> τ"</span></span>
      <span class="keyword1"><span class="command">using</span></span> conflict<span class="main">[</span><span class="operator">OF</span> unbounded<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> comp' ext'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> comp_init_r tail<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> qf'_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> len_ds' len_v'<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="bound">w</span><span class="main">)</span> <span class="main">`</span> set <span class="skolem">ws</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">u''</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> conflict<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v''</span> <span class="main">@</span> <span class="bound">w</span><span class="main">)</span> <span class="main">`</span> set <span class="skolem">ws</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>set <span class="skolem">ws</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="free">kv</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_card<span class="main">[</span><span class="operator">OF</span> conflict<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conflict<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sub kval<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">u</span></span> <span class="main"><span class="main">@</span></span> <span class="skolem"><span class="skolem">u''</span></span>"</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_mono not_less_eq_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> necessary <span class="main">=</span> knft<span class="main">:</span> kNFT <span class="quoted"><span class="free">ninit</span></span> <span class="quoted"><span class="free">nδ</span></span> <span class="quoted"><span class="free">naccept</span></span> <span class="quoted"><span class="free">nQ</span></span> <span class="main">+</span> kTDFA <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ninit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nδ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'b</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">naccept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nQ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'a</span> Al <span class="main">×</span> <span class="tfree">'b</span> Al <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span> option"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> set"</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"knft.τ <span class="main">=</span> τ"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> otdfa<span class="main">:</span> oTDFA <span class="quoted">otdfa_init</span> <span class="quoted">otdfa_delta</span> <span class="quoted">otdfa_accept</span> <span class="quoted">otdfa_Q</span>
  <span class="keyword1"><span class="command">using</span></span> otdfa_finite_Q otdfa_init_in_Q otdfa_closed<span class="main">[</span><span class="operator">rotated</span><span class="main">]</span>
        otdfa_move_left otdfa_move_right otdfa_no_step otdfa_move_one
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> nec<span class="main">:</span> necessary' <span class="quoted"><span class="free">kv</span></span> <span class="quoted"><span class="free">ninit</span></span> <span class="quoted"><span class="free">nδ</span></span> <span class="quoted"><span class="free">naccept</span></span> <span class="quoted"><span class="free">nQ</span></span> <span class="quoted">otdfa_init</span> <span class="quoted">otdfa_delta</span> <span class="quoted">otdfa_accept</span> <span class="quoted">otdfa_Q</span>
  <span class="keyword1"><span class="command">using</span></span> kval tdfa_equiv_otdfa
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv tdfa_equiv_otdfa<span class="main">)</span>

<span class="comment1">(* Theorem 15 *)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> knft.bounded <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nec.bounded <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>