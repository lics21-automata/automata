<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Computation</title>
</head>


<body>
<div class="head">
<h1>Theory Computation</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Computation
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">xs'</span> <span class="bound">ys'</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="bound">ys'</span> <span class="main">⟹</span> length <span class="bound">xs</span> <span class="main">≤</span> length <span class="bound">xs'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">ds</span><span class="main">.</span> <span class="bound">xs'</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ds</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> append_eq_append_conv_if append_eq_conv_conj<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_app'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">xs'</span> <span class="bound">ys'</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="bound">ys'</span> <span class="main">⟹</span> length <span class="bound">xs</span> <span class="main">≤</span> length <span class="bound">xs'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">es</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">=</span> <span class="bound">es</span> <span class="main">@</span> <span class="bound">ys'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_append_conv_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> app_decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">ys'</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">zs</span> <span class="bound">zs'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">zs</span> <span class="main">@</span> <span class="bound">zs'</span> <span class="main">∧</span> length <span class="bound">zs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">∧</span> length <span class="bound">zs'</span> <span class="main">=</span> length <span class="free">ys'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj length_drop length_rev rev_take<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_zip<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">×</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD set_zip_rightD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">ys'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">zs</span> <span class="bound">zs'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">zs</span> <span class="main">@</span> <span class="bound">zs'</span> <span class="main">∧</span> map <span class="free">f</span> <span class="bound">zs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">∧</span> map <span class="free">f</span> <span class="bound">zs'</span> <span class="main">=</span> <span class="free">ys'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs'</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">zs'</span>"</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="skolem">zs'</span> <span class="main">=</span> <span class="free">ys'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> append_eq_conv_conj<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zs_def zs'_def take_map drop_map<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iter_concat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">iter_concat</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">iter_concat</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="free">iter_concat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iter_concat_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>iter_concat <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iter_concat.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> card_finite_product_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">Q</span> <span class="main">⟹</span> <span class="free">QS'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">×</span> <span class="free">Q</span> <span class="main">⟹</span> card <span class="free">QS'</span> <span class="main">≤</span> card <span class="free">Q</span> <span class="main">*</span> card <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_cartesian_product card_mono finite_cartesian_product<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_bounded_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">bs</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">::</span> finite<span class="main">)</span> list<span class="main">.</span> length <span class="bound">bs</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">bs</span> <span class="main">::</span> <span class="tfree">'b</span> list<span class="main">.</span> length <span class="bound">bs</span> <span class="main">≤</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> length <span class="bound">bs</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> length <span class="bound">bs</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">bs</span> <span class="main">::</span> <span class="tfree">'b</span> list<span class="main">.</span> length <span class="bound">bs</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> length <span class="bound">bs</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">b</span> <span class="main">#</span> <span class="bound">bs</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">bs</span> <span class="main">::</span> <span class="tfree">'b</span> list<span class="main">.</span> length <span class="bound">bs</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">∈</span>UNIV <span class="main">×</span> <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> length <span class="bound">bs</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">b</span> <span class="main">#</span> <span class="bound">bs</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="bound">bs</span> <span class="main">::</span> <span class="tfree">'b</span> list<span class="main">.</span> length <span class="bound">bs</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">b</span> <span class="main">#</span> <span class="bound">bs</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">bs</span> <span class="main">::</span> <span class="tfree">'b</span> list<span class="main">.</span> length <span class="bound">bs</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> infinite_super <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> Suc split <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="comment1">(* an alphabet extended with a special Blank symbol *)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> Al <span class="main">=</span> Symb <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Blank

<span class="comment1">(* safe_hd returns the symbol from the extended alphabet under a reading head
   if the tape consists of a given list of symbols from an alphabet *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">safe_hd</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> Blank <span class="main">|</span> <span class="bound">b</span> <span class="main">#</span> <span class="bound">bs</span> <span class="main">⇒</span> Symb <span class="bound">b</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> safe_hd_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">[]</span> <span class="main">=</span> Blank"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_hd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_hd_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Symb <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_hd_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">xs'</span> <span class="main">@</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs''</span> <span class="main">⟹</span>
  safe_hd <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span>map snd <span class="main">(</span><span class="free">xs'</span> <span class="main">@</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs'''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Cons_eq_append_conv nth_Cons_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_hd_app<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="free">xs</span> <span class="main">=</span> safe_hd <span class="free">xs'</span> <span class="main">⟹</span> safe_hd <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="free">xs'</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_hd_app'<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="free">ys</span> <span class="main">=</span> safe_hd <span class="free">ys'</span> <span class="main">⟹</span> safe_hd <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> append_Nil hd_append2 list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_hd_app''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> safe_hd <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_hd_app_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">ys'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_hd_Nil_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="main">[]</span> <span class="main">=</span> safe_hd <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_hd_Cons_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span> <span class="main">⟹</span> safe_hd <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> Symb <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def<span class="main">)</span>

<span class="comment1">(* Definition 2 *)</span>

<span class="keyword1"><span class="command">locale</span></span> TDFA <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> Al <span class="main">×</span> <span class="tfree">'b</span> Al <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span> option"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    init_in_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="free">q</span> <span class="free">z</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">q'</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    move_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free">q</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q'</span><span class="main">,</span> True<span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≠</span> Blank"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    move_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free">q</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">b1</span><span class="main">,</span> True<span class="main">)</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≠</span> Blank"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    no_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free">q</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q'</span><span class="main">,</span> False<span class="main">,</span> False<span class="main">)</span> <span class="main">⟹</span> False"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* q ↝((as, as'), (bs, bs')) q' iff the automaton has a computation from the state q
   to the state q' with the first tape containing as @ as' and the second tape containing bs @ bs'
   so that the head on the first tape moves past as and the head on the second tape
   moves past bs *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">computation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_<span class="keyword3">/</span><span class="keyword1">↝</span>_<span class="keyword3">/</span>_"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span>63<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  base<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main"><span class="free">↝</span></span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="main">|</span> step_TT<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span>Symb <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Symb <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="main"><span class="free">↝</span></span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main"><span class="free">↝</span></span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span>"</span></span>
<span class="main">|</span> step_TF<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span>Symb <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> safe_hd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="main"><span class="free">↝</span></span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main"><span class="free">↝</span></span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span>"</span></span>
<span class="main">|</span> step_FT<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span>safe_hd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> Symb <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="main"><span class="free">↝</span></span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main"><span class="free">↝</span></span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span>"</span></span>

<span class="comment1">(* the language computed by the automaton *)</span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">τ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">bs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">q</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_TF_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">a</span> <span class="main">#</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="free">δ</span> <span class="free">q'</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> safe_hd <span class="free">bs'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q''</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">a</span> <span class="main">#</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> step_FT_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">b'</span> <span class="main">#</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="free">δ</span> <span class="free">q'</span> <span class="main">(</span>safe_hd <span class="free">as'</span><span class="main">,</span> Symb <span class="free">b'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q''</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b'</span><span class="main">]</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">b'</span> <span class="main">#</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_unreachable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="free">δ</span> <span class="free">q</span> <span class="bound">z</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> computation.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">q'</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">as'</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">bs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> closed<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_computation_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> computation.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">,</span> <span class="free">as''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">q''</span> <span class="bound">cs</span> <span class="bound">cs'</span><span class="main">.</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">cs</span> <span class="main">@</span> <span class="bound">cs'</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span> <span class="main">@</span> <span class="free">as''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">cs</span><span class="main">,</span> <span class="bound">cs'</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="bound">q''</span> <span class="main">∧</span>
    <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">as''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">cs'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">,</span> <span class="free">as''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_TT <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">q'</span> <span class="skolem">as'</span> <span class="skolem">bs</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step_TT<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> step_TT<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> append_Cons computation.step_TT<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_TF <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">bs</span> <span class="skolem">q'</span> <span class="skolem">as</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_FT <span class="skolem">q</span> <span class="skolem">b</span> <span class="skolem">q'</span> <span class="skolem">bs</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step_FT
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> Cons_eq_appendI computation.step_FT<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_pull<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u1</span><span class="main">,</span> <span class="free">u1'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span> <span class="free">v1'</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u1</span> <span class="main">@</span> <span class="free">u2</span><span class="main">,</span> <span class="free">u3</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v1</span> <span class="main">@</span> <span class="free">v2</span><span class="main">,</span> <span class="free">v3</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  safe_hd <span class="free">u1'</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="free">u2</span> <span class="main">@</span> <span class="free">u3</span><span class="main">)</span> <span class="main">⟹</span> safe_hd <span class="free">v1'</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="free">v2</span> <span class="main">@</span> <span class="free">v3</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u2</span><span class="main">,</span> <span class="free">u3</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v2</span><span class="main">,</span> <span class="free">v3</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">u1</span><span class="main">,</span> <span class="free">u1'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span> <span class="free">v1'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q''</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u1</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_TT <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">q'''</span> <span class="skolem">as</span> <span class="skolem">bs</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="free">u2</span><span class="main">,</span> <span class="free">u3</span><span class="main">)</span><span class="main">,</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="free">v2</span><span class="main">,</span> <span class="free">v3</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_TT<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> computation.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> step_TT<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ step_TT<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">,</span></span></span>6<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_TF <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">bs</span> <span class="skolem">q'''</span> <span class="skolem">as</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="free">u2</span><span class="main">,</span> <span class="free">u3</span><span class="main">)</span><span class="main">,</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="free">v2</span><span class="main">,</span> <span class="free">v3</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_TF<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> safe_hd_Cons_app<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">@</span> <span class="free">v2</span>"</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">v3</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_app'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step_TF<span class="main"><span class="main"><span class="main">(</span></span></span>6<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> safe_hd_Cons <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> computation.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> step_TF<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ step_TF<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">,</span></span></span>6<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_FT <span class="skolem">q</span> <span class="skolem">as</span> <span class="skolem">b</span> <span class="skolem">q'''</span> <span class="skolem">bs</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'''</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="free">u2</span><span class="main">,</span> <span class="free">u3</span><span class="main">)</span><span class="main">,</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="free">v2</span><span class="main">,</span> <span class="free">v3</span><span class="main">)</span><span class="free">q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_FT<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> safe_hd_Cons_app<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">@</span> <span class="free">u2</span>"</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">u3</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_app'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step_FT<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> safe_hd_Cons <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> computation.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> step_FT<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ step_FT<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">,</span></span></span>6<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">a'</span> <span class="main">#</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">a'</span> <span class="main">#</span> <span class="free">as''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">a'</span> <span class="main">#</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> safe_hd_app_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_swap'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">b'</span> <span class="main">#</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">b'</span> <span class="main">#</span> <span class="free">bs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">b'</span> <span class="main">#</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> safe_hd_app_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_swap_same_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  safe_hd <span class="free">as'</span> <span class="main">=</span> safe_hd <span class="free">as''</span> <span class="main">⟹</span> safe_hd <span class="free">bs'</span> <span class="main">=</span> safe_hd <span class="free">bs''</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> safe_hd_app'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q'</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">cs</span><span class="main">,</span> <span class="free">cs'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">ds</span><span class="main">,</span> <span class="free">ds'</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span> <span class="main">⟹</span>
  safe_hd <span class="free">as'</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="free">cs'</span><span class="main">)</span> <span class="main">⟹</span> safe_hd <span class="free">bs'</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="free">ds</span> <span class="main">@</span> <span class="free">ds'</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">cs</span><span class="main">,</span> <span class="free">cs'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">ds</span><span class="main">,</span> <span class="free">ds'</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> safe_hd_app'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_hd_Nil_dest<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_swapR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">cs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[]</span> <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_transR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cs</span><span class="main">,</span> <span class="free">bs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">cs</span><span class="main">,</span> <span class="free">bs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> comp_swapR<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fst_stepL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span><span class="free">q'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">q''</span><span class="main">.</span> <span class="free">δ</span> <span class="free">q</span> <span class="main">(</span>safe_hd <span class="free">as'</span><span class="main">,</span> Symb <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q''</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span> <span class="main">∧</span> <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> computation.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_splitL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="free">cs'</span><span class="main">,</span> <span class="free">cs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">q''</span><span class="main">.</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cs</span><span class="main">,</span> <span class="free">cs'</span> <span class="main">@</span> <span class="free">cs''</span><span class="main">)</span><span class="main">)</span> <span class="bound">q''</span> <span class="main">∧</span> <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cs'</span><span class="main">,</span> <span class="free">cs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fst_stepL<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> shift_compL<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="free">cs'</span><span class="main">)</span><span class="main">,</span> <span class="free">ds'</span><span class="main">)</span><span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="free">ds'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="free">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cs</span><span class="main">,</span> <span class="free">cs'</span> <span class="main">@</span> <span class="free">ds'</span><span class="main">)</span><span class="main">)</span> <span class="bound">t''</span> <span class="main">∧</span> <span class="bound">t''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cs'</span> <span class="main">@</span> <span class="free">ds'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free">r'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> t''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cs</span><span class="main">,</span> <span class="free">cs'</span> <span class="main">@</span> <span class="free">ds'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cs'</span><span class="main">,</span> <span class="free">ds'</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_splitL<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> comb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cs'</span> <span class="main">@</span> <span class="free">ds'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> t''_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> t''_def<span class="main">(</span>1<span class="main">)</span> comb
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fst_stepR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span><span class="free">q'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">q''</span><span class="main">.</span> <span class="free">δ</span> <span class="free">q</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> safe_hd <span class="free">bs'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q''</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="main">∧</span> <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> computation.cases<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">computation_ext</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_<span class="keyword3">/</span><span class="keyword1">↝e</span>_<span class="keyword3">/</span>_"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span>63<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  base_ext<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1"><span class="free">↝e</span></span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="main">|</span> step_TT_ext<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span>Symb <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Symb <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="keyword1"><span class="free">↝e</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1"><span class="free">↝e</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span>"</span></span>
<span class="main">|</span> step_TF_ext<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span>Symb <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> safe_hd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="keyword1"><span class="free">↝e</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1"><span class="free">↝e</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span>"</span></span>
<span class="main">|</span> step_FT_ext<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span>safe_hd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> Symb <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="keyword1"><span class="free">↝e</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1"><span class="free">↝e</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_to_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">qs</span><span class="main">.</span> <span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="bound">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ext_to_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation_ext.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ext_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> set <span class="free">qs</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation_ext.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> closed
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_ext_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="free">q'</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs'</span><span class="main">,</span> <span class="main">(</span><span class="free">cs</span><span class="main">,</span> <span class="free">cs'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">ds</span><span class="main">,</span> <span class="free">ds'</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span> <span class="main">⟹</span>
  safe_hd <span class="free">as'</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="free">cs'</span><span class="main">)</span> <span class="main">⟹</span> safe_hd <span class="free">bs'</span> <span class="main">=</span> safe_hd <span class="main">(</span><span class="free">ds</span> <span class="main">@</span> <span class="free">ds'</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span> <span class="main">@</span> <span class="free">qs'</span><span class="main">,</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">cs</span><span class="main">,</span> <span class="free">cs'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">ds</span><span class="main">,</span> <span class="free">ds'</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation_ext.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> safe_hd_app'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_hd_Nil_dest<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_ext_swapR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">cs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span> <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation_ext.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_ext_transR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs'</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cs</span><span class="main">,</span> <span class="free">bs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span> <span class="main">@</span> <span class="free">qs'</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">cs</span><span class="main">,</span> <span class="free">bs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_ext_trans<span class="main">[</span><span class="operator">OF</span> comp_ext_swapR<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ext_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span> <span class="main">@</span> <span class="free">q'</span> <span class="main">#</span> <span class="free">qs'</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">b</span> <span class="main">#</span> <span class="free">bs'</span><span class="main">,</span> <span class="free">bs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span> <span class="main">⟹</span>
  length <span class="free">qs</span> <span class="main">=</span> length <span class="free">bs</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span> <span class="main">@</span> <span class="main">[</span><span class="free">q'</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">∧</span> <span class="free">q'</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs'</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs'</span><span class="main">,</span> <span class="free">bs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">qs</span> <span class="main">@</span> <span class="free">q'</span> <span class="main">#</span> <span class="free">qs'</span><span class="main">,</span>  <span class="main">(</span><span class="main">[]</span> <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">b</span> <span class="main">#</span> <span class="free">bs'</span><span class="main">,</span> <span class="free">bs''</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q''</span></span>
    <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation_ext.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_FT_ext <span class="skolem">q</span> <span class="skolem">b</span> <span class="skolem">q'a</span> <span class="skolem">qs</span> <span class="skolem">bs</span> <span class="skolem">q''</span> <span class="skolem">qsa</span> <span class="skolem">bsa</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">qsa</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">bsa</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ext_rem_loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span> <span class="main">@</span> <span class="free">q'</span> <span class="main">#</span> <span class="free">qs'</span> <span class="main">@</span> <span class="free">q'</span> <span class="main">#</span> <span class="free">qs''</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">b</span> <span class="main">#</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">b'</span> <span class="main">#</span> <span class="free">bs''</span><span class="main">,</span> <span class="free">bs'''</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">=</span> length <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">qs'</span> <span class="main">=</span> length <span class="free">bs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span> <span class="main">@</span> <span class="free">q'</span> <span class="main">#</span> <span class="free">qs''</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">b</span> <span class="main">#</span> <span class="free">bs''</span><span class="main">,</span> <span class="free">bs'''</span><span class="main">)</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span> <span class="main">@</span> <span class="main">[</span><span class="free">q'</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> <span class="free">b'</span> <span class="main">#</span> <span class="free">bs''</span><span class="main">)</span> <span class="main">@</span> <span class="free">bs'''</span><span class="main">)</span><span class="free">q'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs'</span> <span class="main">@</span> <span class="free">q'</span> <span class="main">#</span> <span class="free">qs''</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">b'</span> <span class="main">#</span> <span class="free">bs''</span><span class="main">,</span> <span class="free">bs'''</span><span class="main">)</span><span class="free">q''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ext_split<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> split'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q'</span><span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs'</span> <span class="main">@</span> <span class="main">[</span><span class="free">q'</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> <span class="main">[</span><span class="free">b'</span><span class="main">]</span><span class="main">,</span> <span class="free">bs''</span> <span class="main">@</span> <span class="free">bs'''</span><span class="main">)</span><span class="free">q'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">q'</span><span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs''</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="free">bs''</span><span class="main">,</span> <span class="free">bs'''</span><span class="main">)</span><span class="free">q''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ext_split<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_ext_transR<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* TDFA in which at most one head moves at any step *)</span>

<span class="keyword1"><span class="command">locale</span></span> oTDFA <span class="main">=</span> TDFA <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> Al <span class="main">×</span> <span class="tfree">'b</span> Al <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span> option"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> move_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free">q</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q'</span><span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span> <span class="main">⟹</span> False"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_ext_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> length <span class="free">qs</span> <span class="main">=</span> length <span class="free">as</span> <span class="main">+</span> length <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">qs</span><span class="main">,</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation_ext.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> move_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fst_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">q''</span><span class="main">.</span> <span class="free">δ</span> <span class="free">q</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> Symb <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q''</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="main">∧</span> <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">q''</span><span class="main">.</span> <span class="free">δ</span> <span class="free">q</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> Symb <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q''</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span> <span class="main">∧</span> <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> move_one <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> computation.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_outs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">r</span> <span class="bound">r'</span> <span class="bound">cs</span> <span class="bound">cs'</span><span class="main">.</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">cs</span> <span class="main">@</span> <span class="bound">cs'</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">a</span> <span class="main">#</span> <span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">cs</span><span class="main">,</span> <span class="bound">cs'</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span> <span class="main">∧</span>
  <span class="free">δ</span> <span class="bound">r</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> safe_hd <span class="main">(</span><span class="bound">cs'</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="main">∧</span> <span class="bound">r'</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">cs'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fst_stepR
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fst_step<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q''</span><span class="main">.</span> <span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> Symb <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q''</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="main">∧</span>
      <span class="bound">q''</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs''</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="free">q'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> r'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> Symb <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">r'</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs''</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="free">q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">r'</span> <span class="bound">cs</span> <span class="bound">cs'</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs''</span> <span class="main">=</span> <span class="bound">cs</span> <span class="main">@</span> <span class="bound">cs'</span> <span class="main">∧</span>
      <span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">a</span> <span class="main">#</span> <span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="bound">cs</span><span class="main">,</span> <span class="bound">cs'</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span><span class="bound">r</span> <span class="main">∧</span>
      <span class="free">δ</span> <span class="bound">r</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> safe_hd <span class="main">(</span><span class="bound">cs'</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="main">∧</span> <span class="bound">r'</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="bound">cs'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="free">q'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">q</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">r'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def r'_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q''</span><span class="main">.</span> <span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> Symb <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q''</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span> <span class="main">∧</span>
      <span class="bound">q''</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">bs''</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="free">q'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> Symb <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">bs''</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="free">q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs''</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">a</span> <span class="main">#</span> <span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span><span class="skolem">r</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">r</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> safe_hd <span class="main">(</span><span class="skolem">cs'</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="free">q'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> s_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> comp_q_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">a</span> <span class="main">#</span> <span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">,</span> <span class="skolem">bs''</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step_FT<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ base<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> s_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> comp_q_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">a</span> <span class="main">#</span> <span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>2<span class="main">)</span> comp_trans<span class="main">[</span><span class="operator">OF</span> comp_q_s<span class="main">]</span> comp_q_s
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">r'</span> <span class="bound">cs</span> <span class="bound">cs'</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs''</span> <span class="main">=</span> <span class="bound">cs</span> <span class="main">@</span> <span class="bound">cs'</span> <span class="main">∧</span> <span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">a</span> <span class="main">#</span> <span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="bound">cs</span><span class="main">,</span> <span class="bound">cs'</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span><span class="bound">r</span> <span class="main">∧</span>
      <span class="free">δ</span> <span class="bound">r</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> safe_hd <span class="main">(</span><span class="bound">cs'</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="main">∧</span> <span class="bound">r'</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="bound">cs'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="free">q'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">r</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">r'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">b</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">cs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">cs'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split comp_q_r<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_zip_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x'</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span> length <span class="bound">xs'</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="bound">xs'</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x'</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">x'</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs'</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">xs'</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x'</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> x'_def xs'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_zip_upd4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x'</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">w</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span> length <span class="bound">xs'</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="bound">xs'</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x'</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_zip_upd<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x'</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">y</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">y'</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">g</span> <span class="bound">x'</span> <span class="bound">y'</span> <span class="bound">z</span> <span class="bound">w</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> split_outss<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ws</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cs</span> <span class="bound">cs'</span> <span class="bound">ts</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="bound">cs</span> <span class="main">@</span> <span class="bound">cs'</span> <span class="main">∧</span> length <span class="bound">ts</span> <span class="main">=</span> length <span class="free">ws</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="bound">ts</span> <span class="free">ws</span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">cs</span><span class="main">,</span> <span class="bound">cs'</span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="keyword1">case</span> concat <span class="main">(</span>map fst <span class="free">ws</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="bound">cs'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="bound">ts</span> <span class="free">ws</span><span class="main">)</span><span class="main">.</span>
      <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">t</span> <span class="main">(</span>safe_hd <span class="bound">w</span><span class="main">,</span> safe_hd <span class="bound">cs'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ws</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">wrr'</span> <span class="skolem">ws</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> wrr'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wrr'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">wrr'</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span> <span class="main">=</span> length <span class="skolem">ws</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">ts</span> <span class="skolem">ws</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="bound">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> concat <span class="main">(</span>map fst <span class="skolem">ws</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="skolem">cs'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">ts</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">.</span>
      <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">t</span> <span class="main">(</span>safe_hd <span class="bound">w</span><span class="main">,</span> safe_hd <span class="skolem">cs'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wrr'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span><span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> comp_splitL<span class="main">[</span><span class="operator">OF</span> comp<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Nil ws_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> ws_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> concat_map_fst_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">ws</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span> concat <span class="main">(</span>map fst <span class="skolem">ws</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> one_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> concat <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">wrr'</span> <span class="main">#</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="skolem">cs'</span> <span class="main">=</span> <span class="main">[]</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wrr'</span> <span class="main">#</span> <span class="skolem">ws</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">t</span> <span class="main">(</span>safe_hd <span class="bound">w</span><span class="main">,</span> safe_hd <span class="skolem">cs'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ws_def<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wrr'_def Nil <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> concat_map_fst_Nil <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">cs</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">cs'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ws_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> t_def one_step
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wrr'_def Nil <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="skolem"><span class="skolem">ds'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">ds'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ds</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span><span class="skolem">t</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">t</span> <span class="main">(</span>Symb <span class="skolem">a</span><span class="main">,</span> safe_hd <span class="skolem">ds'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="skolem">r'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_outs<span class="main">[</span><span class="operator">OF</span> comp<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Cons<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ds</span> <span class="main">≤</span> length <span class="skolem">cs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> cs''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">cs''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ws_def<span class="main">(</span>1<span class="main">)</span> split<span class="main">(</span>1<span class="main">)</span> True split_app<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ds</span></span> <span class="quoted"><span class="skolem">ds'</span></span> <span class="quoted"><span class="skolem">cs</span></span> <span class="quoted"><span class="skolem">cs'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> ds'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ds'</span> <span class="main">=</span> <span class="skolem">cs''</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ws_def<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs''_def<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> ts_ts'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">ts</span> <span class="skolem">ws</span><span class="main">)</span> <span class="main">⟹</span>
        <span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="bound">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">ds</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span><span class="main">)</span> <span class="bound">t''</span> <span class="main">∧</span> <span class="bound">t''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">ds'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ws_def<span class="main">(</span>3<span class="main">)</span> shift_compL<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">ds</span></span> <span class="quoted"><span class="skolem">cs''</span></span> <span class="quoted"><span class="skolem">cs'</span></span><span class="main">,</span> <span class="operator">folded</span> cs''_def ds'_def<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts'</span> <span class="main">=</span> length <span class="skolem">ts</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">ts'</span> <span class="skolem">ws</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="bound">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">ds</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">w</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">ds'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> set_zip_upd4<span class="main">[</span><span class="operator">OF</span> ws_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ts_ts'<span class="main">]</span> ws_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ds</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ds'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>1<span class="main">)</span> ts'_def<span class="main">(</span>1<span class="main">)</span> ws_def<span class="main">(</span>2<span class="main">)</span> split<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span> ts'_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wrr'_def Cons safe_hd_Cons <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds''</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">ds''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ws_def<span class="main">(</span>1<span class="main">)</span> split<span class="main">(</span>1<span class="main">)</span> False split_app<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">cs</span></span> <span class="quoted"><span class="skolem">cs'</span></span> <span class="quoted"><span class="skolem">ds</span></span> <span class="quoted"><span class="skolem">ds'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> cs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="skolem">ds''</span> <span class="main">@</span> <span class="skolem">ds'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ws_def<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ds''_def<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> shift_compL<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ds''_def<span class="main"><span class="main">]</span></span> split<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cs'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> concat_map_fst_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map fst <span class="skolem">ws</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False cs'_def ds''_def ws_def<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">cs</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">cs'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> ws_def t'_def concat_map_fst_Cons
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wrr'_def Cons <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">ts</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> first_reaches<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">us</span> <span class="main">@</span> <span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">vs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">ws</span> <span class="bound">ws'</span> <span class="bound">q''</span><span class="main">.</span> <span class="free">vs</span> <span class="main">=</span> <span class="bound">ws</span> <span class="main">@</span> <span class="bound">ws'</span> <span class="main">∧</span> <span class="bound">ws'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">us</span><span class="main">,</span> <span class="free">us'</span> <span class="main">@</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="free">vs'</span> <span class="main">@</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="bound">q''</span> <span class="main">∧</span>
      <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">ws'</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">ws</span> <span class="bound">ws'</span> <span class="bound">q''</span><span class="main">.</span> <span class="free">us</span> <span class="main">=</span> <span class="bound">ws</span> <span class="main">@</span> <span class="bound">ws'</span> <span class="main">∧</span> <span class="bound">ws'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="free">us'</span> <span class="main">@</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span> <span class="main">@</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="bound">q''</span> <span class="main">∧</span>
      <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">ws'</span> <span class="main">@</span> <span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">us</span> <span class="main">+</span> length <span class="free">vs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">us</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">uss</span> <span class="bound">vss</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">uss</span> <span class="main">@</span> <span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">vss</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="bound">uss</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∨</span> <span class="bound">vss</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span> length <span class="bound">uss</span> <span class="main">+</span> length <span class="bound">vss</span> <span class="main">&lt;</span> length <span class="skolem">us</span> <span class="main">+</span> length <span class="skolem">vs</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">ws</span> <span class="bound">ws'</span> <span class="bound">q''</span><span class="main">.</span> <span class="bound">vss</span> <span class="main">=</span> <span class="bound">ws</span> <span class="main">@</span> <span class="bound">ws'</span> <span class="main">∧</span> <span class="bound">ws'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="bound">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">uss</span><span class="main">,</span> <span class="free">us'</span> <span class="main">@</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="free">vs'</span> <span class="main">@</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="bound">q''</span> <span class="main">∧</span>
      <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">ws'</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">ws</span> <span class="bound">ws'</span> <span class="bound">q''</span><span class="main">.</span> <span class="bound">uss</span> <span class="main">=</span> <span class="bound">ws</span> <span class="main">@</span> <span class="bound">ws'</span> <span class="main">∧</span> <span class="bound">ws'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
      <span class="bound">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="free">us'</span> <span class="main">@</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">vss</span><span class="main">,</span> <span class="free">vs'</span> <span class="main">@</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="bound">q''</span> <span class="main">∧</span>
      <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">ws'</span> <span class="main">@</span> <span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> u_def<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">u</span> <span class="skolem">uss'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">vs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u_def Nil<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> v_def<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vss'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">uss'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">vs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">vss'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u_def v_def<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qm</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>Symb <span class="skolem">u</span><span class="main">,</span> Symb <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qm</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="main">∧</span>
          <span class="skolem">qm</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">uss'</span> <span class="main">@</span> <span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span><span class="main">)</span> <span class="main">∨</span>
        <span class="main">(</span><span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>Symb <span class="skolem">u</span><span class="main">,</span> Symb <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qm</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span> <span class="main">∧</span>
          <span class="skolem">qm</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">vss'</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fst_step<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> u_def v_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u_def v_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>Symb <span class="skolem">u</span><span class="main">,</span> Symb <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qm</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="main">∧</span>
          <span class="skolem">qm</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">uss'</span> <span class="main">@</span> <span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>Symb <span class="skolem">u</span><span class="main">,</span> Symb <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qm</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">qm</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">uss'</span> <span class="main">@</span> <span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">ws</span> <span class="bound">ws'</span> <span class="bound">q''</span><span class="main">.</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="bound">ws</span> <span class="main">@</span> <span class="bound">ws'</span> <span class="main">∧</span> <span class="bound">ws'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
            <span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">us</span><span class="main">,</span> <span class="free">us'</span> <span class="main">@</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="bound">ws</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="free">vs'</span> <span class="main">@</span> <span class="free">vs''</span><span class="main">)</span><span class="bound">q''</span> <span class="main">∧</span>
            <span class="bound">q''</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="free">q'</span><span class="main">)</span> <span class="main">∨</span>
          <span class="main">(</span><span class="main">∃</span><span class="bound">ws</span> <span class="bound">ws'</span> <span class="bound">q''</span><span class="main">.</span> <span class="skolem">us</span> <span class="main">=</span> <span class="bound">ws</span> <span class="main">@</span> <span class="bound">ws'</span> <span class="main">∧</span> <span class="bound">ws'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
            <span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="free">us'</span> <span class="main">@</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">vs</span><span class="main">,</span> <span class="free">vs'</span> <span class="main">@</span> <span class="free">vs''</span><span class="main">)</span><span class="bound">q''</span> <span class="main">∧</span>
            <span class="bound">q''</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">ws'</span> <span class="main">@</span> <span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="free">q'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IH<span class="main">[</span><span class="operator">OF</span> lassms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assm<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> u_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ws ws' q''
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ws</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ws'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">q''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step_TF<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> v_def safe_hd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_assoc list.inject<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ws ws' q''
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">u</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">ws</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ws'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u_def v_def safe_hd_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">q''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>Symb <span class="skolem">u</span><span class="main">,</span> Symb <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qm</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span> <span class="main">∧</span>
          <span class="skolem">qm</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">vss'</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="free">q'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>Symb <span class="skolem">u</span><span class="main">,</span> Symb <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qm</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">qm</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">vss'</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="free">q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">ws</span> <span class="bound">ws'</span> <span class="bound">q''</span><span class="main">.</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="bound">ws</span> <span class="main">@</span> <span class="bound">ws'</span> <span class="main">∧</span> <span class="bound">ws'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
            <span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">us</span><span class="main">,</span> <span class="free">us'</span> <span class="main">@</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="bound">ws</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="free">vs'</span> <span class="main">@</span> <span class="free">vs''</span><span class="main">)</span><span class="bound">q''</span> <span class="main">∧</span>
            <span class="bound">q''</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="free">q'</span><span class="main">)</span> <span class="main">∨</span>
          <span class="main">(</span><span class="main">∃</span><span class="bound">ws</span> <span class="bound">ws'</span> <span class="bound">q''</span><span class="main">.</span> <span class="skolem">us</span> <span class="main">=</span> <span class="bound">ws</span> <span class="main">@</span> <span class="bound">ws'</span> <span class="main">∧</span> <span class="bound">ws'</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
            <span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="free">us'</span> <span class="main">@</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">vs</span><span class="main">,</span> <span class="free">vs'</span> <span class="main">@</span> <span class="free">vs''</span><span class="main">)</span><span class="bound">q''</span> <span class="main">∧</span>
            <span class="bound">q''</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="bound">ws'</span> <span class="main">@</span> <span class="free">us'</span><span class="main">,</span> <span class="free">us''</span><span class="main">)</span><span class="main">,</span> <span class="free">vs'</span><span class="main">,</span> <span class="free">vs''</span><span class="main">)</span><span class="free">q'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IH<span class="main">[</span><span class="operator">OF</span> lassms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assm<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> v_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ws ws' q''
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">v</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">ws</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ws'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u_def v_def safe_hd_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">q''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ws ws' q''
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ws</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ws'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> v_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">q''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step_FT<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_assoc list.inject<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_to_states<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">qs</span><span class="main">.</span> length <span class="bound">qs</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">bs</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">qs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="free">q</span> <span class="main">∧</span>
  <span class="main">(</span><span class="bound">qs</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">∧</span> set <span class="bound">qs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">bs</span><span class="main">.</span> <span class="free">δ</span> <span class="main">(</span><span class="bound">qs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>safe_hd <span class="free">as'</span><span class="main">,</span> Symb <span class="main">(</span><span class="free">bs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">qs</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">q</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="keyword2"><span class="keyword">where</span></span> q''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>safe_hd <span class="free">as'</span><span class="main">,</span> Symb <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q''</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">bs''</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst_stepL<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> q''_Q <span class="main">=</span> closed<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> q''_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> qs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">bs''</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">q''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qs</span> <span class="main">!</span> length <span class="skolem">bs''</span><span class="main">)</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">qs</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">bs''</span> <span class="main">⟹</span>
      <span class="free">δ</span> <span class="main">(</span><span class="skolem">qs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>safe_hd <span class="free">as'</span><span class="main">,</span> Symb <span class="main">(</span><span class="skolem">bs''</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> q''_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> q''_Q<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">q</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">qs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> qs_def q''_def<span class="main">(</span>1<span class="main">)</span> Cons<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> states_to_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">bs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">qs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="free">q</span> <span class="main">∧</span> <span class="free">qs</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">bs</span><span class="main">)</span> <span class="main">=</span> <span class="free">q'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">bs</span><span class="main">.</span>
    <span class="free">δ</span> <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>safe_hd <span class="free">as'</span><span class="main">,</span> Symb <span class="main">(</span><span class="free">bs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">qs</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quoted"><span class="free">bs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">b</span> <span class="skolem">bs''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs''</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">=</span> <span class="skolem">qs''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q''</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs''</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">bs''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">qs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">bs''</span><span class="main">,</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">qs</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">bs''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">qs''</span></span><span class="main">]</span> snoc<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split nth_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">(</span><span class="skolem">qs</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">bs''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>safe_hd <span class="free">as'</span><span class="main">,</span> Symb <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step_FT_rev<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> det_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u0</span><span class="main">,</span> <span class="free">u</span> <span class="main">@</span> <span class="free">u''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v0</span> <span class="main">@</span> <span class="free">x</span><span class="main">,</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span><span class="free">r</span> <span class="main">⟹</span> <span class="free">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u0</span> <span class="main">@</span> <span class="free">u</span><span class="main">,</span> <span class="free">u''</span><span class="main">)</span><span class="main">,</span> <span class="free">v0</span> <span class="main">@</span> <span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="free">nr'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">w</span> <span class="bound">w'</span> <span class="bound">nr</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="bound">w</span> <span class="main">@</span> <span class="bound">w'</span> <span class="main">∧</span> <span class="free">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u0</span><span class="main">,</span> <span class="free">u</span> <span class="main">@</span> <span class="free">u''</span><span class="main">)</span><span class="main">,</span> <span class="free">v0</span> <span class="main">@</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">w'</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span><span class="bound">nr</span> <span class="main">∧</span> <span class="bound">nr</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">u''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">w'</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">)</span><span class="free">nr'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">u0</span><span class="main">,</span> <span class="free">u</span> <span class="main">@</span> <span class="free">u''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v0</span> <span class="main">@</span> <span class="free">x</span><span class="main">,</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u0</span></span> <span class="quoted"><span class="free">v0</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_TT <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">q'</span> <span class="skolem">as</span> <span class="skolem">bs</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> move_one
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_TF <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">q'</span> <span class="skolem">as</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v0</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> comp_split<span class="main">[</span><span class="operator">OF</span> step_TF<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">v0'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>Symb <span class="skolem">a</span><span class="main">,</span> safe_hd <span class="main">(</span><span class="main">(</span><span class="skolem">v0</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_TF<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons safe_hd_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> det_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="free">u</span><span class="main">,</span> <span class="free">u''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v0</span> <span class="main">@</span> <span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="free">nr'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> computation.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step_TF<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> step
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_Cons<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step_TF<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> det_comp<span class="main">]</span> step
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_FT <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">q'</span> <span class="skolem">v0'</span> <span class="skolem">r'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v0</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> comp_split<span class="main">[</span><span class="operator">OF</span> step_FT<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b'</span> <span class="skolem">v0''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> v0'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v0'</span> <span class="main">=</span> <span class="skolem">v0''</span> <span class="main">@</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_FT<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span>safe_hd <span class="main">(</span><span class="skolem">a</span> <span class="main">@</span> <span class="free">u</span> <span class="main">@</span> <span class="free">u''</span><span class="main">)</span><span class="main">,</span> Symb <span class="skolem">b'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_FT<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> det_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">@</span> <span class="free">u</span><span class="main">,</span> <span class="free">u''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">v0''</span> <span class="main">@</span> <span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="free">nr'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> computation.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step_FT<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> step move_one
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons safe_hd_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc option.inject prod.inject safe_hd_Cons_app<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step_FT<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> v0'_def det_comp<span class="main">]</span> step
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> det_comp_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u0</span> <span class="main">@</span> <span class="free">u</span><span class="main">,</span> <span class="free">u''</span><span class="main">)</span><span class="main">,</span> <span class="free">v0</span> <span class="main">@</span> <span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="free">nr'</span> <span class="main">⟹</span> <span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u0</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">v0</span> <span class="main">@</span> <span class="free">x</span><span class="main">,</span> <span class="free">x'</span><span class="main">)</span><span class="main">)</span><span class="free">r</span> <span class="main">⟹</span>
  safe_hd <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="free">u''</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="free">u'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">w</span> <span class="bound">w'</span> <span class="bound">nr</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="bound">w</span> <span class="main">@</span> <span class="bound">w'</span> <span class="main">∧</span> <span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u0</span><span class="main">,</span> <span class="free">u</span> <span class="main">@</span> <span class="free">u''</span><span class="main">)</span><span class="main">,</span> <span class="free">v0</span> <span class="main">@</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">w'</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span><span class="bound">nr</span> <span class="main">∧</span> <span class="bound">nr</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">u''</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">w'</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">)</span><span class="free">nr'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> det_comp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comp_swap_same_hd<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* simulation of a general TDFA by an oTDFA *)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'s</span> otdfa_s <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">+</span> <span class="tfree">'s</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> TDFA
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">otdfa_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> otdfa_s"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">otdfa_init</span> <span class="main">=</span> Inl <span class="free">init</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">otdfa_delta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> otdfa_s <span class="main">⇒</span> <span class="tfree">'a</span> Al <span class="main">×</span> <span class="tfree">'b</span> Al <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> otdfa_s <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">otdfa_delta</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">b1</span><span class="main">,</span> <span class="bound">b2</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="keyword1">if</span> <span class="bound">b1</span> <span class="main">∧</span> <span class="bound">b2</span> <span class="keyword1">then</span> Some <span class="main">(</span>Inr <span class="bound">q'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="keyword1">else</span> Some <span class="main">(</span>Inl <span class="bound">q'</span><span class="main">,</span> <span class="bound">b1</span><span class="main">,</span> <span class="bound">b2</span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">otdfa_delta</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Symb <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">otdfa_delta</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Blank<span class="main">)</span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">otdfa_accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> otdfa_s <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">otdfa_accept</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">q'</span> <span class="main">⇒</span> <span class="free">accept</span> <span class="bound">q'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">otdfa_Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> otdfa_s set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">otdfa_Q</span> <span class="main">=</span> Inl <span class="main">`</span> <span class="free">Q</span> <span class="main">∪</span> Inr <span class="main">`</span> <span class="free">Q</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> otdfa_delta_Inr<span class="main">:</span> <span class="quoted"><span class="quoted">"otdfa_delta <span class="free">q</span> <span class="free">z</span> <span class="main">=</span> Some <span class="main">(</span>Inr <span class="free">q'</span><span class="main">,</span> <span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">q''</span><span class="main">.</span> <span class="free">q</span> <span class="main">=</span> Inl <span class="bound">q''</span> <span class="main">∧</span> <span class="free">δ</span> <span class="bound">q''</span> <span class="free">z</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q'</span><span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span> <span class="main">∧</span> <span class="free">b1</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">b2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> otdfa_delta.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> otdfa_finite_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"finite otdfa_Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_Q
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> otdfa_Q_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> otdfa_init_in_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"otdfa_init <span class="main">∈</span> otdfa_Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_in_Q
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> otdfa_init_def otdfa_Q_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> otdfa_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"otdfa_delta <span class="free">q</span> <span class="free">z</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> otdfa_Q"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">∈</span> otdfa_Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> otdfa_delta.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> otdfa_Q_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits Al.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> closed<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> otdfa_move_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"otdfa_delta <span class="free">q</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q'</span><span class="main">,</span> True<span class="main">,</span> <span class="free">b2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> Blank"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms move_left
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> otdfa_delta.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits Al.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> otdfa_move_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"otdfa_delta <span class="free">q</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">b1</span><span class="main">,</span> True<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> Blank"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms move_right
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> otdfa_delta.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits Al.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> otdfa_no_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"otdfa_delta <span class="free">q</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q'</span><span class="main">,</span> False<span class="main">,</span> False<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms no_step
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> otdfa_delta.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits Al.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> otdfa_move_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"otdfa_delta <span class="free">q</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q'</span><span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> otdfa_delta.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits Al.splits<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> otdfa<span class="main">:</span> oTDFA <span class="quoted">otdfa_init</span> <span class="quoted">otdfa_delta</span> <span class="quoted">otdfa_accept</span> <span class="quoted">otdfa_Q</span>
  <span class="keyword1"><span class="command">using</span></span> otdfa_finite_Q otdfa_init_in_Q otdfa_closed<span class="main">[</span><span class="operator">rotated</span><span class="main">]</span>
        otdfa_move_left otdfa_move_right otdfa_no_step otdfa_move_one
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>6<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> tdfa_comp_otdfa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"otdfa.computation <span class="main">(</span>Inl <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">q'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">as'</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">bs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_TT <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">q'</span> <span class="skolem">as</span> <span class="skolem">as'</span> <span class="skolem">bs</span> <span class="skolem">bs'</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> otdfa.computation.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> otdfa.computation.intros<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span>
        <span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> step_TT<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def step_TT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> otdfa_comp_tdfa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"otdfa.computation <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> Inl <span class="free">q</span> <span class="main">∨</span> <span class="main">(</span><span class="free">r</span> <span class="main">=</span> Inr <span class="free">q''</span> <span class="main">∧</span> <span class="free">δ</span> <span class="free">q</span> <span class="main">(</span>Symb <span class="free">a</span><span class="main">,</span> safe_hd <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q''</span><span class="main">,</span> True<span class="main">,</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">r</span> <span class="main">=</span> Inr <span class="free">q''</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Inl <span class="free">q'</span> <span class="main">::</span> <span class="tfree">'s</span> otdfa_s"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">q''</span></span>
  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> otdfa.computation.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_TT <span class="skolem">r</span> <span class="skolem">x</span> <span class="skolem">b</span> <span class="skolem">r'</span> <span class="skolem">as</span> <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> otdfa_move_one<span class="main">[</span><span class="operator">OF</span> step_TT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_TF <span class="skolem">r</span> <span class="skolem">x</span> <span class="skolem">bs</span> <span class="skolem">r'</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">r''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step_TF
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def Inl <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">r''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step_TF
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def Inr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_FT <span class="skolem">r</span> <span class="skolem">as</span> <span class="skolem">b</span> <span class="skolem">r'</span> <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tdfa_otdfa_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟷</span>
  otdfa.computation <span class="main">(</span>Inl <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">q'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tdfa_comp_otdfa otdfa_comp_tdfa<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Inl <span class="free">q</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> tdfa_equiv_otdfa<span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="main">=</span> otdfa.τ"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> τ_def otdfa.τ_def
  <span class="keyword1"><span class="command">unfolding</span></span> otdfa_init_def otdfa_accept_def tdfa_otdfa_comp
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* k-valued TDFA *)</span>

<span class="keyword1"><span class="command">locale</span></span> kTDFA <span class="main">=</span> TDFA <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> Al <span class="main">×</span> <span class="tfree">'b</span> Al <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span> option"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">kv</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> kval<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">}</span> <span class="main">≤</span> <span class="free">kv</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_conv_nth'<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> size <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> size <span class="free">xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_conv_nth<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> nat_neq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_concat_replicate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>replicate <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* k-valued oTDFA *)</span>

<span class="keyword1"><span class="command">locale</span></span> koTDFA <span class="main">=</span> oTDFA <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="main">+</span> kTDFA <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">kv</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> Al <span class="main">×</span> <span class="tfree">'b</span> Al <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span> option"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">kv</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">us</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">us</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">us</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">vs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free">qf</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="free">qf</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">us</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> finite_C<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> kval
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">us</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>concat <span class="main">(</span>replicate <span class="bound">n</span> <span class="free">vs</span><span class="main">)</span><span class="main">,</span> <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> n
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> comp_transR<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> safe_hd_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
    safe_hd <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span> <span class="main">=</span> safe_hd <span class="main">(</span>concat <span class="main">(</span>replicate <span class="bound">n</span> <span class="free">vs</span><span class="main">)</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> Suc_pred append_Cons concat.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.inject replicate_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">us</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> concat <span class="main">(</span>replicate <span class="bound">n</span> <span class="free">vs</span><span class="main">)</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="free">qf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> comp_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> comp<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ safe_hd_concat<span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">@</span> concat <span class="main">(</span>replicate <span class="bound">n</span> <span class="free">vs</span><span class="main">)</span> <span class="main">@</span> <span class="free">vs'</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> τ_def C_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">bs</span> <span class="main">@</span> concat <span class="main">(</span>replicate <span class="bound">n</span> <span class="free">vs</span><span class="main">)</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_def f_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">length</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_concat_replicate<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">kv</span> <span class="main">=</span> card <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="main">{</span>Suc <span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>Suc <span class="free">kv</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_vimage_inj<span class="main">[</span><span class="operator">OF</span> inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span>Suc <span class="main">(</span>Suc <span class="free">kv</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span> inj
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_vimage_image_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> card_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_C<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> in_C
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> kval<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">@</span> <span class="free">us</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> C_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> state_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">us</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">us</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">us</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">vs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free">qf</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="free">qf</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">≤</span> card <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>length <span class="free">vs</span> <span class="main">≤</span> card <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_vs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">≥</span> Suc <span class="main">(</span>card <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vs_not_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> q_Q <span class="main">=</span> comp_closed<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> init_in_Q<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> qs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">vs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qs</span> <span class="main">!</span> length <span class="free">vs</span><span class="main">)</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">us</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">qs</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">vs</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="main">(</span><span class="skolem">qs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>safe_hd <span class="free">us</span><span class="main">,</span> Symb <span class="main">(</span><span class="free">vs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">qs</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_to_states<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> q_Q<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs''</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="keyword2"><span class="keyword">where</span></span> qs_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">=</span> <span class="skolem">qs''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q''</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qs_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">qs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> set_qs''<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">qs''</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qs_def<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qs_split<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> card_set_qs <span class="main">=</span> card_mono<span class="main">[</span><span class="operator">OF</span> finite_Q set_qs''<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs''</span> <span class="main">≥</span> Suc <span class="main">(</span>card <span class="main">(</span>set <span class="skolem">qs''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_set_qs len_vs qs_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qs_split<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">qs''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs''</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">qs''</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">qs''</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_conv_nth'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ij_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">qs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">qs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> qs_split nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> take_drop_i<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">i</span> <span class="free">vs</span> <span class="main">@</span> drop <span class="skolem">i</span> <span class="free">vs</span> <span class="main">=</span> <span class="free">vs</span>"</span></span>
    <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">i</span> <span class="free">vs</span><span class="main">)</span> <span class="main">@</span> drop <span class="skolem">j</span> <span class="free">vs</span> <span class="main">=</span> drop <span class="skolem">i</span> <span class="free">vs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ij_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">smt</span> append.assoc append_take_drop_id le_add_diff_inverse less_imp_le_nat same_append_eq
        take_add<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">qs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> min_vs_i_j_i<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="free">vs</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ij_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def qs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> comp_q_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">us</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>take <span class="skolem">i</span> <span class="free">vs</span><span class="main">,</span> drop <span class="skolem">i</span> <span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> states_to_comp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"take <span class="main"><span class="main">(</span></span>Suc <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">qs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ij_def qs_def<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> r_def<span class="main">)</span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> comp_init_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">us</span><span class="main">)</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> take <span class="skolem">i</span> <span class="free">vs</span><span class="main">,</span> drop <span class="skolem">i</span> <span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> comp_q_r<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_drop_i append.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> comp_r_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">us</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">i</span> <span class="free">vs</span><span class="main">)</span><span class="main">,</span> drop <span class="skolem">j</span> <span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> states_to_comp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"take <span class="main"><span class="main">(</span></span>Suc <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">j</span></span> <span class="main"><span class="main">-</span></span> <span class="skolem"><span class="skolem">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>drop <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">qs</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ij_def qs_def<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r_def qs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> min_vs_i_j_i<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> comp_r_q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">us</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>drop <span class="skolem">j</span> <span class="free">vs</span><span class="main">,</span> <span class="free">vs'</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comp_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> states_to_comp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"drop <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">qs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> qs_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ij_def qs_def<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r_def qs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> comp_r_qf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">us</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> drop <span class="skolem">j</span> <span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="free">qf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> comp_r_q' assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">j</span> <span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ij_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">using</span></span> loop<span class="main">[</span><span class="operator">OF</span> _ comp_r_r comp_r_qf assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> comp_init_r ij_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> append.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> take_drop_i qs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lin_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">us</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">vs</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="free">us</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">vs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free">qf</span> <span class="main">⟹</span>
  <span class="free">accept</span> <span class="free">qf</span> <span class="main">⟹</span> length <span class="free">vs</span> <span class="main">≤</span> <span class="main">(</span>length <span class="free">us</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> card <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> state_bounded<span class="main">[</span><span class="operator">OF</span> _ _ base<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">u</span> <span class="skolem">us'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">u</span> <span class="main">#</span> <span class="skolem">us'</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span><span class="skolem">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">r</span> <span class="main">(</span>Symb <span class="skolem">u</span><span class="main">,</span> safe_hd <span class="main">(</span><span class="skolem">cs'</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">us'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="free">qf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_outs<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> split'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">u</span> <span class="main">#</span> <span class="skolem">us'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span><span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> init_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="skolem">us'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span><span class="skolem">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> split'<span class="main">]</span> split<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> safe_hd_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step_TF_rev <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> comp_r_qf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">↝</span><span class="main">(</span><span class="main">(</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">us'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="free">qf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> _ split<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> _ refl<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">us'</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
      step_TF<span class="main">[</span><span class="operator">OF</span> _ base<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> state_bounded<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> split' comp_r_qf Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
      Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> init_ext split<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* longest common prefix of two words *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lcp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lcp</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lcp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lcp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free">lcp</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">len_lcp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">len_lcp</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">len_lcp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">len_lcp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="free">len_lcp</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> len_lcp<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lcp <span class="free">as</span> <span class="free">bs</span> <span class="main">=</span> length <span class="main">(</span>lcp <span class="free">as</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lcp.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lcp_le<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lcp <span class="free">as</span> <span class="free">bs</span> <span class="main">≤</span> length <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"len_lcp <span class="free">as</span> <span class="free">bs</span> <span class="main">≤</span> length <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> len_lcp.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lcp_drop_len_lcp<span class="main">:</span> <span class="quoted"><span class="quoted">"lcp <span class="free">as</span> <span class="free">bs</span> <span class="main">@</span> drop <span class="main">(</span>len_lcp <span class="free">as</span> <span class="free">bs</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> <span class="free">as</span>"</span></span>
  <span class="quoted"><span class="quoted">"lcp <span class="free">as</span> <span class="free">bs</span> <span class="main">@</span> drop <span class="main">(</span>len_lcp <span class="free">as</span> <span class="free">bs</span><span class="main">)</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lcp.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* distance of two words w.r.t. their longest common prefix *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lcp_dist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lcp_dist</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> len_lcp <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lcp_le_min<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lcp <span class="free">v1</span> <span class="free">v2</span> <span class="main">≤</span> min <span class="main">(</span>length <span class="free">v1</span><span class="main">)</span> <span class="main">(</span>length <span class="free">v2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lcp.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lcp_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lcp <span class="free">v1</span> <span class="free">v2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lcp_app_le_max<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lcp <span class="main">(</span><span class="free">v1</span> <span class="main">@</span> <span class="free">w1</span><span class="main">)</span> <span class="main">(</span><span class="free">v2</span> <span class="main">@</span> <span class="free">w2</span><span class="main">)</span> <span class="main">≤</span> len_lcp <span class="free">v1</span> <span class="free">v2</span> <span class="main">+</span> max <span class="main">(</span>length <span class="free">w1</span><span class="main">)</span> <span class="main">(</span>length <span class="free">w2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lcp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">v2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lcp_le_min trans_le_add1 max.coboundedI1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v</span> <span class="skolem">v1</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lcp_le_min trans_le_add2 max.coboundedI2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lcp_le_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lcp <span class="free">v1</span> <span class="free">v2</span> <span class="main">≤</span> length <span class="free">v1</span> <span class="main">+</span> length <span class="free">v2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcp_le_min trans_le_add1
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> lcp_le_app<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lcp <span class="free">v1</span> <span class="free">v2</span> <span class="main">≤</span> len_lcp <span class="main">(</span><span class="free">v1</span> <span class="main">@</span> <span class="free">w1</span><span class="main">)</span> <span class="main">(</span><span class="free">v2</span> <span class="main">@</span> <span class="free">w2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lcp.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lcp_dist <span class="free">as</span> <span class="main">[]</span> <span class="main">=</span> length <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"lcp_dist <span class="main">[]</span> <span class="free">bs</span> <span class="main">=</span> length <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lcp_dist_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lcp_dist_app_le_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"lcp_dist <span class="main">(</span><span class="free">v1</span> <span class="main">@</span> <span class="free">w1</span><span class="main">)</span> <span class="main">(</span><span class="free">v2</span> <span class="main">@</span> <span class="free">w2</span><span class="main">)</span> <span class="main">≤</span> lcp_dist <span class="free">v1</span> <span class="free">v2</span> <span class="main">+</span> length <span class="free">w1</span> <span class="main">+</span> length <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcp_le_app<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">w1</span></span> <span class="quoted"><span class="free">w2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lcp_dist_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lcp_app_le_max_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> len_lcp <span class="main">(</span><span class="free">v1</span> <span class="main">@</span> <span class="free">w1</span><span class="main">)</span> <span class="main">(</span><span class="free">v2</span> <span class="main">@</span> <span class="free">w2</span><span class="main">)</span> <span class="main">≤</span>
  <span class="numeral">2</span> <span class="main">*</span> len_lcp <span class="free">v1</span> <span class="free">v2</span> <span class="main">+</span> length <span class="free">w1</span> <span class="main">+</span> length <span class="free">w2</span> <span class="main">+</span>
  max <span class="main">(</span>length <span class="free">w1</span> <span class="main">-</span> length <span class="free">w2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">w2</span> <span class="main">-</span> length <span class="free">w1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcp_app_le_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">w1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">w2</span></span><span class="main">]</span> lcp_app_le_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">w2</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">w1</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lcp_dist_le_app_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"lcp_dist <span class="free">v1</span> <span class="free">v2</span> <span class="main">≤</span>
  lcp_dist <span class="main">(</span><span class="free">v1</span> <span class="main">@</span> <span class="free">w1</span><span class="main">)</span> <span class="main">(</span><span class="free">v2</span> <span class="main">@</span> <span class="free">w2</span><span class="main">)</span> <span class="main">+</span>
  max <span class="main">(</span>length <span class="free">w1</span> <span class="main">-</span> length <span class="free">w2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">w2</span> <span class="main">-</span> length <span class="free">w1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcp_app_le_max_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">w1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">w2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lcp_dist_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lcp_dist_same_pref<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lcp_dist <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="free">v1</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="free">v2</span><span class="main">)</span> <span class="main">=</span> lcp_dist <span class="free">v1</span> <span class="free">v2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lcp_dist_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"lcp_dist <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span> <span class="main">[</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"lcp_dist <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"lcp_dist <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">]</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Definition 3 *)</span>

<span class="keyword1"><span class="command">locale</span></span> NFT <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'b</span> list <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finite_δ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="free">q</span> <span class="free">a</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> init_in_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> δ_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="free">q</span> <span class="free">a</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">q'</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* q ↝(as, bs) q' iff the transducer has a computation from the state q
   to the state q' reading as and producing bs *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">computation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/</span><span class="keyword1">↝</span>_<span class="keyword3">/</span>_"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span>63<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  base<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main"><span class="free">↝</span></span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="main">|</span> step<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="main"><span class="free">↝</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main"><span class="free">↝</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span>"</span></span>

<span class="comment1">(* the language computed by the transducer *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">τ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">q</span><span class="main">}</span>"</span></span>

<span class="comment1">(* Definition 7 *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bv</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">u1</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">a2</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">.</span>
  lcp_dist <span class="bound">a1</span> <span class="bound">a2</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟶</span> lcp_dist <span class="bound">u1</span> <span class="bound">u2</span> <span class="main">≤</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Lemma 8 *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"bv <span class="free">R</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span> <span class="bound">b1</span> <span class="bound">b2</span> <span class="bound">u1</span> <span class="bound">u2</span><span class="main">.</span>
  <span class="main">(</span><span class="bound">a</span> <span class="main">@</span> <span class="bound">b1</span><span class="main">,</span> <span class="bound">u1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span> <span class="main">@</span> <span class="bound">b2</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> length <span class="bound">b1</span> <span class="main">+</span> length <span class="bound">b2</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟶</span> lcp_dist <span class="bound">u1</span> <span class="bound">u2</span> <span class="main">≤</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> bv<span class="main">:</span> <span class="quoted"><span class="quoted">"bv <span class="free">R</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span> <span class="bound">b1</span> <span class="bound">b2</span> <span class="bound">u1</span> <span class="bound">u2</span><span class="main">.</span>
    <span class="main">(</span><span class="bound">a</span> <span class="main">@</span> <span class="bound">b1</span><span class="main">,</span> <span class="bound">u1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span> <span class="main">@</span> <span class="bound">b2</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> length <span class="bound">b1</span> <span class="main">+</span> length <span class="bound">b2</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟶</span> lcp_dist <span class="bound">u1</span> <span class="bound">u2</span> <span class="main">≤</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">u1</span><span class="main">,</span> <span class="skolem">u2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span>
      lcp_dist <span class="skolem">a1</span> <span class="skolem">u1</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">⟹</span> lcp_dist <span class="skolem">a2</span> <span class="skolem">u2</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a1</span> <span class="skolem">a2</span> <span class="skolem">u1</span> <span class="skolem">u2</span>
      <span class="keyword1"><span class="command">using</span></span> bv
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">@</span> <span class="skolem">b1</span><span class="main">,</span> <span class="skolem">u1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">@</span> <span class="skolem">b2</span><span class="main">,</span> <span class="skolem">u2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> length <span class="skolem">b1</span> <span class="main">+</span> length <span class="skolem">b2</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">⟹</span>
      lcp_dist <span class="skolem">b1</span> <span class="skolem">b2</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b1</span> <span class="skolem">b2</span> <span class="skolem">u1</span> <span class="skolem">u2</span>
      <span class="keyword1"><span class="command">using</span></span> lcp_dist_app_le_sum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="skolem">b1</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="skolem">b2</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span> <span class="bound">b1</span> <span class="bound">b2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">u1</span> <span class="bound">u2</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">a</span> <span class="main">@</span> <span class="bound">b1</span><span class="main">,</span> <span class="bound">u1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span> <span class="main">@</span> <span class="bound">b2</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> length <span class="bound">b1</span> <span class="main">+</span> length <span class="bound">b2</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">⟶</span> lcp_dist <span class="bound">u1</span> <span class="bound">u2</span> <span class="main">≤</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="main">]</span></span> t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> bv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span> <span class="bound">b1</span> <span class="bound">b2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">u1</span> <span class="bound">u2</span><span class="main">.</span>
    <span class="main">(</span><span class="bound">a</span> <span class="main">@</span> <span class="bound">b1</span><span class="main">,</span> <span class="bound">u1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span> <span class="main">@</span> <span class="bound">b2</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> length <span class="bound">b1</span> <span class="main">+</span> length <span class="bound">b2</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟶</span> lcp_dist <span class="bound">u1</span> <span class="bound">u2</span> <span class="main">≤</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bv <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bv_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">@</span> <span class="skolem">b1</span><span class="main">,</span> <span class="skolem">u1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">@</span> <span class="skolem">b2</span><span class="main">,</span> <span class="skolem">u2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span>
      length <span class="skolem">b1</span> <span class="main">+</span> length <span class="skolem">b2</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">⟹</span> lcp_dist <span class="skolem">u1</span> <span class="skolem">u2</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b1</span> <span class="skolem">u1</span> <span class="skolem">b2</span> <span class="skolem">u2</span>
      <span class="keyword1"><span class="command">using</span></span> bv'
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lcp_dist <span class="skolem">a2</span> <span class="skolem">u2</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u1</span><span class="main">,</span> <span class="skolem">u2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"lcp_dist <span class="skolem">a1</span> <span class="skolem">u1</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a1</span> <span class="skolem">a2</span> <span class="skolem">u1</span> <span class="skolem">u2</span>
      <span class="keyword1"><span class="command">using</span></span> t_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lcp <span class="skolem">a1</span> <span class="skolem">u1</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>len_lcp <span class="skolem">a1</span> <span class="skolem">u1</span><span class="main">)</span> <span class="skolem">a1</span>"</span></span> <span class="quoted"><span class="skolem">a2</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>len_lcp <span class="skolem">a1</span> <span class="skolem">u1</span><span class="main">)</span> <span class="skolem">u1</span>"</span></span> <span class="quoted"><span class="skolem">u2</span></span><span class="main">]</span> that
        len_lcp_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a1</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u1</span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lcp_drop_len_lcp lcp_dist_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">u1</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">.</span> lcp_dist <span class="bound">a1</span> <span class="bound">u1</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">⟶</span> lcp_dist <span class="bound">a2</span> <span class="bound">u2</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Definition 9 *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bvT</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q1</span> <span class="bound">q2</span> <span class="bound">f1</span> <span class="bound">f2</span> <span class="bound">a</span> <span class="bound">b1</span> <span class="bound">b2</span> <span class="bound">u</span> <span class="bound">v1</span> <span class="bound">v2</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span>
  <span class="bound">q1</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">q2</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">f1</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">f2</span> <span class="main">∧</span>
  <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">u</span> <span class="main">@</span> <span class="bound">v1</span><span class="main">)</span> <span class="bound">q1</span> <span class="main">∧</span> <span class="bound">q1</span> <span class="main">↝</span><span class="main">(</span><span class="bound">b1</span><span class="main">,</span> <span class="bound">w1</span><span class="main">)</span> <span class="bound">f1</span> <span class="main">∧</span>
  <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">u</span> <span class="main">@</span> <span class="bound">v2</span><span class="main">)</span> <span class="bound">q2</span> <span class="main">∧</span> <span class="bound">q2</span> <span class="main">↝</span><span class="main">(</span><span class="bound">b2</span><span class="main">,</span> <span class="bound">w2</span><span class="main">)</span> <span class="bound">f2</span> <span class="main">∧</span>
  length <span class="bound">b1</span> <span class="main">+</span> length <span class="bound">b2</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟶</span> lcp_dist <span class="main">(</span><span class="bound">v1</span> <span class="main">@</span> <span class="bound">w1</span><span class="main">)</span> <span class="main">(</span><span class="bound">v2</span> <span class="main">@</span> <span class="bound">w2</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">active</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">active</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q'</span> <span class="bound">as</span> <span class="bound">bs'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">↝</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">@</span> <span class="bound">bs'</span><span class="main">)</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">q'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bounded</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">q</span> <span class="bound">q'</span> <span class="bound">u</span> <span class="bound">v</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span> <span class="main">@</span> <span class="bound">v'</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">[]</span> <span class="main">∧</span>
  <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">q'</span> <span class="main">∧</span> active <span class="bound">q'</span> <span class="bound">v'</span> <span class="main">⟶</span> length <span class="bound">v'</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="comment1">(* Definition 11 *)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounded_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="free">t</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q1</span> <span class="bound">q2</span> <span class="bound">f1</span> <span class="bound">f2</span> <span class="bound">a</span> <span class="bound">b1</span> <span class="bound">b2</span> <span class="bound">u</span> <span class="bound">v</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span>
  <span class="bound">q1</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">q2</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">f1</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">f2</span> <span class="main">∧</span>
  <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">u</span> <span class="main">@</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">q1</span> <span class="main">∧</span> <span class="bound">q1</span> <span class="main">↝</span><span class="main">(</span><span class="bound">b1</span><span class="main">,</span> <span class="bound">w1</span><span class="main">)</span> <span class="bound">f1</span> <span class="main">∧</span>
  <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="bound">q2</span> <span class="main">∧</span> <span class="bound">q2</span> <span class="main">↝</span><span class="main">(</span><span class="bound">b2</span><span class="main">,</span> <span class="bound">v</span> <span class="main">@</span> <span class="bound">w2</span><span class="main">)</span> <span class="bound">f2</span> <span class="main">⟶</span> length <span class="bound">v</span> <span class="main">≤</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_def active_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">as</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> one_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free">q</span> <span class="free">a</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> computation.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> step_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="free">q</span> <span class="free">a</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> computation.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q'</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q''</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> computation_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="free">q'</span> <span class="free">a</span> <span class="main">(</span><span class="free">q''</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free">q'</span> <span class="free">a</span> <span class="main">(</span><span class="free">q''</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">↝</span><span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> computation_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">,</span> <span class="free">bs''</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">q''</span> <span class="bound">bs</span> <span class="bound">bs'</span><span class="main">.</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="bound">q''</span> <span class="main">∧</span> <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="bound">bs'</span><span class="main">)</span> <span class="free">q'</span> <span class="main">∧</span> <span class="free">bs''</span> <span class="main">=</span> <span class="bound">bs</span> <span class="main">@</span> <span class="bound">bs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">,</span> <span class="free">bs''</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">as'</span></span> <span class="quoted"><span class="free">bs''</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">q'</span> <span class="skolem">bs</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">asa</span> <span class="skolem">bs'</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> step<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">as'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_rev_induct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="free">P</span> <span class="bound">q</span> <span class="main">[]</span> <span class="main">[]</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">q</span> <span class="bound">a</span> <span class="bound">q'</span> <span class="bound">bs</span> <span class="bound">as</span> <span class="bound">bs'</span> <span class="bound">q''</span><span class="main">.</span> <span class="free">P</span> <span class="bound">q</span> <span class="bound">as</span> <span class="bound">bs</span> <span class="bound">q''</span> <span class="main">⟹</span> <span class="bound">q</span><span class="main">↝</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="bound">q''</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="bound">q''</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">bs'</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">P</span> <span class="bound">q</span> <span class="main">(</span><span class="bound">as</span> <span class="main">@</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">bs</span> <span class="main">@</span> <span class="bound">bs'</span><span class="main">)</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">P</span> <span class="free">q</span> <span class="free">as</span> <span class="free">bs</span> <span class="free">q'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> no_step
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">↝</span><span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="skolem">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> computation_split<span class="main">[</span><span class="operator">OF</span> snoc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> P_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">q</span> <span class="skolem">xs</span> <span class="skolem">cs</span> <span class="skolem">q''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snoc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> P_xs split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> step_dest<span class="main"><span class="main">[</span></span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">q'</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> δ_closed<span class="main">)</span>

<span class="comment1">(* computation relation tracking all intermediate steps in a computation *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">computation_ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
    <span class="main">(</span><span class="quoted">"_<span class="keyword3">/</span><span class="keyword1">↝e</span>_<span class="keyword3">/</span>_"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span>63<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  base_ext<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1"><span class="free">↝e</span></span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="main">|</span> step_ext<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="keyword1"><span class="free">↝e</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1"><span class="free">↝e</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q''</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> computation_ext_no_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> computation_ext.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> computation_ext_Cons_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="keyword1">↝e</span><span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as'</span><span class="main">,</span> <span class="free">qb</span> <span class="main">#</span> <span class="free">qbs'</span><span class="main">)</span><span class="free">q'</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="free">q</span> <span class="free">a</span> <span class="free">qb</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> computation_ext.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> computation_ext_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q'</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">qs'</span><span class="main">)</span> <span class="free">q''</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">,</span> <span class="free">qs</span> <span class="main">@</span> <span class="free">qs'</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation_ext.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> computation_ext_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> length <span class="free">qs</span> <span class="main">=</span> length <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation_ext.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> computation_ext_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> concat <span class="main">(</span>map snd <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation_ext.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> computation_ext_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">qs</span><span class="main">.</span> <span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="bound">qs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> concat <span class="main">(</span>map snd <span class="bound">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> computation_ext_split<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> length <span class="free">qbs</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> <span class="free">as'</span><span class="main">,</span> <span class="free">qbs</span> <span class="main">@</span> <span class="main">(</span><span class="free">q''</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">#</span> <span class="free">qbs'</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">qbs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">q''</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">q''</span> <span class="main">∧</span> <span class="free">q''</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">qbs'</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">qbs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> computation_ext.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> computation_ext_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation_ext.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> δ_closed<span class="main">)</span>

<span class="comment1">(* Definition 6 *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all_trans</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Q</span> <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">output_speed</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">output_speed</span> <span class="main">=</span> Max <span class="main">(</span>length <span class="main">`</span> snd <span class="main">`</span> all_trans <span class="main">∪</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_trans_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite all_trans"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fin_Q_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">Q</span> <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"all_trans <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">Q</span> <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> all_trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">Q</span> <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fin_Q_UNIV finite_δ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> infinite_super <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_trans_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="free">q</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> all_trans"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> all_trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> output_speed_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="free">q</span> <span class="free">a</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> length <span class="free">bs</span> <span class="main">≤</span> output_speed"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> output_speed_def <span class="keyword1"><span class="command">using</span></span> all_trans_finite all_trans_step
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_ge UnCI finite.emptyI finite.insertI finite_UnI finite_imageI image_eqI snd_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> output_speed_computation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span>
  length <span class="free">bs</span> <span class="main">≤</span> length <span class="free">as</span> <span class="main">*</span> output_speed"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> output_speed_step δ_closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_le_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> output_speed_ext_computation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qbs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">q''</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">qbs</span> <span class="main">⟹</span>
  length <span class="free">bs</span> <span class="main">≤</span> output_speed"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qbs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">qbs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation_ext.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> output_speed_step δ_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> output_speed_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"output_speed <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>length <span class="main">`</span> snd <span class="main">`</span> all_trans <span class="main">∪</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_trans_finite
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_ge<span class="main">[</span><span class="operator">OF</span> fin<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> output_speed_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> computation_split_out<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as''</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">q''</span> <span class="bound">as</span> <span class="bound">as'</span> <span class="bound">cs</span> <span class="bound">cs'</span><span class="main">.</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">cs</span><span class="main">)</span> <span class="bound">q''</span> <span class="main">∧</span> <span class="bound">q''</span> <span class="main">↝</span><span class="main">(</span><span class="bound">as'</span><span class="main">,</span> <span class="bound">cs'</span><span class="main">)</span> <span class="free">q'</span> <span class="main">∧</span> <span class="free">as''</span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> <span class="bound">as'</span> <span class="main">∧</span>
    <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span> <span class="main">=</span> <span class="bound">cs</span> <span class="main">@</span> <span class="bound">cs'</span> <span class="main">∧</span> length <span class="bound">cs</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">∧</span> length <span class="free">bs</span> <span class="main">-</span> length <span class="bound">cs</span> <span class="main">≤</span> output_speed"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as''</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as''</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">bs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">q'</span> <span class="skolem">bsa</span> <span class="skolem">as</span> <span class="skolem">bsa'</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> step<span class="main">(</span>1<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> length_bsa<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bsa</span> <span class="main">≤</span> output_speed"</span></span>
    <span class="keyword1"><span class="command">using</span></span> output_speed_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bsa</span> <span class="main">≤</span> length <span class="skolem">bs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> step<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bsa''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">bsa</span> <span class="main">@</span> <span class="skolem">bsa''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_append_conv_if append_eq_conv_conj<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> step<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">bsa''</span></span> <span class="quoted"><span class="skolem">bs'</span></span><span class="main">]</span> δ_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> step length_bsa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="skolem">q</span> <span class="main">∧</span> <span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">,</span> <span class="skolem">bsa</span> <span class="main">@</span> <span class="skolem">bsa'</span><span class="main">)</span><span class="skolem">q''</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∧</span>
      <span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">bs'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">bsa</span> <span class="main">@</span> <span class="skolem">bsa'</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">[]</span> <span class="main">≤</span> length <span class="skolem">bs</span> <span class="main">∧</span> length <span class="skolem">bs</span> <span class="main">-</span> length <span class="main">[]</span> <span class="main">≤</span> output_speed"</span></span>
      <span class="keyword1"><span class="command">using</span></span> computation.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> computation_ext_rem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qbs'</span> <span class="main">@</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">#</span> <span class="free">qbs''</span> <span class="main">@</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span> <span class="main">#</span> <span class="free">qbs'''</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cs'</span> <span class="bound">cs''</span> <span class="bound">cs'''</span> <span class="bound">c'</span> <span class="bound">c''</span> <span class="bound">ds'</span> <span class="bound">bs'''</span><span class="main">.</span>
    <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="bound">cs'</span> <span class="main">@</span> <span class="bound">c'</span> <span class="main">#</span> <span class="bound">cs'''</span><span class="main">,</span> <span class="bound">ds'</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">@</span> <span class="bound">bs'''</span><span class="main">)</span> <span class="free">q''</span> <span class="main">∧</span>
    <span class="bound">ds'</span> <span class="main">=</span> concat <span class="main">(</span>map snd <span class="free">qbs'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">bs'''</span> <span class="main">=</span> concat <span class="main">(</span>map snd <span class="free">qbs'''</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free">as</span> <span class="main">=</span> <span class="bound">cs'</span> <span class="main">@</span> <span class="bound">c'</span> <span class="main">#</span> <span class="bound">cs''</span> <span class="main">@</span> <span class="bound">c''</span> <span class="main">#</span> <span class="bound">cs'''</span> <span class="main">∧</span> length <span class="bound">cs'</span> <span class="main">=</span> length <span class="free">qbs'</span> <span class="main">∧</span>
    length <span class="bound">cs''</span> <span class="main">=</span> length <span class="free">qbs''</span> <span class="main">∧</span> length <span class="bound">cs'''</span> <span class="main">=</span> length <span class="free">qbs'''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> len_as <span class="main">=</span> computation_ext_length<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as'</span></span> <span class="skolem"><span class="skolem">as''</span></span> <span class="skolem"><span class="skolem">as'''</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    decomp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">as''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">as'''</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as'</span> <span class="main">=</span> length <span class="free">qbs'</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">as''</span> <span class="main">=</span> length <span class="free">qbs''</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as'''</span> <span class="main">=</span> length <span class="free">qbs'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app_decomp<span class="main">[</span><span class="operator">OF</span> len_as<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> app_decomp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">qbs''</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">qbs'''</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span>
        app_decomp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">qbs''</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">qbs'''</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span>
        app_decomp<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">qbs'''</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span>
        singleton_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="skolem">as'</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">as'''</span><span class="main">,</span>
    <span class="free">qbs'</span> <span class="main">@</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">#</span> <span class="free">qbs''</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">qbs'''</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> decomp'<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">,</span> <span class="free">qbs'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span><span class="keyword1">↝e</span><span class="main">(</span><span class="skolem">as''</span> <span class="main">@</span> <span class="skolem">a'</span> <span class="main">#</span> <span class="skolem">as'''</span><span class="main">,</span>
    <span class="free">qbs''</span> <span class="main">@</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span> <span class="main">#</span> <span class="free">qbs'''</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> computation_ext_split<span class="main">[</span><span class="operator">OF</span> decomp'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assoc<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> split'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="skolem">as'''</span><span class="main">,</span> <span class="free">qbs'''</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> computation_ext_split<span class="main">[</span><span class="operator">OF</span> decomp'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ds'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ds'</span> <span class="main">=</span> concat <span class="main">(</span>map snd <span class="free">qbs'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bs'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'''</span> <span class="main">=</span> concat <span class="main">(</span>map snd <span class="free">qbs'''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ds'</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> computation_ext_sound<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ds'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">↝</span><span class="main">(</span><span class="skolem">as'''</span><span class="main">,</span> <span class="skolem">bs'''</span><span class="main">)</span> <span class="free">q''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> computation_ext_sound<span class="main">[</span><span class="operator">OF</span> split'<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bs'''_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> trans trans'<span class="main">]</span> decomp'<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ds'_def bs'''_def decomp'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> computation_long_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> length <span class="free">as</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">+</span> card <span class="free">Q</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">as'</span> <span class="bound">bs'</span><span class="main">.</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="bound">as'</span><span class="main">,</span> <span class="bound">bs'</span><span class="main">)</span> <span class="free">q'</span> <span class="main">∧</span> length <span class="bound">as'</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qbs</span></span> <span class="keyword2"><span class="keyword">where</span></span> qbs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">↝e</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="skolem">qbs</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> concat <span class="main">(</span>map snd <span class="skolem">qbs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> computation_ext_complete<span class="main">[</span><span class="operator">OF</span> assms_comp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qbs_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qbs</span> <span class="main">=</span> length <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> computation_ext_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> assms_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">+</span> card <span class="free">Q</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">=</span> map fst <span class="skolem">qbs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> qs_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">qs</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> computation_ext_closed<span class="main">[</span><span class="operator">OF</span> qbs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms_comp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> not_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>distinct <span class="skolem">qs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>distinct <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">qs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> card_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="skolem">qs</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">+</span> card <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_card<span class="main">[</span><span class="operator">OF</span> contr<span class="main">]</span> assms_len
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs_def qbs_len<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_qs card_mono<span class="main">[</span><span class="operator">OF</span> finite_Q qs_sub<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="skolem"><span class="skolem">qs''</span></span> <span class="skolem"><span class="skolem">qs'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">=</span> <span class="skolem">qs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q''</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">qs''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q''</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">qs'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_distinct_decomp<span class="main">[</span><span class="operator">OF</span> not_distinct<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qbs'</span></span> <span class="skolem"><span class="skolem">qbs''</span></span> <span class="skolem"><span class="skolem">qbs'''</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">bs'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qbs</span> <span class="main">=</span> <span class="skolem">qbs'</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">q''</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">qbs''</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">q''</span><span class="main">,</span> <span class="skolem">bs'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">qbs'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_ext<span class="main">[</span><span class="operator">of</span> <span class="quoted">fst</span> <span class="quoted"><span class="skolem">qbs</span></span> <span class="quoted"><span class="skolem">qs'</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">q''</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">qs''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q''</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">qs'''</span>"</span></span><span class="main">]</span>
          map_ext<span class="main">[</span><span class="operator">of</span> <span class="quoted">fst</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">q''</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">qs'''</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as'</span> <span class="bound">bs'</span><span class="main">.</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="bound">as'</span><span class="main">,</span> <span class="bound">bs'</span><span class="main">)</span> <span class="free">q'</span> <span class="main">∧</span> length <span class="bound">as'</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> computation_ext_rem<span class="main">[</span><span class="operator">OF</span> qbs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> decomp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">as'</span> <span class="bound">bs'</span><span class="main">.</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="bound">as'</span><span class="main">,</span> <span class="bound">bs'</span><span class="main">)</span> <span class="free">q'</span> <span class="main">∧</span> length <span class="bound">as'</span> <span class="main">≤</span> card <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">as</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">≤</span> card <span class="free">Q</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as'</span></span> <span class="skolem"><span class="skolem">bs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> nex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="skolem">bs'</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as'</span> <span class="main">&lt;</span> length <span class="skolem">as</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> computation_long_split<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pumping<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span>iter_concat <span class="free">n</span> <span class="free">as</span><span class="main">,</span> iter_concat <span class="free">n</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> comp_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> active_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="free">q'</span> <span class="free">bs</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> active <span class="free">q</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_trans
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> active_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> active_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="free">q</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span> <span class="main">⟹</span> active <span class="free">q</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> active_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> active_extend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> active <span class="free">q'</span> <span class="free">bs</span> <span class="main">⟹</span> active <span class="free">q</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> active_def <span class="keyword1"><span class="command">using</span></span> comp_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> active_Nil_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="free">q</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">as</span> <span class="bound">bs'</span> <span class="bound">q'</span><span class="main">.</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs'</span><span class="main">)</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">q'</span> <span class="main">∧</span> length <span class="bound">as</span> <span class="main">≤</span> card <span class="free">Q</span> <span class="main">∧</span>
    length <span class="bound">bs'</span> <span class="main">≤</span> card <span class="free">Q</span> <span class="main">*</span> output_speed"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_norm output_speed_computation
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> active_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.trans mult_le_mono1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* Definition 5; note that a state q is useful iff active q [] holds *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sg</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sg</span> <span class="main">=</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> Inf <span class="main">(</span>length <span class="main">`</span> <span class="main">{</span><span class="bound">as</span><span class="main">.</span> <span class="main">∃</span><span class="bound">bs</span> <span class="bound">q'</span><span class="main">.</span> <span class="bound">q</span> <span class="main">↝</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">q'</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span>
    <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> active <span class="bound">q</span> <span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sg_le_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"active <span class="free">init</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sg <span class="main">≤</span> card <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">q</span></span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> active <span class="bound">q</span> <span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Q'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">Q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Q assms<span class="main">(</span>1<span class="main">)</span> init_in_Q
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> active_def Q'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="skolem">Q'</span> <span class="main">⟹</span> Inf <span class="main">(</span>length <span class="main">`</span> <span class="main">{</span><span class="bound">as</span><span class="main">.</span> <span class="main">∃</span><span class="bound">bs</span> <span class="bound">q'</span><span class="main">.</span> <span class="bound">q</span><span class="main">↝</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="bound">q'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">q'</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> in_Q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">Q'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> wit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span><span class="skolem">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="skolem">q'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">≤</span> card <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> active_Nil_dest
      <span class="keyword1"><span class="command">unfolding</span></span> Q'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_as_in<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">∈</span> length <span class="main">`</span> <span class="main">{</span><span class="bound">as</span><span class="main">.</span> <span class="main">∃</span><span class="bound">bs</span> <span class="bound">q'</span><span class="main">.</span> <span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="bound">q'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">q'</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span>length <span class="main">`</span> <span class="main">{</span><span class="bound">as</span><span class="main">.</span> <span class="main">∃</span><span class="bound">bs</span> <span class="bound">q'</span><span class="main">.</span> <span class="skolem">q</span><span class="main">↝</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="bound">q'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">q'</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> le_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cInf_lower<span class="main"><span class="main">[</span></span><span class="operator">OF</span> len_as_in<span class="main"><span class="main">]</span></span> wit<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Q'_props
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sg_def Q'_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> active_Nil_dest_sg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"active <span class="free">q</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as</span> <span class="bound">bs'</span> <span class="bound">q'</span><span class="main">.</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs'</span><span class="main">)</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">q'</span> <span class="main">∧</span> length <span class="bound">as</span> <span class="main">≤</span> sg <span class="main">∧</span>
    length <span class="bound">bs'</span> <span class="main">≤</span> sg <span class="main">*</span> output_speed"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ass</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ass</span> <span class="main">=</span> length <span class="main">`</span> <span class="main">{</span><span class="bound">as</span><span class="main">.</span> <span class="main">∃</span><span class="bound">bs</span> <span class="bound">q'</span><span class="main">.</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">q'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ass</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ass_def active_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="skolem">ass</span> <span class="main">∈</span> <span class="skolem">ass</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Inf_nat_def1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> wit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="skolem">q'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> Inf <span class="skolem">ass</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ass_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="skolem">ass</span> <span class="main">≤</span> sg"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms finite_Q
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ass_def sg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> output_speed_computation<span class="main">[</span><span class="operator">OF</span> wit<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute order_subst1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">as</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">bs</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">q'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> active_dest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"active <span class="free">q</span> <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as</span> <span class="bound">bs'</span> <span class="bound">q'</span><span class="main">.</span> <span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="bound">bs'</span><span class="main">)</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">q'</span> <span class="main">∧</span>
    length <span class="bound">bs'</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> sg<span class="main">)</span> <span class="main">*</span> output_speed"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs'</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="skolem">bs'</span><span class="main">)</span> <span class="skolem">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="skolem">q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> active_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs'</span> <span class="main">≥</span> output_speed"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">@</span> <span class="skolem">bs'</span> <span class="main">=</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> take output_speed <span class="skolem">bs'</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>drop output_speed <span class="skolem">bs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="skolem"><span class="skolem">as'</span></span> <span class="skolem"><span class="skolem">as''</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">↝</span><span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span><span class="skolem">q''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span><span class="main">↝</span><span class="main">(</span><span class="skolem">as''</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span><span class="skolem">q'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="skolem">as'</span> <span class="main">@</span> <span class="skolem">as''</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">bs</span> <span class="main">@</span> take output_speed <span class="skolem">bs'</span><span class="main">)</span> <span class="main">@</span> drop output_speed <span class="skolem">bs'</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span>
      <span class="quoted"><span class="quoted">"length <span class="skolem">cs</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> take output_speed <span class="skolem">bs'</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> take output_speed <span class="skolem">bs'</span><span class="main">)</span> <span class="main">-</span> length <span class="skolem">cs</span> <span class="main">≤</span> output_speed"</span></span>
      <span class="keyword1"><span class="command">using</span></span> computation_split_out<span class="main">[</span><span class="operator">OF</span> act<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> app<span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="free">bs</span> <span class="main">@</span> <span class="skolem">ds</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ds</span> <span class="main">≤</span> output_speed"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> True split_app<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> app<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">note</span></span> q''_Q <span class="main">=</span> comp_closed<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> act_q''<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="skolem">q''</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>2<span class="main">)</span> act<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> active_def<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="skolem"><span class="skolem">q'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> es_fs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span><span class="main">↝</span><span class="main">(</span><span class="skolem">es</span><span class="main">,</span> <span class="skolem">fs</span><span class="main">)</span><span class="skolem">q'''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="skolem">q'''</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">≤</span> sg"</span></span>
      <span class="keyword1"><span class="command">using</span></span> active_Nil_dest_sg<span class="main">[</span><span class="operator">OF</span> act_q'' q''_Q<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> fs_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">fs</span> <span class="main">≤</span> sg <span class="main">*</span> output_speed"</span></span>
      <span class="keyword1"><span class="command">using</span></span> output_speed_computation<span class="main">[</span><span class="operator">OF</span> es_fs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> q''_Q<span class="main">]</span> es_fs_def<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.trans mult_le_mono1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> comp_trans<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ds_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> es_fs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> ds_def<span class="main">(</span>2<span class="main">)</span> fs_len es_fs_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bounded_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">≤</span> <span class="free">K'</span> <span class="main">⟹</span> bounded <span class="free">K</span> <span class="main">⟹</span> bounded <span class="free">K'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounded_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="free">K</span> <span class="main">⟹</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span> <span class="main">@</span> <span class="free">v'</span><span class="main">)</span> <span class="free">q</span> <span class="main">⟹</span> active <span class="free">q</span> <span class="main">[]</span> <span class="main">⟹</span>
  <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> active <span class="free">q'</span> <span class="free">v'</span> <span class="main">⟹</span> length <span class="free">v'</span> <span class="main">≤</span> <span class="free">K</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_closed<span class="main">[</span><span class="operator">OF</span> _ init_in_Q<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounded_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* NFT with bounded trailing with trailing bound t *)</span>

<span class="keyword1"><span class="command">locale</span></span> bNFT <span class="main">=</span> NFT <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">::</span> finite<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">assumes</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> bounded' <span class="main">=</span> bounded_dest<span class="main">[</span><span class="operator">OF</span> bounded<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Definition 4; k-valued NFT *)</span>

<span class="keyword1"><span class="command">locale</span></span> kNFT <span class="main">=</span> NFT <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'b</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">kv</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">assumes</span></span> kval<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">}</span> <span class="main">≤</span> <span class="free">kv</span>"</span></span>

<span class="comment1">(* Definition 4; functional NFT *)</span>

<span class="keyword1"><span class="command">locale</span></span> fNFT <span class="main">=</span> NFT <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'b</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> functional<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> τ <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y'</span><span class="main">)</span> <span class="main">∈</span> τ <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> one_valued<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">}</span> <span class="main">∧</span> card <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">}</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">}</span> <span class="main">∧</span> card <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">}</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> bs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> τ"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∈</span> τ<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">bs</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> functional<span class="main">[</span><span class="operator">OF</span> bs_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> kNFT <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="main">1</span></span>
  <span class="keyword1"><span class="command">using</span></span> one_valued
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* unambiguous NFT *)</span>

<span class="keyword1"><span class="command">locale</span></span> uNFT <span class="main">=</span> NFT <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'b</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> unambiguous<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="keyword1">↝e</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qbs</span><span class="main">)</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">accept</span> <span class="free">f</span> <span class="main">⟹</span>
  <span class="free">init</span> <span class="keyword1">↝e</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qbs'</span><span class="main">)</span> <span class="free">f'</span> <span class="main">⟹</span> <span class="free">accept</span> <span class="free">f'</span> <span class="main">⟹</span> <span class="free">qbs</span> <span class="main">=</span> <span class="free">qbs'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> functional<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">∈</span> τ <span class="main">⟹</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span> <span class="main">∈</span> τ <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">bs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unambiguous
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> τ_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> computation_ext_complete<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> fNFT <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">Q</span></span>
  <span class="keyword1"><span class="command">using</span></span> functional
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">assumption</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>