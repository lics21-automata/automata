<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Undecidable</title>
</head>


<body>
<div class="head">
<h1>Theory Undecidable</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Undecidable
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Computation.html">Computation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> TCell <span class="main">=</span> Head <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Al"</span></span> <span class="main">|</span> Just <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> Move <span class="main">=</span> Left <span class="main">|</span> Right

<span class="keyword1"><span class="command">instantiation</span></span> Al <span class="main">::</span> <span class="main">(</span><span class="quoted">finite</span><span class="main">)</span> <span class="quoted">finite</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite Al set<span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>Blank<span class="main">}</span> <span class="main">∪</span> Symb <span class="main">`</span> UNIV"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite Al set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> TCell <span class="main">::</span> <span class="main">(</span><span class="quoted">finite</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">finite</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite set<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'s</span> <span class="main">::</span> finite set<span class="main">)</span> <span class="main">×</span>
    <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span> Al set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'s</span> <span class="main">::</span> finite<span class="main">)</span> TCell set<span class="main">)</span> <span class="main">⊆</span>
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> Head <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNIV <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">∪</span> Just <span class="main">`</span> UNIV"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'s</span> <span class="main">::</span> finite<span class="main">)</span> TCell set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Cell <span class="main">=</span> Conf <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> TCell"</span></span> <span class="main">|</span> Sep <span class="main">|</span> End_Copy <span class="main">|</span> End_Sim

<span class="keyword1"><span class="command">instantiation</span></span> Cell <span class="main">::</span> <span class="main">(</span><span class="quoted">finite</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">finite</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'s</span> <span class="main">::</span> finite<span class="main">)</span> TCell set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'s</span> <span class="main">::</span> finite<span class="main">)</span> Cell set<span class="main">)</span> <span class="main">⊆</span>
    Conf <span class="main">`</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'s</span> <span class="main">::</span> finite<span class="main">)</span> TCell set<span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Sep<span class="main">,</span> End_Copy<span class="main">,</span> End_Sim<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'s</span> <span class="main">::</span> finite<span class="main">)</span> Cell set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> NState <span class="main">=</span> Init <span class="main">|</span> Accept <span class="main">|</span> Copy <span class="main">|</span> PreStep <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option"</span></span> <span class="main">|</span> PostStep <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> option"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> NState <span class="main">::</span> <span class="main">(</span><span class="quoted">finite</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">finite</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite set<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'s</span> <span class="main">::</span> finite set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'s</span> <span class="main">::</span> finite<span class="main">)</span> NState set<span class="main">)</span> <span class="main">⊆</span>
    <span class="main">{</span>Init<span class="main">,</span> Accept<span class="main">,</span> Copy<span class="main">,</span> PreStep None<span class="main">}</span> <span class="main">∪</span>
    PreStep <span class="main">`</span> Some <span class="main">`</span> UNIV <span class="main">∪</span> PostStep <span class="main">`</span> UNIV"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'s</span> <span class="main">::</span> finite<span class="main">)</span> NState set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Definition 18 *)</span>

<span class="keyword1"><span class="command">locale</span></span> TM <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">::</span> finite"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> finite Al <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> Move<span class="main">)</span> option"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">TM_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> TCell list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> TCell list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">accept</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> Left<span class="main">)</span> <span class="main">⟹</span> <span class="free">TM_step</span> <span class="main">(</span>Head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span> <span class="main">#</span> map Just <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">[</span>Head <span class="free"><span class="bound"><span class="entity">s'</span></span></span> Blank<span class="main">,</span> Just <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">]</span> <span class="main">@</span> map Just <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">accept</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> Right<span class="main">)</span> <span class="main">⟹</span> <span class="free">TM_step</span> <span class="main">(</span>map Just <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">@</span> <span class="main">[</span>Head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">]</span><span class="main">)</span>
    <span class="main">(</span>map Just <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">@</span> <span class="main">[</span>Just <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> Head <span class="free"><span class="bound"><span class="entity">s'</span></span></span> Blank<span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">accept</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> Left<span class="main">)</span> <span class="main">⟹</span>
    <span class="free">TM_step</span> <span class="main">(</span>map Just <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">@</span> <span class="main">[</span>Just <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">]</span> <span class="main">@</span> map Just <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span>
    <span class="main">(</span>map Just <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">@</span> <span class="main">[</span>Head <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">(</span>Symb <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">,</span> Just <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">]</span> <span class="main">@</span> map Just <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">accept</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> Right<span class="main">)</span> <span class="main">⟹</span>
    <span class="free">TM_step</span> <span class="main">(</span>map Just <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">@</span> <span class="main">[</span>Head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">,</span> Just <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main">@</span> map Just <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span>
    <span class="main">(</span>map Just <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">@</span> <span class="main">[</span>Just <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> Head <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">(</span>Symb <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> map Just <span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">reachable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> TCell list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="main">[</span>Head <span class="free">init</span> Blank<span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟹</span> TM_step <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">cs'</span></span></span> <span class="main">⟹</span> <span class="free">reachable</span> <span class="free"><span class="bound"><span class="entity">cs'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">nft_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> NState <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Cell <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> NState <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Cell list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> Init Sep <span class="main">(</span>Copy<span class="main">,</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> Init Sep <span class="main">(</span>PreStep None<span class="main">,</span> <span class="main">[</span>Sep<span class="main">,</span> Conf <span class="main">(</span>Head <span class="free">init</span> Blank<span class="main">)</span><span class="main">,</span> Sep<span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> Copy <span class="main">(</span>Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Copy<span class="main">,</span> <span class="main">[</span>Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> Copy <span class="main">(</span>Conf <span class="main">(</span>Head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Copy<span class="main">,</span> <span class="main">[</span>Conf <span class="main">(</span>Head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> Copy Sep <span class="main">(</span>Copy<span class="main">,</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span>Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PreStep <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> <span class="main">(</span>PreStep <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PreStep <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">[</span>Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">accept</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> Left<span class="main">)</span> <span class="main">⟹</span> <span class="free">nft_step</span> <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span>Conf <span class="main">(</span>Head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>PostStep None<span class="main">,</span> <span class="main">[</span>Conf <span class="main">(</span>Head <span class="free"><span class="bound"><span class="entity">s'</span></span></span> Blank<span class="main">)</span><span class="main">,</span> Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">accept</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> Right<span class="main">)</span> <span class="main">⟹</span> <span class="free">nft_step</span> <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span>Conf <span class="main">(</span>Head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>PostStep <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">[</span>Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">accept</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> Left<span class="main">)</span> <span class="main">⟹</span>
    <span class="free">nft_step</span> <span class="main">(</span>PreStep <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Conf <span class="main">(</span>Head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>PostStep None<span class="main">,</span> <span class="main">[</span>Conf <span class="main">(</span>Head <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">(</span>Symb <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">accept</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> Right<span class="main">)</span> <span class="main">⟹</span>
    <span class="free">nft_step</span> <span class="main">(</span>PreStep <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Conf <span class="main">(</span>Head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>PostStep <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">[</span>Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">,</span> Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> <span class="main">(</span>PostStep <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PostStep None<span class="main">,</span> <span class="main">[</span>Conf <span class="main">(</span>Head <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">(</span>Symb <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> <span class="main">(</span>PostStep None<span class="main">)</span> <span class="main">(</span>Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PostStep None<span class="main">,</span> <span class="main">[</span>Conf <span class="main">(</span>Just <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> <span class="main">(</span>PostStep <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span><span class="main">)</span> Sep <span class="main">(</span>PreStep None<span class="main">,</span> <span class="main">[</span>Conf <span class="main">(</span>Head <span class="free"><span class="bound"><span class="entity">s'</span></span></span> Blank<span class="main">)</span><span class="main">,</span> Sep<span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> <span class="main">(</span>PostStep None<span class="main">)</span> Sep <span class="main">(</span>PreStep None<span class="main">,</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> Copy End_Copy <span class="main">(</span>Accept<span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nft_step</span> <span class="main">(</span>PreStep None<span class="main">)</span> End_Sim <span class="main">(</span>Accept<span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nft_accept</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> Accept"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_nft_step<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> nft_step <span class="free">q</span> <span class="free">a</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> nft_step <span class="free">q</span> <span class="free">a</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⊆</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_subset finite_bounded_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> nft<span class="main">:</span> NFT <span class="quoted">Init</span> <span class="quoted">nft_step</span> <span class="quoted">nft_accept</span> <span class="quoted">UNIV</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> finite_UNIV finite_nft_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> PreStep_Some_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep <span class="main">(</span>Some <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>Conf <span class="main">∘</span> Just<span class="main">)</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="main">[</span><span class="free">a'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span>Conf <span class="main">(</span>Just <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> map <span class="main">(</span>Conf <span class="main">∘</span> Just<span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>PreStep <span class="main">(</span>Some <span class="free">a'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> TM.nft_step.intros<span class="main">(</span>7<span class="main">)</span> nft.step
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PreStep_None_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>Conf <span class="main">∘</span> Just<span class="main">)</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="main">[</span><span class="free">a'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
  map <span class="main">(</span>Conf <span class="main">∘</span> Just<span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>PreStep <span class="main">(</span>Some <span class="free">a'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.one_step<span class="main">[</span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nil<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> nft.one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> PreStep_Some_Some<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PostStep_None<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PostStep None<span class="main">)</span>
  <span class="main">(</span>map <span class="main">(</span>Conf <span class="main">∘</span> Just<span class="main">)</span> <span class="free">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> map <span class="main">(</span>Conf <span class="main">∘</span> Just<span class="main">)</span> <span class="free">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nft.step<span class="main">[</span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span><span class="main">]</span> nft.step<span class="main">[</span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as'</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_Copy<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Copy <span class="main">(</span>map Conf <span class="free">as</span><span class="main">,</span> map Conf <span class="free">as</span><span class="main">)</span> Copy"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nft.step<span class="main">[</span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> nft.step<span class="main">[</span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> TCell.exhaust<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_Copy'<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Copy <span class="main">(</span>map Conf <span class="free">cs'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> map Conf <span class="free">cs'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span> Copy"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> nft_comp_Copy nft.one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> TCell list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_option</span> None <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_option</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>Just <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> TM_step_prepend<span class="main">:</span> <span class="quoted"><span class="quoted">"TM_step <span class="main">(</span>Just <span class="free">a'</span> <span class="main">#</span> <span class="free">ds</span><span class="main">)</span> <span class="free">ds'</span> <span class="main">⟹</span>
  TM_step <span class="main">(</span>Just <span class="free">a''</span> <span class="main">#</span> Just <span class="free">a'</span> <span class="main">#</span> <span class="free">ds</span><span class="main">)</span> <span class="main">(</span>Just <span class="free">a''</span> <span class="main">#</span> <span class="free">ds'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"Just <span class="free">a'</span> <span class="main">#</span> <span class="free">ds</span>"</span></span> <span class="quoted"><span class="free">ds'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> TM_step.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span> <span class="skolem">ta</span> <span class="skolem">s'</span> <span class="skolem">a'</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> TM_step.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a''</span> <span class="main">#</span> <span class="skolem">as</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span> <span class="skolem">ta</span> <span class="skolem">s'</span> <span class="skolem">a'</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">as'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> TM_step.intros<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a''</span> <span class="main">#</span> <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">as'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s</span> <span class="skolem">ta</span> <span class="skolem">s'</span> <span class="skolem">a'</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">as'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> TM_step.intros<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 4<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a''</span> <span class="main">#</span> <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">as'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PreStep_None_PostStep<span class="main">:</span> <span class="quoted"><span class="quoted">"TM_step <span class="free">cs</span> <span class="free">cs'</span> <span class="main">⟹</span> nft.computation <span class="main">(</span>PreStep None<span class="main">)</span>
  <span class="main">(</span>map Conf <span class="free">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> map Conf <span class="free">cs'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">cs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> TM_step.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">ta</span> <span class="skolem">s'</span> <span class="skolem">a'</span> <span class="skolem">as'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> step <span class="main">=</span> nft.one_step<span class="main">[</span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">OF</span> 1<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> step PostStep_None<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span> <span class="skolem">ta</span> <span class="skolem">s'</span> <span class="skolem">a'</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> nft.one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> 2<span class="main"><span class="main">]</span></span>
            nft.one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>14<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> nft.comp_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> PreStep_None_Some
            nft.one_step<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main"><span class="main">(</span></span></span>11<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> 2<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
            nft.one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>14<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snoc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span> <span class="skolem">ta</span> <span class="skolem">s'</span> <span class="skolem">a'</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">as'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> nft.comp_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> PreStep_None_Some
          nft.one_step<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main"><span class="main">(</span></span></span>10<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> 3<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
          PostStep_None<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s</span> <span class="skolem">ta</span> <span class="skolem">s'</span> <span class="skolem">a'</span> <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">as'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> nft.comp_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span>
            nft.one_step<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main"><span class="main">(</span></span></span>9<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> 4<span class="main"><span class="main"><span class="main">]</span></span></span>
            nft.one_step<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main"><span class="main">(</span></span></span>12<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
            PostStep_None<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ys</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> nft.comp_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nft.comp_trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> PreStep_None_Some
            nft.one_step<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>11<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span> <span class="operator">OF</span> 4<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>
            nft.one_step<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main"><span class="main">(</span></span></span>12<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
            PostStep_None<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snoc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_witness<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">cs</span> <span class="main">⟹</span> TM_step <span class="free">cs</span> <span class="free">cs'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">as</span> <span class="bound">bs</span><span class="main">.</span> nft.computation Init <span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span> <span class="main">@</span> map Conf <span class="free">cs'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">∧</span>
  nft.computation Init <span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> Copy <span class="main">∧</span>
  nft.active <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">[]</span> <span class="main">∧</span> nft.active Copy <span class="main">(</span>map Conf <span class="free">cs'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reachable.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Cell list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="main">[</span>Sep<span class="main">,</span> Conf <span class="main">(</span>Head <span class="free">init</span> Blank<span class="main">)</span><span class="main">,</span> Sep<span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Cell list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="main">[</span>Sep<span class="main">,</span> Conf <span class="main">(</span>Head <span class="free">init</span> Blank<span class="main">)</span><span class="main">,</span> Sep<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">bs</span> <span class="main">@</span> map Conf <span class="skolem">cs'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> as_def bs_def
    <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> nft.one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> PreStep_None_PostStep<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span> Copy"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> as_def bs_def
    <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> nft.comp_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nft.one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>
          nft.one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
          nft.one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nft.active <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.one_step<span class="main">[</span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nft.active_def nft_accept_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nft.active Copy <span class="main">(</span>map Conf <span class="skolem">cs'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> nft_comp_Copy' nft.one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nft.active_def nft_accept_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">cs</span> <span class="skolem">cs''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">bs</span> <span class="main">@</span> map Conf <span class="skolem">cs''</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span> Copy"</span></span>
    <span class="quoted"><span class="quoted">"nft.active <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">[]</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.active Copy <span class="main">(</span>map Conf <span class="skolem">cs''</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nft.active <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.one_step<span class="main">[</span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nft.active_def nft_accept_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nft.active Copy <span class="main">(</span>map Conf <span class="skolem">cs'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> nft_comp_Copy' nft.one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nft.active_def nft_accept_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> PreStep_None_PostStep<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          nft.comp_trans<span class="main">[</span><span class="operator">OF</span> IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nft_comp_Copy'<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_unbounded<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">cs</span> <span class="main">⟹</span> <span class="main">¬</span>nft.bounded <span class="main">(</span>length <span class="free">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reachable.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nft.active Copy <span class="main">[</span>Conf <span class="main">(</span>Head <span class="free">init</span> Blank<span class="main">)</span><span class="main">,</span> Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.comp_trans<span class="main">[</span><span class="operator">OF</span> nft_comp_Copy' nft.one_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span>
          <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Head <span class="free">init</span> Blank<span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nft.active_def nft_accept_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nft.active <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.one_step<span class="main">[</span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nft.active_def nft_accept_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.one_step<span class="main">[</span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> nft.one_step<span class="main">[</span><span class="operator">OF</span> TM.nft_step.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          impossible_Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nft.bounded_def<span class="main">)</span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">cs</span> <span class="skolem">cs'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> reachable_witness<span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nft.bounded_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_then_unbounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> reachable <span class="bound">cs</span> <span class="main">∧</span> length <span class="bound">cs</span> <span class="main">≥</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">K</span><span class="main">.</span> nft.bounded <span class="bound">K</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reachable_unbounded nft.bounded_mono
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_init_unreachable<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q'</span> <span class="main">=</span> Init <span class="main">⟹</span>
  <span class="free">q</span> <span class="main">=</span> Init <span class="main">∧</span> <span class="free">as</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_start<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> Init <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> Sep"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_end<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">=</span> Copy <span class="main">∨</span> <span class="free">q'</span> <span class="main">=</span> PreStep None"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.comp_rev_induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_step_det<span class="main">:</span> <span class="quoted"><span class="quoted">"nft_step <span class="free">s</span> <span class="free">ta</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">tas</span><span class="main">)</span> <span class="main">⟹</span> nft_step <span class="free">s</span> <span class="free">ta</span> <span class="main">(</span><span class="free">s''</span><span class="main">,</span> <span class="free">tas'</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">s</span> <span class="main">≠</span> Init <span class="main">⟹</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s''</span> <span class="main">∧</span> <span class="free">tas</span> <span class="main">=</span> <span class="free">tas'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_step_init_unreachable<span class="main">:</span> <span class="quoted"><span class="quoted">"nft_step <span class="free">s</span> <span class="free">ta</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">tas</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">s'</span> <span class="main">≠</span> Init"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_det<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q''</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="main">≠</span> Init <span class="main">⟹</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q''</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">bs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">bs'</span></span> <span class="quoted"><span class="free">q''</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.no_step
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">q'</span> <span class="skolem">bs</span> <span class="skolem">as</span> <span class="skolem">bs''</span> <span class="skolem">q'''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qa</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"nft_step <span class="skolem">q</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">qa</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation <span class="skolem">qa</span> <span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>4<span class="main">)</span> nft.computation_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="skolem">bs'</span></span> <span class="quoted"><span class="skolem">q''</span></span><span class="main">]</span> nft.step_dest
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> step_det<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qa</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1<span class="main">,</span>5<span class="main">)</span> split<span class="main">(</span>1<span class="main">)</span> nft_step_det
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'''</span> <span class="main">=</span> <span class="skolem">q''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs''</span> <span class="main">=</span> <span class="skolem">cs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> step_det<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> nft_comp_init_unreachable
          nft.one_step<span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>3<span class="main">)</span> step_det
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PostStep_None_PreStep_None<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span>map Conf <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="main">=</span> PostStep None <span class="main">⟹</span> <span class="free">q'</span> <span class="main">=</span> PreStep None <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">zs</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> map Just <span class="bound">zs</span> <span class="main">∧</span> <span class="free">bs'</span> <span class="main">=</span> map <span class="main">(</span>Conf <span class="main">∘</span> Just<span class="main">)</span> <span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map Conf <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">q'</span> <span class="skolem">bs</span> <span class="skolem">cs</span> <span class="skolem">bs'</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Sep
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step Sep nft.no_step
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> End_Copy
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step End_Copy nft.no_step
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> End_Sim
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step End_Sim nft.no_step
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conf <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">#</span> map Just <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'</span> <span class="main">=</span> map <span class="main">(</span>Conf <span class="main">∘</span> Just<span class="main">)</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step Conf
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step Conf
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_Conf<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Conf <span class="main">(</span>Just <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> map Conf <span class="free">ys</span> <span class="main">⟹</span> map Just <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Conf <span class="main">(</span>Just <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> map Conf <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map Just <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assm
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PreStep_run<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span>map Conf <span class="free">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> map Conf <span class="free">cs'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="main">=</span> PreStep <span class="free">x</span> <span class="main">⟹</span> <span class="free">q'</span> <span class="main">=</span> PreStep None <span class="main">⟹</span> TM_step <span class="main">(</span><span class="main">(</span>list_option <span class="free">x</span><span class="main">)</span> <span class="main">@</span> <span class="free">cs</span><span class="main">)</span> <span class="free">cs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map Conf <span class="free">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> map Conf <span class="free">cs'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">cs'</span></span> <span class="quoted"><span class="free">x</span></span>
  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">q</span> <span class="skolem">tco</span> <span class="skolem">q'</span> <span class="skolem">bs</span> <span class="skolem">as</span> <span class="skolem">bs'</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">tco</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> End_Sim
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conf <span class="skolem">tc</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">tc</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Head <span class="skolem">s</span> <span class="skolem">ta</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> noacc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">accept</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step Conf Head
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> map Conf <span class="skolem">ds</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="main">(</span>Head <span class="skolem">s</span> <span class="skolem">ta</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ds</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>4<span class="main">)</span> Conf Head
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">dir</span></span> <span class="keyword2"><span class="keyword">where</span></span> TM_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">s</span> <span class="skolem">ta</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">,</span> <span class="skolem">dir</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1<span class="main">,</span>6<span class="main">)</span> Conf Head
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Left
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">=</span> map Just <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'</span> <span class="main">=</span> map <span class="main">(</span>Conf <span class="main">∘</span> Just<span class="main">)</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step Conf Head Left ds_def TM_step
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PostStep_None_PreStep_None<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span>Head <span class="skolem">s'</span> Blank<span class="main">)</span><span class="main">,</span> <span class="main">(</span>Just <span class="skolem">a'</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ds</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step Conf Head Left TM_step
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def zs_def map_Conf <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> TM_step.intros<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> noacc TM_step<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Left<span class="main"><span class="main">]</span></span><span class="main">]</span> None
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ds_def zs_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span>Head <span class="skolem">s'</span> <span class="main">(</span>Symb <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Just <span class="skolem">a'</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ds</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step Conf Head Left TM_step
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def zs_def map_Conf <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> TM_step.intros<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> noacc TM_step<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Left<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> Some
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ds_def zs_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Right
        <span class="keyword1"><span class="command">have</span></span> q'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> PostStep <span class="main">(</span>Some <span class="skolem">s'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step Conf Head Right TM_step
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ds</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> Nil
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> None
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="main">[</span>Just <span class="skolem">a'</span><span class="main">,</span> Head <span class="skolem">s'</span> Blank<span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step Conf Head Right Nil ds_def TM_step
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft.step_dest<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> TM_step.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> noacc TM_step<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Right<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> Nil None
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ds_def<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="main">[</span>Just <span class="skolem">a</span><span class="main">,</span> Just <span class="skolem">a'</span><span class="main">,</span> Head <span class="skolem">s'</span> Blank<span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step Conf Head Right Nil ds_def TM_step
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft.step_dest<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> TM_step.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> noacc TM_step<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Right<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span><span class="main">]</span> Nil Some
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ds_def<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">es</span><span class="main">)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a''</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> Just <span class="skolem">a''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> map Just <span class="skolem">zs</span>"</span></span>
            <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PostStep None<span class="main">)</span> <span class="main">(</span>map Conf <span class="skolem">es</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> map <span class="main">(</span>Conf <span class="main">∘</span> Just<span class="main">)</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span>
            <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">bs'</span> <span class="main">=</span> Conf <span class="main">(</span>Head <span class="skolem">s'</span> <span class="main">(</span>Symb <span class="skolem">a''</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> map <span class="main">(</span>Conf <span class="main">∘</span> Just<span class="main">)</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nft.computation.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> q'_def ds_def Cons step<span class="main">(</span>7<span class="main">)</span> PostStep_None
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PostStep_None_PreStep_None<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> None
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="main">[</span>Just <span class="skolem">a'</span><span class="main">,</span> <span class="main">(</span>Head <span class="skolem">s'</span> <span class="main">(</span>Symb <span class="skolem">a''</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">es</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step Conf Head Right Cons TM_step
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def zs_def map_Conf <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> TM_step.intros<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> noacc TM_step<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Right<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="skolem">a''</span></span> <span class="quoted"><span class="skolem">zs</span></span><span class="main">]</span> Cons None
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zs_def ds_def<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="main">[</span>Just <span class="skolem">a</span><span class="main">,</span> Just <span class="skolem">a'</span><span class="main">,</span> <span class="main">(</span>Head <span class="skolem">s'</span> <span class="main">(</span>Symb <span class="skolem">a''</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">es</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step Conf Head Right Cons TM_step
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def zs_def map_Conf <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> TM_step.intros<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> noacc TM_step<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Right<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">a''</span></span> <span class="quoted"><span class="skolem">zs</span></span><span class="main">]</span> Cons Some
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zs_def ds_def<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Just <span class="skolem">a'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> map Conf <span class="skolem">ds</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> Just <span class="skolem">a'</span> <span class="main">#</span> <span class="skolem">ds</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conf Just<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'</span> <span class="main">=</span> map Conf <span class="skolem">cs'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> PreStep <span class="main">(</span>Some <span class="skolem">a'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conf Just <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TM_step <span class="main">(</span>Just <span class="skolem">a'</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span> <span class="skolem">cs'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> ds_def bs'_def<span class="main">]</span> step<span class="main">(</span>7<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> None ds_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a''</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'</span> <span class="main">=</span> map Conf <span class="skolem">ds'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> Just <span class="skolem">a''</span> <span class="main">#</span> <span class="skolem">ds'</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> PreStep <span class="main">(</span>Some <span class="skolem">a'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cs'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conf Just <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TM_step <span class="main">(</span>Just <span class="skolem">a'</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span> <span class="skolem">ds'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> ds_def ds'_def<span class="main">]</span> step<span class="main">(</span>7<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> TM_step_prepend
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Some ds_def ds'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_Copy_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">=</span> Copy"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.comp_rev_induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> nft_comp_init_unreachable
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_induct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"End_Copy <span class="main">∉</span> set <span class="free">cs</span> <span class="main">⟹</span> End_Sim <span class="main">∉</span> set <span class="free">cs</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>map Conf <span class="bound">as</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">cs</span> <span class="bound">as</span><span class="main">.</span> <span class="free">P</span> <span class="bound">cs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">cs</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="bound">as</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">P</span> <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">cs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Sep <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> rev <span class="main">(</span>dropWhile <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">≠</span> Sep<span class="main">)</span> <span class="main">(</span>rev <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs''</span> <span class="main">=</span> rev <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">≠</span> Sep<span class="main">)</span> <span class="main">(</span>rev <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> set_cs''<span class="main">:</span> <span class="quoted"><span class="quoted">"Sep <span class="main">∉</span> set <span class="skolem">cs''</span>"</span></span> <span class="quoted"><span class="quoted">"End_Copy <span class="main">∉</span> set <span class="skolem">cs''</span>"</span></span> <span class="quoted"><span class="quoted">"End_Sim <span class="main">∉</span> set <span class="skolem">cs''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cs''_def set_takeWhileD 1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True cs'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_Nil2 append_butlast_last_id cs''_def hd_dropWhile
          last_rev rev_is_Nil_conv set_cs''<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_rev takeWhile_dropWhile_id<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> cs_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="skolem">cs'</span> <span class="main">@</span> <span class="skolem">cs''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cs'_def cs''_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_append rev_rev_ident takeWhile_dropWhile_id<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">c</span> <span class="keyword1">of</span> Conf <span class="bound">c'</span> <span class="main">⇒</span> <span class="bound">c'</span><span class="main">)</span> <span class="skolem">cs''</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> length <span class="skolem">cs''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> as_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cs''_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs''</span> <span class="main">=</span> map Conf <span class="skolem">as</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_cs'' as_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="skolem">cs''</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Cell.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ds</span> <span class="main">&lt;</span> length <span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cs_split ds_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">ds</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 ds_def cs_split
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> butlast_snoc in_set_butlast_appendI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 cs_split
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ds_def cs''_Some<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> as_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">c</span> <span class="keyword1">of</span> Conf <span class="bound">c'</span> <span class="main">⇒</span> <span class="bound">c'</span><span class="main">)</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> length <span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> as_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> map Conf <span class="skolem">as</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False as_def 1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="skolem">cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Cell.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nft_step_Copy_PreStep<span class="main">:</span> <span class="quoted"><span class="quoted">"nft_step Copy <span class="free">a</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">q'</span> <span class="main">=</span> Copy <span class="main">∨</span> <span class="free">q'</span> <span class="main">=</span> Accept"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_Copy_PreStep<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="main">=</span> Copy <span class="main">∨</span> <span class="free">q</span> <span class="main">=</span> Accept <span class="main">⟹</span> <span class="free">q'</span> <span class="main">=</span> PreStep None <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft_step_Copy_PreStep <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_step_PreStep_Copy<span class="main">:</span> <span class="quoted"><span class="quoted">"nft_step <span class="free">q</span> <span class="free">a</span> <span class="main">(</span>Copy<span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="main">=</span> Init <span class="main">∨</span> <span class="free">q</span> <span class="main">=</span> Copy"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_PreStep_Copy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> PreStep None"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">=</span> Copy"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.comp_rev_induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> nft_comp_init_unreachable
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step_PreStep_Copy<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nft_step_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"nft_step <span class="free">q</span> <span class="main">(</span>Conf <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span>
  Sep <span class="main">∉</span> set <span class="free">bs</span> <span class="main">∧</span> End_Sim <span class="main">∉</span> set <span class="free">bs</span> <span class="main">∧</span> End_Copy <span class="main">∉</span> set <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_step_None<span class="main">:</span> <span class="quoted"><span class="quoted">"nft_step <span class="free">q</span> Sep <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">≠</span> Init <span class="main">⟹</span> <span class="main">∃</span><span class="bound">as</span><span class="main">.</span> <span class="free">bs</span> <span class="main">=</span> map Conf <span class="bound">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nil_is_map_conv list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span>map Conf <span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  Sep <span class="main">∉</span> set <span class="free">bs</span> <span class="main">∧</span> End_Sim <span class="main">∉</span> set <span class="free">bs</span> <span class="main">∧</span> End_Copy <span class="main">∉</span> set <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map Conf <span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft_step_Some<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_PreStep_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span>map Conf <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as'</span><span class="main">.</span> <span class="free">bs</span> <span class="main">=</span> map Conf <span class="bound">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span>map Conf <span class="free">as</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft_step <span class="skolem">q''</span> Sep <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.computation_split<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft.step_dest<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> map Conf <span class="skolem">ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_Some<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> ex_map_conv Cell.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">≠</span> Init"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_init_unreachable<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> es_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> map Conf <span class="skolem">es</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_step_None<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>3<span class="main">)</span> ds_def es_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc map_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_PreStep_None_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span>map Conf <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">≥</span> length <span class="free">as</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as'</span></span> <span class="keyword2"><span class="keyword">where</span></span> bs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> map Conf <span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_PreStep_None<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TM_step <span class="free">as</span> <span class="skolem">as'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> PreStep_run<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> bs_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> TM_step.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_PreStep_None_length'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"End_Copy <span class="main">∉</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"End_Sim <span class="main">∉</span> set <span class="free">cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">≥</span> length <span class="free">cs</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_PreStep_None_length
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">cs</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qm</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="skolem"><span class="skolem">ds'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">ds</span><span class="main">)</span> <span class="skolem">qm</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation <span class="skolem">qm</span> <span class="main">(</span>map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">ds'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.computation_split<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span><span class="main">]</span> 4<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> qm_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qm</span> <span class="main">=</span> PreStep None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_end<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> nft_comp_Copy_PreStep<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> qm_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
          nft_comp_PreStep_None_length<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> qm_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_Init_PreStep_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"End_Copy <span class="main">∉</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"End_Sim <span class="main">∉</span> set <span class="free">cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> PreStep None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">≥</span> length <span class="free">cs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Sep"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms nft_comp_start
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> comp<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span><span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">ds</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> <span class="main">[</span>Sep<span class="main">,</span> Conf <span class="main">(</span>Head <span class="free">init</span> Blank<span class="main">)</span><span class="main">,</span> Sep<span class="main">]</span> <span class="main">@</span> <span class="skolem">ds</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nft.computation.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> comp<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_Copy_PreStep
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_PreStep_None_length'<span class="main">[</span><span class="operator">OF</span> _ _ split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> split<span class="main">(</span>2<span class="main">)</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft.step_dest <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> map Conf <span class="free">as</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> map Conf <span class="free">bs</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">zs</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> <span class="bound">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> last_appendR last_map last_snoc list.map_disc_iff Cell.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> self_append_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_app_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> <span class="free">ws</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> map Conf <span class="free">bs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">zs</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> <span class="bound">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ws</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> split_app'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> map Conf <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> <span class="free">rs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> map Conf <span class="free">bs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">zs</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> <span class="bound">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms split_app
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ws</span> <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cut_last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> map Conf <span class="free">as</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> <span class="skolem">ws</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> map Conf <span class="free">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snoc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> split_app_length<span class="main">[</span><span class="operator">OF</span> cut_last<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_None<span class="main">:</span> <span class="quoted"><span class="quoted">"map Conf <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> <span class="free">xs'</span> <span class="main">=</span> map Conf <span class="free">ys</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> <span class="free">ys'</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs'</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">ys'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> Cell.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hd_append list.map_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_is_Nil_conv not_Cons_self2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_reach<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"End_Copy <span class="main">∉</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"End_Sim <span class="main">∉</span> set <span class="free">cs</span>"</span></span>
  <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span>Sep <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> Copy"</span></span>
  <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span>Sep <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as'</span><span class="main">.</span> reachable <span class="free">as</span> <span class="main">∧</span> TM_step <span class="free">as</span> <span class="bound">as'</span> <span class="main">∧</span> <span class="free">bs'</span> <span class="main">=</span> map Conf <span class="bound">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">bs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">as'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> bs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> Sep <span class="main">#</span> map Conf <span class="skolem">as'</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_Copy_same<span class="main">[</span><span class="operator">OF</span> 3<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qi</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"nft_step Init Sep <span class="main">(</span><span class="skolem">qi</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation <span class="skolem">qi</span> <span class="main">(</span>map Conf <span class="skolem">as'</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">bs'</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span> nft.computation.cases
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> qi_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qi</span> <span class="main">=</span> PreStep None"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> Sep <span class="main">#</span> map Conf <span class="main">[</span>Head <span class="free">init</span> Blank<span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> nft_comp_Copy_PreStep
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> as'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as'</span> <span class="main">=</span> <span class="main">[</span>Head <span class="free">init</span> Blank<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> bs_def qi_props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> split_None<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">as'</span></span> <span class="quoted"><span class="quoted">"map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> <span class="skolem">bs'</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qm</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="skolem"><span class="skolem">ds'</span></span> <span class="keyword2"><span class="keyword">where</span></span> qm_def<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span>map Conf <span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">ds</span><span class="main">)</span> <span class="skolem">qm</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation <span class="skolem">qm</span> <span class="main">(</span>map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">ds'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.computation_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">qi</span></span> <span class="quoted"><span class="quoted">"map Conf <span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span><span class="main">]</span>
          split<span class="main">(</span>2<span class="main">)</span> qi_props<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> qm_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qm</span> <span class="main">=</span> PreStep None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_end<span class="main">[</span><span class="operator">OF</span> qm_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> nft_comp_PreStep_Copy<span class="main">[</span><span class="operator">OF</span> qm_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dsa</span></span> <span class="skolem"><span class="skolem">dsa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> dsa_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">=</span> map Conf <span class="skolem">dsa</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ds'</span> <span class="main">=</span> map Conf <span class="skolem">dsa'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_PreStep_None<span class="main">[</span><span class="operator">OF</span> qm_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> nft_comp_PreStep_None<span class="main">[</span><span class="operator">OF</span> qm_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> qm_props<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> tm_step<span class="main">:</span> <span class="quoted"><span class="quoted">"TM_step <span class="skolem">as'</span> <span class="skolem">dsa</span>"</span></span> <span class="quoted"><span class="quoted">"TM_step <span class="skolem">as</span> <span class="skolem">dsa'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> PreStep_run<span class="main">[</span><span class="operator">OF</span> qm_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> dsa_def<span class="main"><span class="main">]</span></span> _ qm_props<span class="main">]</span>
          PreStep_run<span class="main">[</span><span class="operator">OF</span> qm_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> qm_props dsa_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> as_dsa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="skolem">dsa</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'</span> <span class="main">=</span> map Conf <span class="skolem">dsa'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> bs_def qi_props qm_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> dsa_def<span class="main">]</span> as'_def split_None
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> tm_step<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> as'_def as_dsa<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> tm_step<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reachable.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">cs</span> <span class="skolem">as'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> bs_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="main">(</span>Sep <span class="main">#</span> <span class="skolem">cs</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span> <span class="main">@</span>
    map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span> Copy"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="skolem"><span class="skolem">ds'</span></span> <span class="skolem"><span class="skolem">qd</span></span> <span class="keyword2"><span class="keyword">where</span></span> bs_split<span class="main">:</span>
    <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span>Sep <span class="main">#</span> <span class="skolem">cs</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">ds</span><span class="main">)</span> <span class="skolem">qd</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation <span class="skolem">qd</span> <span class="main">(</span>map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span> Copy"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">ds'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.computation_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> qd_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qd</span> <span class="main">=</span> Copy"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qd</span> <span class="main">=</span> Copy <span class="main">∨</span> <span class="skolem">qd</span> <span class="main">=</span> PreStep None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nft_comp_end<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"Sep <span class="main">#</span> <span class="skolem">cs</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="skolem">as'</span>"</span></span><span class="main">]</span> bs_split<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> nft_comp_PreStep_Copy<span class="main">[</span><span class="operator">OF</span> bs_split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> bs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="main">(</span>Sep <span class="main">#</span> <span class="skolem">cs</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span> <span class="main">@</span> map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_Copy_same<span class="main">[</span><span class="operator">OF</span> bs_comp<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ds_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">=</span> Sep <span class="main">#</span> <span class="skolem">cs</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_Copy_same<span class="main">[</span><span class="operator">OF</span> bs_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> qd_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ds'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ds'</span> <span class="main">=</span> map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_Copy_same<span class="main">[</span><span class="operator">OF</span> bs_split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> bs_bs'_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="main">(</span>Sep <span class="main">#</span> <span class="skolem">cs</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span> <span class="main">@</span>
    map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">bs'</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="skolem"><span class="skolem">qe</span></span> <span class="keyword2"><span class="keyword">where</span></span> bs'_split<span class="main">:</span>
    <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span>Sep <span class="main">#</span> <span class="skolem">cs</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">qe</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation <span class="skolem">qe</span> <span class="main">(</span>map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">es'</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">bs'</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.computation_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> qe_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qe</span> <span class="main">=</span> PreStep None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qe</span> <span class="main">=</span> Copy <span class="main">∨</span> <span class="skolem">qe</span> <span class="main">=</span> PreStep None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nft_comp_end<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"Sep <span class="main">#</span> <span class="skolem">cs</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="skolem">as'</span>"</span></span><span class="main">]</span> bs'_split<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> nft_comp_Copy_PreStep<span class="main">[</span><span class="operator">OF</span> bs'_split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> fs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">es'</span> <span class="main">=</span> map Conf <span class="skolem">fs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_PreStep_None<span class="main">[</span><span class="operator">OF</span> bs'_split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> qe_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_app'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Sep <span class="main">#</span> <span class="skolem">cs</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="skolem">as'</span>"</span></span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="skolem">bs'</span></span> <span class="quoted"><span class="skolem">es</span></span> <span class="quoted"><span class="skolem">fs</span></span><span class="main">]</span> ds_def
          bs'_split<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> bs_def fs_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> ns_def<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="skolem">as'</span>"</span></span> <span class="quoted"><span class="quoted">"TM_step <span class="skolem">as'</span> <span class="skolem">ns</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> map Conf <span class="skolem">ns</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ _ bs_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> qd_def<span class="main"><span class="main">]</span></span> bs'_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> qe_def zs_def<span class="main"><span class="main">]</span></span><span class="main">]</span> 4<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> as_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">=</span> <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'</span> <span class="main">=</span> map Conf <span class="skolem">fs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bs'_split<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> zs_def ns_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> fs_def bs_def ds_def<span class="main">]</span> split_None
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span>map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> map Conf <span class="skolem">fs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bs'_split<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> qe_def<span class="main">]</span> fs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TM_step <span class="skolem">as</span> <span class="skolem">fs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> PreStep_run
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ns_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> as_ns<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> as_ns<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reachable.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_reaches_states<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"End_Copy <span class="main">∉</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"End_Sim <span class="main">∉</span> set <span class="free">cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span>Sep <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span>Sep <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">bs'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> Copy <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> PreStep None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> comps<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="main">(</span>Sep <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="main">(</span>Sep <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> q_neq_q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qm</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="skolem"><span class="skolem">ds'</span></span> <span class="keyword2"><span class="keyword">where</span></span> qm_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qm</span> <span class="main">=</span> Copy <span class="main">∨</span> <span class="skolem">qm</span> <span class="main">=</span> PreStep None"</span></span>
      <span class="quoted"><span class="quoted">"nft_step Init Sep <span class="main">(</span><span class="skolem">qm</span><span class="main">,</span> <span class="skolem">ds</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"nft.computation <span class="skolem">qm</span> <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span> <span class="free">q</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">ds'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nft.computation.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> comps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nft_step.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> qm_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qm</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> qm_def<span class="main">(</span>1<span class="main">)</span> nft_comp_end<span class="main">[</span><span class="operator">OF</span> qm_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
            nft_comp_PreStep_Copy<span class="main">[</span><span class="operator">OF</span> qm_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> nft_comp_Copy_PreStep<span class="main">[</span><span class="operator">OF</span> qm_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qm'</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> qm'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qm'</span> <span class="main">=</span> Copy <span class="main">∨</span> <span class="skolem">qm'</span> <span class="main">=</span> PreStep None"</span></span>
      <span class="quoted"><span class="quoted">"nft_step Init Sep <span class="main">(</span><span class="skolem">qm'</span><span class="main">,</span> <span class="skolem">es</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"nft.computation <span class="skolem">qm'</span> <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">es'</span><span class="main">)</span> <span class="free">q'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nft.computation.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> comps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nft_step.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> qm'_q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qm'</span> <span class="main">=</span> <span class="free">q'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> qm'_def<span class="main">(</span>1<span class="main">)</span> nft_comp_end<span class="main">[</span><span class="operator">OF</span> qm'_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
            nft_comp_PreStep_Copy<span class="main">[</span><span class="operator">OF</span> qm'_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> nft_comp_Copy_PreStep<span class="main">[</span><span class="operator">OF</span> qm'_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> qm_def qm'_def nft_comp_det<span class="main">[</span><span class="operator">OF</span> qm_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">es'</span></span> <span class="quoted"><span class="free">q'</span></span><span class="main">]</span> assms<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> qm_q qm'_q'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> Copy <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> PreStep None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_end<span class="main">[</span><span class="operator">OF</span> comps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> nft_comp_end<span class="main">[</span><span class="operator">OF</span> comps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> q_neq_q'
          nft_comp_Init_PreStep_length<span class="main">[</span><span class="operator">OF</span> _ _ comps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          nft_comp_Init_PreStep_length<span class="main">[</span><span class="operator">OF</span> _ _comps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          nft_comp_Copy_same<span class="main">[</span><span class="operator">OF</span> comps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          nft_comp_Copy_same<span class="main">[</span><span class="operator">OF</span> comps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> le_add1 length_Cons length_append length_append_singleton not_less_eq_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_reach<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"End_Copy <span class="main">∉</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"End_Sim <span class="main">∉</span> set <span class="free">cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as</span><span class="main">.</span> reachable <span class="bound">as</span> <span class="main">∧</span> length <span class="bound">as</span> <span class="main">≥</span> length <span class="free">bs'</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> as_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_start 3<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs'</span> <span class="main">=</span> <span class="main">[</span>Conf <span class="main">(</span>Head <span class="free">init</span> Blank<span class="main">)</span><span class="main">,</span> Sep<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_end<span class="main">[</span><span class="operator">OF</span> 3<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> nft_comp_end<span class="main">[</span><span class="operator">OF</span> 3<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
          nft_comp_Copy_same<span class="main">[</span><span class="operator">OF</span> 3<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> 3<span class="main">(</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> as_Nil <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft.step_dest <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reachable.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">cs</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">have</span></span> sts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> Copy"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">=</span> PreStep None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> init_reaches_states<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map Conf <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">bs'</span></span> <span class="quoted"><span class="free">q'</span></span><span class="main">]</span> 4<span class="main">(</span>4<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nil<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> bs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> Sep <span class="main">#</span> map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nft_comp_Copy_same<span class="main">[</span><span class="operator">OF</span> 4<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> sts<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nil<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> comp<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span>Sep <span class="main">#</span> map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nil sts<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep None<span class="main">)</span> <span class="main">(</span>map Conf <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">ds</span><span class="main">)</span> <span class="main">(</span>PreStep None<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span> <span class="main">=</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> map Conf <span class="main">[</span>Head <span class="free">init</span> Blank<span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span> <span class="main">@</span> <span class="skolem">ds</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nft.computation.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> comp<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> nft_comp_Copy_PreStep <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> as_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="main">[</span>Head <span class="free">init</span> Blank<span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ds_def<span class="main">(</span>2<span class="main">)</span> split_None<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bs_def<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> es_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">=</span> map Conf <span class="skolem">es</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nft_comp_PreStep_None<span class="main">[</span><span class="operator">OF</span> ds_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> tm_step<span class="main">:</span> <span class="quoted"><span class="quoted">"TM_step <span class="skolem">as</span> <span class="skolem">es</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> PreStep_run<span class="main">[</span><span class="operator">OF</span> ds_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> es_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> bs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs'</span> <span class="main">=</span> <span class="skolem">ds</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ds_def<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> bs_def<span class="main">]</span> as_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> tm_step
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> as_def bs'_def es_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reachable.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">cs'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> c_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Sep"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> Cons<span class="main">]</span> nft_comp_start
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> nft_comp_reach<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">cs'</span></span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">bs'</span></span><span class="main">]</span> 4
            init_reaches_states<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">@</span> Sep <span class="main">#</span> map Conf <span class="skolem">as</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons c_None <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reachable.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def diff_Suc_1 le_refl length_append_singleton
          length_map reachable.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PostStep_run_len<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PostStep <span class="free">x</span><span class="main">)</span> <span class="main">(</span>map Conf <span class="free">as</span><span class="main">,</span> <span class="free">ds'</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ds'</span> <span class="main">=</span> length <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">ds'</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft.no_step<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> comp<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PostStep <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>Conf <span class="skolem">a</span> <span class="main">#</span> map Conf <span class="skolem">as</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PostStep None<span class="main">)</span> <span class="main">(</span>map Conf <span class="skolem">as</span><span class="main">,</span> <span class="skolem">es'</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ds'</span> <span class="main">=</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">es'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nft.computation.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> comp<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> rest<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rest<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PreStep_run_len<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep <span class="free">x</span><span class="main">)</span> <span class="main">(</span>map Conf <span class="free">as</span><span class="main">,</span> <span class="free">ds'</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ds'</span> <span class="main">≤</span> length <span class="free">as</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span>
    length <span class="free">as</span> <span class="main">≤</span> length <span class="free">ds'</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">ds'</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft.no_step<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Head <span class="skolem">s</span> <span class="skolem">ta</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> comp<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>Conf <span class="skolem">a</span> <span class="main">#</span> map Conf <span class="skolem">as</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PostStep <span class="skolem">x'</span><span class="main">)</span> <span class="main">(</span>map Conf <span class="skolem">as</span><span class="main">,</span> <span class="skolem">es'</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ds'</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nft.computation.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> comp<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Head <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> PostStep_run_len<span class="main">[</span><span class="operator">OF</span> rest<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> rest<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rest<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Just <span class="skolem">a'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> comp<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>Conf <span class="main">(</span>Just <span class="skolem">a'</span><span class="main">)</span> <span class="main">#</span> map Conf <span class="skolem">as</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Just<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> es_def<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>PreStep <span class="main">(</span>Some <span class="skolem">a'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map Conf <span class="skolem">as</span><span class="main">,</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
      <span class="quoted"><span class="quoted">"length <span class="skolem">ds'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> length <span class="skolem">es</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nft.computation.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> comp<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> es_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> es_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_Accept<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="main">=</span> Accept <span class="main">⟹</span> <span class="free">as</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> Accept"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_Accept'<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="free">q</span> <span class="main">≠</span> Accept <span class="main">⟹</span> <span class="free">q'</span> <span class="main">=</span> Accept <span class="main">⟹</span> End_Sim <span class="main">∈</span> set <span class="free">as</span> <span class="main">∨</span> End_Copy <span class="main">∈</span> set <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_Copy_Copy<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> Copy <span class="main">⟹</span>
  <span class="free">q'</span> <span class="main">=</span> Copy <span class="main">∨</span> <span class="free">q'</span> <span class="main">=</span> Accept"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft_comp_Accept<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_Copy_Copy'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">=</span> Copy"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> Copy <span class="main">∨</span> <span class="free">q</span> <span class="main">=</span> Init"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.comp_rev_induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> nft_comp_init_unreachable assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_app_long<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ds</span> <span class="main">+</span> <span class="free">n</span> <span class="main">≤</span> length <span class="free">es</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">@</span> <span class="free">ds'</span> <span class="main">=</span> <span class="free">es</span> <span class="main">@</span> <span class="free">es'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rs</span><span class="main">.</span> <span class="free">es</span> <span class="main">=</span> <span class="free">ds</span> <span class="main">@</span> <span class="bound">rs</span> <span class="main">∧</span> length <span class="bound">rs</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">ds'</span></span> <span class="quoted"><span class="free">es</span></span> <span class="quoted"><span class="free">es'</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.le_diff_conv2 add.commute add_Suc_right add_leD1 append_Cons
      append_eq_append_conv_if append_eq_conv_conj length_Cons length_drop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_reach'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"End_Copy <span class="main">∉</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"End_Sim <span class="main">∉</span> set <span class="free">cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="free">cs</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="free">cs</span><span class="main">,</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">bs'</span> <span class="main">≥</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as</span><span class="main">.</span> reachable <span class="bound">as</span> <span class="main">∧</span> length <span class="bound">as</span> <span class="main">≥</span> length <span class="free">bs'</span> <span class="main">-</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 3
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft_comp_start nft.no_step<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">cs</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qm</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="skolem"><span class="skolem">ds'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">ds</span><span class="main">)</span> <span class="skolem">qm</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation <span class="skolem">qm</span> <span class="main">(</span>map Conf <span class="skolem">as</span><span class="main">,</span> <span class="skolem">ds'</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">ds'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.computation_split<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span><span class="main">]</span> 4<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> qm_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qm</span> <span class="main">=</span> Copy <span class="main">∨</span> <span class="skolem">qm</span> <span class="main">=</span> PreStep None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_end<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_ds'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ds'</span> <span class="main">≤</span> length <span class="skolem">as</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> length <span class="skolem">as</span> <span class="main">≤</span> length <span class="skolem">ds'</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> lassm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qm</span> <span class="main">=</span> Copy"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ds'</span> <span class="main">≤</span> length <span class="skolem">as</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> length <span class="skolem">as</span> <span class="main">≤</span> length <span class="skolem">ds'</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nft_comp_Copy_same<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> nft_comp_Copy_Copy<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            nft_comp_Accept'<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 4<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> lassm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qm</span> <span class="main">=</span> PreStep None"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ds'</span> <span class="main">≤</span> length <span class="skolem">as</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> length <span class="skolem">as</span> <span class="main">≤</span> length <span class="skolem">ds'</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> PreStep_run_len<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> lassm<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qm'</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split'<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span><span class="main">,</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">qm'</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation <span class="skolem">qm'</span> <span class="main">(</span>map Conf <span class="skolem">as</span><span class="main">,</span> <span class="skolem">es'</span><span class="main">)</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.computation_split<span class="main">[</span><span class="operator">of</span> <span class="quoted">Init</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">@</span> <span class="main">[</span>Sep<span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"map Conf <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">@</span> <span class="free">bs'</span>"</span></span> <span class="quoted"><span class="free">q'</span></span><span class="main">]</span> 4<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> qm'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qm'</span> <span class="main">=</span> Copy <span class="main">∨</span> <span class="skolem">qm'</span> <span class="main">=</span> PreStep None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_end<span class="main">[</span><span class="operator">OF</span> split'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_es'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">es'</span> <span class="main">≤</span> length <span class="skolem">as</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> length <span class="skolem">as</span> <span class="main">≤</span> length <span class="skolem">es'</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> lassm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qm'</span> <span class="main">=</span> Copy"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">es'</span> <span class="main">≤</span> length <span class="skolem">as</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> length <span class="skolem">as</span> <span class="main">≤</span> length <span class="skolem">es'</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nft_comp_Copy_same<span class="main">[</span><span class="operator">OF</span> split'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> nft_comp_Copy_Copy<span class="main">[</span><span class="operator">OF</span> split'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            nft_comp_Accept'<span class="main">[</span><span class="operator">OF</span> split'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 4<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> lassm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qm'</span> <span class="main">=</span> PreStep None"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">es'</span> <span class="main">≤</span> length <span class="skolem">as</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> length <span class="skolem">as</span> <span class="main">≤</span> length <span class="skolem">es'</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> PreStep_run_len<span class="main">[</span><span class="operator">OF</span> split'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> lassm<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">≥</span> length <span class="skolem">ds</span> <span class="main">+</span> <span class="main">(</span>length <span class="free">bs'</span> <span class="main">-</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> len_es'_le<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">es'</span> <span class="main">≤</span> length <span class="skolem">ds'</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> len_es' len_ds'
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">=</span> length <span class="skolem">ds</span> <span class="main">+</span> length <span class="skolem">ds'</span> <span class="main">+</span> length <span class="free">bs'</span> <span class="main">-</span> length <span class="skolem">es'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split'<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' length_append<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> len_es'_le 4<span class="main">(</span>7<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">rs</span> <span class="main">≥</span> length <span class="free">bs'</span> <span class="main">-</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split'<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> split_app_long<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">es</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ds'</span> <span class="main">@</span> <span class="free">bs'</span>"</span></span> <span class="quoted"><span class="skolem">es'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rs_def<span class="main">(</span>2<span class="main">)</span> 4<span class="main">(</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> init_reach<span class="main">[</span><span class="operator">OF</span> _ _ split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> split'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> rs_def<span class="main"><span class="main">]</span></span><span class="main">]</span> 4<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_End_Copy<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> End_Copy <span class="main">∈</span> set <span class="free">as</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">cs</span> <span class="main">@</span> <span class="main">[</span>End_Copy<span class="main">]</span> <span class="main">∧</span> End_Copy <span class="main">∉</span> set <span class="bound">cs</span> <span class="main">∧</span> End_Sim <span class="main">∉</span> set <span class="bound">cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft_comp_Accept<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nft_comp_End_Sim<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> End_Sim <span class="main">∈</span> set <span class="free">as</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">cs</span> <span class="main">@</span> <span class="main">[</span>End_Sim<span class="main">]</span> <span class="main">∧</span> End_Copy <span class="main">∉</span> set <span class="bound">cs</span> <span class="main">∧</span> End_Sim <span class="main">∉</span> set <span class="bound">cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft_comp_Accept<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unbounded_then_reachable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">K</span><span class="main">.</span> <span class="main">¬</span>nft.bounded <span class="bound">K</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> reachable <span class="bound">cs</span> <span class="main">∧</span> length <span class="bound">cs</span> <span class="main">≥</span> <span class="bound">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">K</span><span class="main">.</span> <span class="main">¬</span>nft.bounded <span class="bound">K</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> wit<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">q'</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">n</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.bounded_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> reachable <span class="bound">cs</span> <span class="main">∧</span> length <span class="bound">cs</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"End_Copy <span class="main">∉</span> set <span class="skolem">u</span> <span class="main">∧</span> End_Sim <span class="main">∉</span> set <span class="skolem">u</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> init_reach'<span class="main">[</span><span class="operator">OF</span> _ _ wit<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> wit<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"End_Copy <span class="main">∈</span> set <span class="skolem">u</span> <span class="main">∨</span> End_Sim <span class="main">∈</span> set <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"End_Copy <span class="main">∈</span> set <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="main">[</span>End_Copy<span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"End_Copy <span class="main">∉</span> set <span class="skolem">ds</span>"</span></span> <span class="quoted"><span class="quoted">"End_Sim <span class="main">∉</span> set <span class="skolem">ds</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nft_comp_End_Copy<span class="main">[</span><span class="operator">OF</span> wit<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">ds</span><span class="main">,</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span>
        <span class="quoted"><span class="quoted">"nft_step <span class="skolem">q''</span> End_Copy <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">es'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nft.computation_split<span class="main">[</span><span class="operator">OF</span> wit<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ds_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft.step_dest<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> es_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'''</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="skolem"><span class="skolem">fs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split'<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">ds</span><span class="main">,</span> <span class="skolem">fs</span><span class="main">)</span> <span class="skolem">q'''</span>"</span></span>
        <span class="quoted"><span class="quoted">"nft_step <span class="skolem">q'''</span> End_Copy <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">fs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span> <span class="main">=</span> <span class="skolem">fs</span> <span class="main">@</span> <span class="skolem">fs'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nft.computation_split<span class="main">[</span><span class="operator">OF</span> wit<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ds_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft.step_dest<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> fs_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split'<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> reachable <span class="bound">cs</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">≤</span> length <span class="bound">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> init_reach'<span class="main">[</span><span class="operator">OF</span> _ _ split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> es_v<span class="main"><span class="main">]</span></span> split'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fs_v<span class="main"><span class="main">]</span></span><span class="main">]</span> ds_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
              wit<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"End_Sim <span class="main">∈</span> set <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="main">[</span>End_Sim<span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"End_Copy <span class="main">∉</span> set <span class="skolem">ds</span>"</span></span> <span class="quoted"><span class="quoted">"End_Sim <span class="main">∉</span> set <span class="skolem">ds</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nft_comp_End_Sim<span class="main">[</span><span class="operator">OF</span> wit<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">ds</span><span class="main">,</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span>
        <span class="quoted"><span class="quoted">"nft_step <span class="skolem">q''</span> End_Sim <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">es'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="skolem">es'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nft.computation_split<span class="main">[</span><span class="operator">OF</span> wit<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ds_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft.step_dest<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> es_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'''</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="skolem"><span class="skolem">fs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split'<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation Init <span class="main">(</span><span class="skolem">ds</span><span class="main">,</span> <span class="skolem">fs</span><span class="main">)</span> <span class="skolem">q'''</span>"</span></span>
        <span class="quoted"><span class="quoted">"nft_step <span class="skolem">q'''</span> End_Sim <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">fs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span> <span class="main">=</span> <span class="skolem">fs</span> <span class="main">@</span> <span class="skolem">fs'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nft.computation_split<span class="main">[</span><span class="operator">OF</span> wit<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ds_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft.step_dest<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> fs_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">v'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split'<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> reachable <span class="bound">cs</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">≤</span> length <span class="bound">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> init_reach'<span class="main">[</span><span class="operator">OF</span> _ _ split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> es_v<span class="main"><span class="main">]</span></span> split'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fs_v<span class="main"><span class="main">]</span></span><span class="main">]</span> ds_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
              wit<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unambiguous_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation_ext <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qbs</span><span class="main">)</span> <span class="free">f</span> <span class="main">⟹</span>
  nft.computation_ext <span class="free">q</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qbs'</span><span class="main">)</span> <span class="free">f'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">≠</span> Init <span class="main">⟹</span> <span class="free">qbs</span> <span class="main">=</span> <span class="free">qbs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qbs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">qbs</span></span> <span class="quoted"><span class="free">qbs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nft.computation_ext.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_ext <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">q'</span> <span class="skolem">bs</span> <span class="skolem">as</span> <span class="skolem">qs</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">qbs'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">qb</span> <span class="skolem">qbs''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> q'_not_Init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">≠</span> Init"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_ext<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nft_step <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">qb</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_ext<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft.computation_ext.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qb_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qb</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_ext<span class="main">(</span>1<span class="main">,</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> comp'<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation_ext <span class="skolem">q'</span> <span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">qbs''</span><span class="main">)</span> <span class="free">f'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_ext<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons qb_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft.computation_ext.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step_ext<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> comp' q'_not_Init<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons qb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft.computation_ext.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft.computation_ext.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unambiguous<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nft.computation_ext Init <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qbs</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"nft_accept <span class="free">f</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation_ext Init <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qbs'</span><span class="main">)</span> <span class="free">f'</span>"</span></span> <span class="quoted"><span class="quoted">"nft_accept <span class="free">f'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">qbs</span> <span class="main">=</span> <span class="free">qbs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nft.computation_ext.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qbs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">qbs</span> <span class="main">=</span> <span class="free">qbs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft.computation_ext.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">q'</span> <span class="skolem">bs</span> <span class="skolem">as'</span> <span class="skolem">qbs''</span> <span class="skolem">q''</span>
  <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"Init <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">qbs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as'</span><span class="main">,</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">qbs''</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">q''</span>"</span></span> <span class="quoted"><span class="quoted">"nft_step <span class="skolem">q</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"nft.computation_ext <span class="skolem">q'</span> <span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="skolem">qbs''</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> fst_step <span class="main">=</span> lassms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> lassms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> comp <span class="main">=</span> nft.computation_ext_sound<span class="main">[</span><span class="operator">OF</span> lassms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> q'_mode<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> Copy <span class="main">∨</span> <span class="skolem">q'</span> <span class="main">=</span> PreStep None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst_step
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q'_not_Init_Accept<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">≠</span> Init"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">≠</span> Accept"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> a_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Sep"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst_step
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> q''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">=</span> Accept"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lassms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nft_accept_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as''</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> as'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as'</span> <span class="main">=</span> <span class="skolem">as''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> End_Sim <span class="main">∨</span> <span class="skolem">e</span> <span class="main">=</span> End_Copy"</span></span>
    <span class="quoted"><span class="quoted">"End_Copy <span class="main">∉</span> set <span class="skolem">as''</span>"</span></span> <span class="quoted"><span class="quoted">"End_Sim <span class="main">∉</span> set <span class="skolem">as''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft_comp_Accept'<span class="main">[</span><span class="operator">OF</span> comp q'_not_Init_Accept<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> q''_def<span class="main">]</span>
      nft_comp_End_Sim<span class="main">[</span><span class="operator">OF</span> comp<span class="main">]</span> nft_comp_End_Copy<span class="main">[</span><span class="operator">OF</span> comp<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qb</span></span> <span class="skolem"><span class="skolem">qbs'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> qbs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">qbs'</span> <span class="main">=</span> <span class="skolem">qb</span> <span class="main">#</span> <span class="skolem">qbs'''</span>"</span></span> <span class="quoted"><span class="quoted">"nft_step Init <span class="skolem">a</span> <span class="skolem">qb</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft.computation_ext <span class="main">(</span>fst <span class="skolem">qb</span><span class="main">)</span> <span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="skolem">qbs'''</span><span class="main">)</span> <span class="free">f'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> lassms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">qbs'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft.computation_ext.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fst_qb_mode<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">qb</span> <span class="main">=</span> Copy <span class="main">∨</span> fst <span class="skolem">qb</span> <span class="main">=</span> PreStep None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qbs'_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">bs'</span></span> <span class="skolem"><span class="skolem">bs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="skolem">q'</span> <span class="main">(</span><span class="skolem">as''</span><span class="main">,</span> <span class="skolem">bs'</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft_step <span class="skolem">r</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">q''</span><span class="main">,</span> <span class="skolem">bs''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.computation_split<span class="main">[</span><span class="operator">OF</span> comp<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> as'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft.step_dest<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="skolem"><span class="skolem">cs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> split'<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation <span class="main">(</span>fst <span class="skolem">qb</span><span class="main">)</span> <span class="main">(</span><span class="skolem">as''</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"nft_step <span class="skolem">r'</span> <span class="skolem">e</span> <span class="main">(</span><span class="free">f'</span><span class="main">,</span> <span class="skolem">cs''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nft.computation_split<span class="main">[</span><span class="operator">OF</span> nft.computation_ext_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> qbs'_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> as'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nft.step_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">qb</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as'_def<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> e_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> End_Sim"</span></span>
    <span class="keyword1"><span class="command">have</span></span> r_r'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> PreStep None"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> PreStep None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>2<span class="main">)</span> split'<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> e_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> q'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> PreStep None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>1<span class="main">)</span> q'_mode r_r'_def<span class="main">(</span>1<span class="main">)</span> nft_comp_Copy_PreStep
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> fst_qb_def<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">qb</span> <span class="main">=</span> PreStep None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split'<span class="main">(</span>1<span class="main">)</span> fst_qb_mode r_r'_def<span class="main">(</span>2<span class="main">)</span> nft_comp_Copy_PreStep
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">qb</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q'_def fst_qb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> e_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> End_Copy"</span></span>
    <span class="keyword1"><span class="command">have</span></span> r_r'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Copy"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> Copy"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>2<span class="main">)</span> split'<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> e_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> q'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> Copy"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>1<span class="main">)</span> q'_mode r_r'_def<span class="main">(</span>1<span class="main">)</span> nft_comp_PreStep_Copy
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> fst_qb_def<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">qb</span> <span class="main">=</span> Copy"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split'<span class="main">(</span>1<span class="main">)</span> fst_qb_mode r_r'_def<span class="main">(</span>2<span class="main">)</span> nft_comp_PreStep_Copy
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">qb</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q'_def fst_qb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qb_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qb</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst_step qbs'_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nft_step.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> comp'<span class="main">:</span> <span class="quoted"><span class="quoted">"nft.computation_ext <span class="skolem">q'</span> <span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="skolem">qbs'''</span><span class="main">)</span> <span class="free">f'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qbs'_def<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qb_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">qbs</span> <span class="main">=</span> <span class="free">qbs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>2<span class="main">)</span> unambiguous_aux<span class="main">[</span><span class="operator">OF</span> lassms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> comp' q'_not_Init_Accept<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qbs'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> qb_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Claim 21 *)</span>
<span class="keyword1"><span class="command">interpretation</span></span> uNFT <span class="quoted">Init</span> <span class="quoted">nft_step</span> <span class="quoted">nft_accept</span> <span class="quoted">UNIV</span>
  <span class="keyword1"><span class="command">using</span></span> unambiguous
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">assumption</span>

<span class="comment1">(* Claim 22 *)</span>
<span class="keyword1"><span class="command">lemma</span></span> unbounded_iff_reachable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">K</span><span class="main">.</span> nft.bounded <span class="bound">K</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> reachable <span class="bound">cs</span> <span class="main">∧</span> length <span class="bound">cs</span> <span class="main">≥</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reachable_then_unbounded unbounded_then_reachable
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</body>

</html>