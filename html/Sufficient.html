<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Sufficient</title>
</head>


<body>
<div class="head">
<h1>Theory Sufficient</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Sufficient
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Computation.html">Computation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tdfa_s <span class="main">=</span> STATE <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> nat<span class="main">)</span> set<span class="main">)</span>"</span></span> <span class="main">|</span> REJECT

<span class="keyword1"><span class="command">context</span></span> bNFT
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">≡</span> <span class="free">t</span> <span class="main">+</span> output_speed"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tdfa_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tdfa_s"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tdfa_init</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> active <span class="free">init</span> <span class="main">[]</span> <span class="keyword1">then</span> STATE <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">init</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> REJECT<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tdfa_accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tdfa_s <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tdfa_accept</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">of</span> STATE <span class="main">(</span><span class="bound">bs</span><span class="main">,</span> <span class="bound">qs</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">qs</span><span class="main">.</span> <span class="free">accept</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">=</span> length <span class="bound">bs</span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">upd_qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">upd_qs</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">n'</span><span class="main">)</span><span class="main">.</span> active <span class="bound">q'</span> <span class="main">(</span>drop <span class="bound">n'</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">n'</span> <span class="main">∧</span> <span class="bound">n'</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">∧</span>
    <span class="free">δ</span> <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> take <span class="main">(</span><span class="bound">n'</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">drop_qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">drop_qs</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ext_qs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ext_qs</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">q</span></span><span class="main">,</span> <span class="bound"><span class="bound">n</span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">.</span> active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tdfa_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tdfa_s <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> Al <span class="main">×</span> <span class="tfree">'b</span> Al<span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tdfa_s <span class="main">×</span> bool <span class="main">×</span> bool<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tdfa_step</span> <span class="main">(</span>STATE <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Symb <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Symb <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">&lt;</span> t' <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">qs'</span> <span class="main">=</span> ext_qs <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">;</span> <span class="bound">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="bound">qs'</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">qs'</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">then</span> Some <span class="main">(</span>STATE <span class="main">(</span>drop <span class="bound">m</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">,</span> drop_qs <span class="bound">m</span> <span class="bound">qs'</span><span class="main">)</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>
  <span class="keyword1">else</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">qs'</span> <span class="main">=</span> upd_qs <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">;</span> <span class="bound">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="bound">qs'</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">qs'</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">then</span> Some <span class="main">(</span>STATE <span class="main">(</span>drop <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> drop_qs <span class="bound">m</span> <span class="bound">qs'</span><span class="main">)</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tdfa_step</span> <span class="main">(</span>STATE <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Symb <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Blank<span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">qs'</span> <span class="main">=</span> upd_qs <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">;</span> <span class="bound">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="bound">qs'</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">qs'</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">then</span> Some <span class="main">(</span>STATE <span class="main">(</span>drop <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> drop_qs <span class="bound">m</span> <span class="bound">qs'</span><span class="main">)</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tdfa_step</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tdfa_Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tdfa_s set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tdfa_Q</span> <span class="main">=</span> <span class="main">{</span>REJECT<span class="main">}</span> <span class="main">∪</span> STATE <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">bs</span> <span class="main">::</span> <span class="tfree">'b</span> list<span class="main">,</span> <span class="bound">qs</span><span class="main">)</span><span class="main">.</span> length <span class="bound">bs</span> <span class="main">≤</span> t' <span class="main">∧</span>
    <span class="bound">qs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="bound">bs</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upd_qs_tdfa_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"STATE <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span> <span class="main">∈</span> tdfa_Q <span class="main">⟹</span> STATE <span class="main">(</span><span class="free">bs</span><span class="main">,</span> upd_qs <span class="free">a</span> <span class="free">bs</span> <span class="free">qs</span><span class="main">)</span> <span class="main">∈</span> tdfa_Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> δ_closed
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upd_qs_def tdfa_Q_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> drop_qs_tdfa_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"STATE <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span> <span class="main">∈</span> tdfa_Q <span class="main">⟹</span> <span class="free">qs</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⟹</span>
  STATE <span class="main">(</span>drop <span class="free">m</span> <span class="free">bs</span><span class="main">,</span> drop_qs <span class="free">m</span> <span class="free">qs</span><span class="main">)</span> <span class="main">∈</span> tdfa_Q"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_qs_def tdfa_Q_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ext_qs_tdfa_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"STATE <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span> <span class="main">∈</span> tdfa_Q <span class="main">⟹</span> length <span class="free">bs</span> <span class="main">&lt;</span> t' <span class="main">⟹</span>
  STATE <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">,</span> ext_qs <span class="free">b</span> <span class="free">bs</span> <span class="free">qs</span><span class="main">)</span> <span class="main">∈</span> tdfa_Q"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ext_qs_def tdfa_Q_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_in_tdfa_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa_init <span class="main">∈</span> tdfa_Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_in_Q
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_init_def tdfa_Q_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_tdfa_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"finite tdfa_Q"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tdfa_Q <span class="main">⊆</span> <span class="main">{</span><span class="free">ACCEPT</span><span class="main">,</span> REJECT<span class="main">}</span> <span class="main">∪</span>
    STATE <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="bound">bs</span> <span class="main">::</span> <span class="tfree">'b</span> list<span class="main">.</span> length <span class="bound">bs</span> <span class="main">≤</span> t'<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">qs</span><span class="main">.</span> <span class="bound">qs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>t'<span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tdfa_Q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="bound">bs</span> <span class="main">::</span> <span class="tfree">'b</span> list<span class="main">.</span> length <span class="bound">bs</span> <span class="main">≤</span> t'<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">qs</span><span class="main">.</span> <span class="bound">qs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>t'<span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_bounded_lists finite_Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tdfa_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> tdfa_Q <span class="main">⟹</span> tdfa_step <span class="free">q</span> <span class="free">ab</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q'</span><span class="main">,</span> <span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">q'</span> <span class="main">∈</span> tdfa_Q"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">ab</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tdfa_step.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> drop_qs_tdfa_Q<span class="main">[</span><span class="operator">OF</span> ext_qs_tdfa_Q<span class="main">]</span> drop_qs_tdfa_Q<span class="main">[</span><span class="operator">OF</span> upd_qs_tdfa_Q<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="comment1">(* Theorem 14; TDFA well-defined *)</span>

<span class="keyword1"><span class="command">interpretation</span></span> tdfa<span class="main">:</span> oTDFA <span class="quoted">tdfa_init</span> <span class="quoted">tdfa_step</span> <span class="quoted">tdfa_accept</span> <span class="quoted">tdfa_Q</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> tdfa_closed
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_accept_def finite_tdfa_Q init_in_tdfa_Q<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q a b q' b2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tdfa_step.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q a b q' b1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tdfa_step.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q a b q'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tdfa_step.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q a b q'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tdfa_step.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> tdfa_axioms <span class="main">=</span> tdfa.TDFA_axioms

<span class="keyword1"><span class="command">lemma</span></span> finite_tdfa_Q_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"STATE <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span> <span class="main">∈</span> tdfa_Q <span class="main">⟹</span> finite <span class="free">qs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"STATE <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span> <span class="main">∈</span> tdfa_Q"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">qs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>length <span class="free">bs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tdfa_Q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">qs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Q finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tdfa_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> Al <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tdfa_inv</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">bs'</span></span></span> <span class="main">∧</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">,</span> take <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">⟶</span>
      <span class="bound">n</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">bs'</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> Blank <span class="main">⇒</span> True <span class="main">|</span> Symb <span class="bound">b'</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">b''</span> <span class="bound">bs''</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">@</span> <span class="bound">b''</span> <span class="main">#</span> <span class="bound">bs''</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">⟷</span>
      <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">as'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span> <span class="main">@</span> take <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tdfa_inv_aligned</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> Al <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> nat<span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tdfa_inv_aligned</span> <span class="free"><span class="bound"><span class="entity">as'</span></span></span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">qm</span><span class="main">.</span> <span class="main">(</span><span class="bound">qm</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">∧</span> tdfa_inv <span class="free"><span class="bound"><span class="entity">as'</span></span></span> <span class="free"><span class="bound"><span class="entity">bs'</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tdfa_inv_init<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="free">init</span> <span class="main">[]</span> <span class="main">⟹</span>
  tdfa_inv_aligned <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">(</span>safe_hd <span class="free">bs''</span><span class="main">)</span> <span class="main">{</span><span class="main">(</span><span class="free">init</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_in_Q no_step
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Al.splits list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> app_eq_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">@</span> <span class="free">cs'</span> <span class="main">=</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs''</span> <span class="main">⟹</span> length <span class="free">bs'</span> <span class="main">≤</span> length <span class="free">cs</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">ds</span> <span class="bound">ds'</span><span class="main">.</span> <span class="free">cs</span> <span class="main">=</span> <span class="free">bs'</span> <span class="main">@</span> <span class="bound">ds</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs''</span> <span class="main">=</span> <span class="bound">ds</span> <span class="main">@</span> <span class="bound">ds'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">bs'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">cs'</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">bs''</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> self_append_conv2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> append_eq_append_conv_if append_eq_conv_conj<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> app_eq_app'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">@</span> <span class="free">b''</span> <span class="main">#</span> <span class="free">bs''</span> <span class="main">=</span> <span class="free">ds</span> <span class="main">@</span> <span class="free">ds'</span> <span class="main">⟹</span> length <span class="free">bs</span> <span class="main">&lt;</span> length <span class="free">ds</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">e</span> <span class="bound">es</span><span class="main">.</span> <span class="free">ds</span> <span class="main">=</span> <span class="free">bs</span> <span class="main">@</span> <span class="bound">e</span> <span class="main">#</span> <span class="bound">es</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_append_conv_if id_take_nth_drop leD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tdfa_inv_upd_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa_inv_aligned <span class="free">as'</span> <span class="free">bs'</span> <span class="free">bs</span> <span class="free">b</span> <span class="free">qs</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">b</span> <span class="keyword1">of</span> Blank <span class="main">⇒</span> True <span class="main">|</span> Symb <span class="bound">b'</span> <span class="main">⇒</span> length <span class="free">bs</span> <span class="main">≥</span> t'<span class="main">)</span> <span class="main">⟹</span>
  tdfa_inv <span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="free">bs'</span> <span class="free">bs</span> <span class="free">b</span> <span class="main">(</span>upd_qs <span class="free">a</span> <span class="free">bs</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa_inv_aligned <span class="free">as'</span> <span class="free">bs'</span> <span class="free">bs</span> <span class="free">b</span> <span class="free">qs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">b</span> <span class="keyword1">of</span> Blank <span class="main">⇒</span> True <span class="main">|</span> Symb <span class="bound">b'</span> <span class="main">⇒</span> length <span class="free">bs</span> <span class="main">≥</span> t'<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> assms'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs'</span> <span class="main">⟹</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> take <span class="bound">n</span> <span class="free">bs'</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟹</span>
    active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">=</span> length <span class="free">bs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> tdfa_inv_aligned_def tdfa_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qm</span></span> <span class="keyword2"><span class="keyword">where</span></span> qm_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qm</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">qs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qm</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span> <span class="skolem">qm</span>"</span></span> <span class="quoted"><span class="quoted">"active <span class="skolem">qm</span> <span class="free">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">=</span> upd_qs <span class="free">a</span> <span class="free">bs</span> <span class="free">qs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> qs_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">qs</span> <span class="main">⟹</span>
    <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">∧</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> qs'_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs'</span> <span class="main">⟹</span>
    <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">∧</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span> <span class="skolem">n'</span>
    <span class="keyword3"><span class="command">assume</span></span> lassm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> qn_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">qs</span>"</span></span> <span class="quoted"><span class="quoted">"active <span class="skolem">q'</span> <span class="main">(</span>drop <span class="skolem">n'</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">n'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">≤</span> length <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q</span> <span class="free">a</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> take <span class="main">(</span><span class="skolem">n'</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def upd_qs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> q'_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> qs_dest<span class="main">[</span><span class="operator">OF</span> qn_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> qn_def<span class="main">(</span>5<span class="main">)</span> δ_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="skolem">n</span> <span class="free">bs</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> qs_dest<span class="main">[</span><span class="operator">OF</span> qn_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="skolem">n'</span> <span class="free">bs</span><span class="main">)</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> qn_def<span class="main">(</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> computation_snoc<span class="main">[</span><span class="operator">OF</span> _ qn_def<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_eq_appendI le_add_diff_inverse take_add<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="skolem">n'</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">∧</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="skolem">n'</span> <span class="free">bs</span><span class="main">)</span> <span class="skolem">q'</span> <span class="main">∧</span>
      active <span class="skolem">q'</span> <span class="main">(</span>drop <span class="skolem">n'</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> q'_Q qn_def<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> qs_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">⟹</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟹</span>
    active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">qs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> qs'_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">⟹</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟹</span>
    active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span> <span class="skolem">n'</span>
    <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">≤</span> length <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="skolem">n'</span> <span class="free">bs</span><span class="main">)</span> <span class="skolem">q'</span>"</span></span>
      <span class="quoted"><span class="quoted">"active <span class="skolem">q'</span> <span class="main">(</span>drop <span class="skolem">n'</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q''</span> <span class="free">a</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="skolem">q'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">bs'</span> <span class="main">@</span> take <span class="skolem">n'</span> <span class="free">bs</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> computation_split<span class="main">[</span><span class="operator">OF</span> lassms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> step_dest <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> active_q''<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="skolem">q''</span> <span class="main">(</span><span class="skolem">cs'</span> <span class="main">@</span> drop <span class="skolem">n'</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> active_comp lassms<span class="main">(</span>4<span class="main">)</span> split<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs</span> <span class="main">≥</span> length <span class="free">bs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> assms' active_q'' lassms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_append_conv_if <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_le_linear<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="skolem">n</span> <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">n'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>4<span class="main">)</span> lassms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_append_conv_if append_eq_conv_conj<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj min.cobounded1 min.commute take_take<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> cs'_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">@</span> drop <span class="skolem">n'</span> <span class="free">bs</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="free">bs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> n_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> n_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc append_take_drop_id same_append_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> cs'_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">n'</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> n_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> n_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc le_add_diff_inverse same_append_eq take_add<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> q''_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>1<span class="main">)</span> init_in_Q comp_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> q''_n_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q''</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">qs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> qs_intro q''_Q n_def<span class="main">(</span>2<span class="main">)</span> lassms<span class="main">(</span>2<span class="main">)</span> split<span class="main">(</span>1<span class="main">)</span> active_q''
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs'_drop<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n_def<span class="main">(</span>2<span class="main">)</span> lassms<span class="main">(</span>2<span class="main">)</span> active_q'' split<span class="main">(</span>2<span class="main">)</span> lassms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def upd_qs_def cs'_take<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs'</span> <span class="main">⟹</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> take <span class="bound">n</span> <span class="free">bs'</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟹</span>
    active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">=</span> length <span class="free">bs'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">n'</span>
    <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">≤</span> length <span class="free">bs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> take <span class="skolem">n'</span> <span class="free">bs'</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
      <span class="quoted"><span class="quoted">"active <span class="skolem">q</span> <span class="main">(</span>drop <span class="skolem">n'</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
      <span class="quoted"><span class="quoted">"take <span class="skolem">n'</span> <span class="free">bs'</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> computation_split<span class="main">[</span><span class="operator">OF</span> lassms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="free">bs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">n'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>3<span class="main">)</span> lassms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj min.cobounded1 min.commute take_take<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="free">bs'</span> <span class="main">=</span> <span class="skolem">cs'</span> <span class="main">@</span> drop <span class="skolem">n'</span> <span class="free">bs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n_def lassms<span class="main">(</span>1<span class="main">)</span> split<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc append_take_drop_id same_append_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"active <span class="skolem">q''</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> active_comp<span class="main">[</span><span class="operator">OF</span> lassms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> split<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> length <span class="free">bs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms'<span class="main">[</span><span class="operator">OF</span> _ split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> n_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> n_def<span class="main">(</span>2<span class="main">)</span> lassms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">b</span> <span class="keyword1">of</span> Blank <span class="main">⇒</span> True <span class="main">|</span> Symb <span class="bound">b'</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">b''</span> <span class="bound">bs''</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">@</span> <span class="bound">b''</span> <span class="main">#</span> <span class="bound">bs''</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Symb <span class="skolem">b'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> len_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">≥</span> <span class="free">t</span> <span class="main">+</span> output_speed"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> Symb<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">b''</span> <span class="bound">bs''</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">@</span> <span class="bound">b''</span> <span class="main">#</span> <span class="bound">bs''</span><span class="main">)</span><span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">b''</span> <span class="skolem">bs''</span>
      <span class="keyword3"><span class="command">assume</span></span> lassm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">¬</span> <span class="main">(</span><span class="free">init</span><span class="main">↝</span><span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">@</span> <span class="skolem">b''</span> <span class="main">#</span> <span class="skolem">bs''</span><span class="main">)</span><span class="skolem">q</span> <span class="main">∧</span> active <span class="skolem">q</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">↝</span><span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span> <span class="main">=</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">@</span> <span class="skolem">b''</span> <span class="main">#</span> <span class="skolem">bs''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> computation_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q''</span> <span class="free">a</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">cs'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_dest <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs'</span> <span class="main">≤</span> output_speed"</span></span>
        <span class="keyword1"><span class="command">using</span></span> init_in_Q comp_closed<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> output_speed_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs</span> <span class="main">+</span> length <span class="skolem">cs'</span> <span class="main">≥</span> length <span class="free">bs'</span> <span class="main">+</span> <span class="free">t</span> <span class="main">+</span> output_speed <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">length</span><span class="main">]</span> len_bs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> len_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs</span> <span class="main">≥</span> length <span class="free">bs'</span> <span class="main">+</span> <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="skolem"><span class="skolem">ds'</span></span> <span class="keyword2"><span class="keyword">where</span></span> split'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="free">bs'</span> <span class="main">@</span> <span class="skolem">ds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">@</span> <span class="skolem">b''</span> <span class="main">#</span> <span class="skolem">bs''</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">ds'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> app_eq_app<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> active_q''<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="skolem">q''</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassm active_comp split<span class="main">(</span>2<span class="main">)</span> active_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ds</span> <span class="main">≤</span> length <span class="free">bs</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"active <span class="skolem">qm</span> <span class="skolem">ds</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> qm_def<span class="main">(</span>4<span class="main">)</span> split'<span class="main">(</span>2<span class="main">)</span> True active_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">qm</span></span> <span class="quoted"><span class="skolem">ds</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> app_eq_app append.left_neutral<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ds</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> bounded'<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> split'<span class="main"><span class="main">]</span></span> active_q'' qm_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> split'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">length</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> len_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> es_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">=</span> <span class="free">bs</span> <span class="main">@</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">es</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> app_eq_app'<span class="main">[</span><span class="operator">OF</span> split'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">b''</span> <span class="bound">bs''</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">@</span> <span class="bound">b''</span> <span class="main">#</span> <span class="bound">bs''</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Symb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> split'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> es_def<span class="main">]</span> active_q'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Symb
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tdfa_inv <span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="free">bs'</span> <span class="free">bs</span> <span class="free">b</span> <span class="main">(</span>upd_qs <span class="free">a</span> <span class="free">bs</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> qs'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> tdfa_inv_def
    <span class="keyword1"><span class="command">using</span></span> qs'_dest qs'_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> drop_take_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">⟹</span> drop <span class="free">n</span> <span class="free">bs</span> <span class="main">=</span> drop <span class="free">n</span> <span class="main">(</span>take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="main">@</span> drop <span class="free">m</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc append_eq_conv_conj append_take_drop_id length_take min.absorb2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tdfa_inv_drop_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa_inv <span class="free">as'</span> <span class="free">bs'</span> <span class="free">bs</span> <span class="free">b</span> <span class="free">qs</span> <span class="main">⟹</span> <span class="free">qs</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="free">qs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">m</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">∧</span> tdfa_inv_aligned <span class="free">as'</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="free">b</span> <span class="main">(</span>drop_qs <span class="free">m</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa_inv <span class="free">as'</span> <span class="free">bs'</span> <span class="free">bs</span> <span class="free">b</span> <span class="free">qs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">qs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">=</span> drop_qs <span class="free">m</span> <span class="free">qs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> qs_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">qs</span> <span class="main">⟹</span>
    <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">∧</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> qs_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">qs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>length <span class="free">bs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> snd_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>snd <span class="main">`</span> <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> <span class="free">qs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Q finite_subset assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> m_leq_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> length <span class="free">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> qs_dest Min_in<span class="main">[</span><span class="operator">OF</span> snd_qs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qm</span></span> <span class="keyword2"><span class="keyword">where</span></span> qm_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qm</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">qs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Min_in<span class="main">[</span><span class="operator">OF</span> snd_qs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qm_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qm</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> drop_qs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs'</span> <span class="main">⟹</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> take <span class="bound">n</span> <span class="free">bs'</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟹</span>
    active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">=</span> length <span class="free">bs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> qs_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">⟹</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟹</span>
    active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">qs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> take <span class="bound">n</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟹</span>
    active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>drop <span class="free">m</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">=</span> length <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> take <span class="skolem">n</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
      <span class="quoted"><span class="quoted">"active <span class="skolem">q</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>drop <span class="free">m</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> length <span class="free">bs'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> q_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> init_in_Q comp_closed lassms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> length <span class="free">bs'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> n'_le_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">≤</span> length <span class="free">bs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True lassms<span class="main">(</span>1<span class="main">)</span> m_leq_bs
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="skolem">n'</span> <span class="free">bs</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> True m_leq_bs
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_absorb1 n'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"active <span class="skolem">q</span> <span class="main">(</span>drop <span class="skolem">n'</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n'</span> <span class="free">bs</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="main">@</span> drop <span class="free">m</span> <span class="free">bs</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n'_def True m_leq_bs lassms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n'</span> <span class="free">bs</span> <span class="main">=</span> drop <span class="skolem">n'</span> <span class="main">(</span>take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="main">@</span> drop <span class="free">m</span> <span class="free">bs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> m_leq_bs
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> drop_take_drop<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="main">@</span> drop <span class="free">m</span> <span class="free">bs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> m_leq_bs True
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n'_def<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">≥</span> <span class="free">m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> qs_intro<span class="main">[</span><span class="operator">OF</span> q_Q n'_le_bs<span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> Min_le<span class="main">[</span><span class="operator">OF</span> snd_qs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> n'_def True lassms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> m_leq_bs min nat_le_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">b</span> <span class="keyword1">of</span> Blank <span class="main">⇒</span> True <span class="main">|</span> Symb <span class="bound">b'</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">b''</span> <span class="bound">bs''</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="main">@</span> drop <span class="free">m</span> <span class="free">bs</span> <span class="main">@</span> <span class="bound">b''</span> <span class="main">#</span> <span class="bound">bs''</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> m_leq_bs
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Al.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc append_take_drop_id<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tdfa_inv <span class="free">as'</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="free">b</span> <span class="skolem">qs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> m_leq_bs
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_def qs'_def drop_qs_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.commute take_add<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute take_add<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">∧</span> tdfa_inv_aligned <span class="free">as'</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="free">b</span> <span class="main">(</span>drop_qs <span class="free">m</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> qs'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> tdfa_inv_aligned_def
    <span class="keyword1"><span class="command">using</span></span> m_leq_bs qm_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tdfa_inv_ext_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa_inv <span class="free">as'</span> <span class="free">bs'</span> <span class="free">bs</span> <span class="main">(</span>Symb <span class="free">b</span><span class="main">)</span> <span class="free">qs</span> <span class="main">⟹</span>
  tdfa_inv <span class="free">as'</span> <span class="free">bs'</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span>ext_qs <span class="free">b</span> <span class="free">bs</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa_inv <span class="free">as'</span> <span class="free">bs'</span> <span class="free">bs</span> <span class="main">(</span>Symb <span class="free">b</span><span class="main">)</span> <span class="free">qs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> assms'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">b''</span> <span class="bound">bs''</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">@</span> <span class="bound">b''</span> <span class="main">#</span> <span class="bound">bs''</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">=</span> ext_qs <span class="free">b</span> <span class="free">bs</span> <span class="free">qs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> qs'_sub_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">⊆</span> <span class="free">qs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def ext_qs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> qs_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">qs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>length <span class="free">bs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> snd_qs'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Q qs'_sub_qs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> qs_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">qs</span> <span class="main">⟹</span>
    <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">∧</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_def ext_qs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qs'_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs'</span> <span class="main">⟹</span>
    <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="bound">n</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span>
    active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def ext_qs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> qs_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">⟹</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟹</span>
    active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">qs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> qs'_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="bound">n</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟹</span> active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="skolem">n</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
      <span class="quoted"><span class="quoted">"active <span class="skolem">q</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> n_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="free">bs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms' lassms<span class="main">(</span>3<span class="main">)</span> active_mono lassms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> qs_intro<span class="main">[</span><span class="operator">OF</span> lassms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> n_le<span class="main">]</span> active_mono
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def ext_qs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs'</span> <span class="main">⟹</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> take <span class="bound">n</span> <span class="free">bs'</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟹</span> active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="bound">n</span> <span class="main">=</span> length <span class="free">bs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="free">bs'</span> <span class="main">⟹</span> <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> take <span class="bound">n</span> <span class="free">bs'</span><span class="main">)</span> <span class="bound">q</span> <span class="main">⟹</span>
    active <span class="bound">q</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">bs'</span> <span class="main">@</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">=</span> length <span class="free">bs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> active_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> Blank <span class="main">⇒</span> True <span class="main">|</span> Symb <span class="bound">b'</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">b''</span> <span class="bound">bs''</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="bound">b''</span> <span class="main">#</span> <span class="bound">bs''</span><span class="main">)</span> <span class="bound">q</span> <span class="main">∧</span> active <span class="bound">q</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> Al.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tdfa_inv <span class="free">as'</span> <span class="free">bs'</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span>ext_qs <span class="free">b</span> <span class="free">bs</span> <span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tdfa_inv_def qs'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> qs'_dest qs'_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tdfa_inv_drop_upd_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa_inv_aligned <span class="free">as'</span> <span class="free">bs'</span> <span class="free">bs</span>
  <span class="main">(</span><span class="keyword1">if</span> length <span class="free">bs</span> <span class="main">≥</span> t' <span class="keyword1">then</span> <span class="free">ext_b</span> <span class="keyword1">else</span> Blank<span class="main">)</span> <span class="free">qs</span> <span class="main">⟹</span>
  <span class="free">qs'</span> <span class="main">=</span> upd_qs <span class="free">a</span> <span class="free">bs</span> <span class="free">qs</span> <span class="main">⟹</span> <span class="free">qs'</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="free">qs'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">∧</span>
  tdfa_inv_aligned <span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">m</span> <span class="free">bs</span><span class="main">)</span>
  <span class="main">(</span><span class="keyword1">if</span> length <span class="free">bs</span> <span class="main">≥</span> t' <span class="keyword1">then</span> <span class="free">ext_b</span> <span class="keyword1">else</span> Blank<span class="main">)</span> <span class="main">(</span>drop_qs <span class="free">m</span> <span class="free">qs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tdfa_inv_drop_qs<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> tdfa_inv_upd_qs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits Al.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tdfa_inv_drop_ext_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa_inv_aligned <span class="free">as'</span> <span class="free">bs'</span> <span class="free">bs</span> <span class="main">(</span>Symb <span class="free">b</span><span class="main">)</span> <span class="free">qs</span> <span class="main">⟹</span>
  <span class="free">qs'</span> <span class="main">=</span> ext_qs <span class="free">b</span> <span class="free">bs</span> <span class="free">qs</span> <span class="main">⟹</span> <span class="free">qs'</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="free">qs'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
  tdfa_inv_aligned <span class="free">as'</span> <span class="main">(</span><span class="free">bs'</span> <span class="main">@</span> take <span class="free">m</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">m</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span>drop_qs <span class="free">m</span> <span class="free">qs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tdfa_inv_drop_qs<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> tdfa_inv_ext_qs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> τ_tdfa_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">↝</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> drop <span class="free">n</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs''</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">accept</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="free">as'</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> take <span class="free">n</span> <span class="free">bs</span><span class="main">)</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≤</span> length <span class="free">bs</span> <span class="main">⟹</span>
  STATE <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span> <span class="main">∈</span> tdfa_Q <span class="main">⟹</span> tdfa_inv_aligned <span class="free">as'</span> <span class="free">bs'</span> <span class="free">bs</span> <span class="main">(</span>safe_hd <span class="free">bs''</span><span class="main">)</span> <span class="free">qs</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> tdfa.computation <span class="main">(</span>STATE <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span> <span class="main">∧</span> tdfa_accept <span class="bound">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">as</span><span class="main">,</span> drop <span class="free">n</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs''</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">bs''</span></span> <span class="quoted"><span class="free">as'</span></span> <span class="quoted"><span class="free">bs'</span></span> <span class="quoted"><span class="free">qs</span></span>
  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> computation.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def active_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> base<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def active_def
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"STATE <span class="main">(</span><span class="skolem">bs</span><span class="main">,</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tdfa_accept_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">q'</span> <span class="skolem">cs</span> <span class="skolem">as</span> <span class="skolem">cs'</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">bs''</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="skolem">bs</span></span> <span class="quoted"><span class="skolem">as'</span></span> <span class="quoted"><span class="skolem">bs'</span></span> <span class="quoted"><span class="skolem">qs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">=</span> upd_qs <span class="skolem">a</span> <span class="skolem">bs</span> <span class="skolem">qs</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> n_cs_le_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span> <span class="main">≤</span> length <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>4<span class="main">,</span>8<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.le_diff_conv2 add.commute le_add1 length_append length_drop self_append_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> cs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute append_Nil2 append_eq_conv_conj drop_drop<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> act_q<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="skolem">q</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> active_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nil.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> computation.step<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> act_q'<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="skolem">q'</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> active_def cs'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.right_neutral<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> q_n_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> act_q Nil<span class="main">(</span>6<span class="main">,</span>7<span class="main">,</span>8<span class="main">,</span>9<span class="main">,</span>10<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> fin_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">qs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_tdfa_Q_qs Nil<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> cs_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 append_eq_conv_conj<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> q'_qs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>1<span class="main">)</span> cs_take Nil<span class="main">(</span>4<span class="main">)</span> act_q' n_cs_le_bs q_n_qs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_def qs'_def upd_qs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qs'_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> qs_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>length <span class="skolem">bs</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_Q_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qs'_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>length <span class="skolem">bs</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> δ_closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def upd_qs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> snd_qs'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> <span class="skolem">qs'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_Q finite_subset qs'_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> m_n_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m_def Min_le<span class="main">[</span><span class="operator">OF</span> snd_qs'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> q'_qs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> inv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> length <span class="skolem">bs</span> <span class="main">∧</span> tdfa_inv_aligned <span class="main">(</span><span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bs'</span> <span class="main">@</span> take <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">)</span> Blank
      <span class="main">(</span>drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tdfa_inv_drop_upd_qs<span class="main">[</span><span class="operator">OF</span> _ qs'_def qs'_nonempty m_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">as'</span></span> <span class="quoted"><span class="skolem">bs'</span></span><span class="main">]</span> Nil<span class="main">(</span>10<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"t' <span class="main">≤</span> length <span class="skolem">bs</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> q'_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>1<span class="main">,</span>7<span class="main">)</span> δ_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> drop_tdfa_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"STATE <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">,</span> drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span> <span class="main">∈</span> tdfa_Q"</span></span>
      <span class="keyword1"><span class="command">using</span></span> qs'_def m_def drop_qs_tdfa_Q<span class="main">[</span><span class="operator">OF</span> upd_qs_tdfa_Q<span class="main">,</span> <span class="operator">OF</span> Nil<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">]</span> qs'_nonempty
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def m_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> init'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="skolem">bs'</span> <span class="main">@</span> take <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">@</span> take <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>1<span class="main">,</span>6<span class="main">)</span> cs_take
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc computation_snoc le_add_diff_inverse m_n_cs take_add<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> cs'_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cs'_def m_n_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"tdfa.computation <span class="main">(</span>STATE <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">,</span> drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"tdfa_accept <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Nil<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> init' q'_Q _ drop_tdfa_Q<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> n_cs_le_bs m_n_cs
        cs'_def conjunct2<span class="main">[</span><span class="operator">OF</span> inv'<span class="main">]</span> cs'_def'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa_step <span class="main">(</span>STATE <span class="main">(</span><span class="skolem">bs</span><span class="main">,</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Symb <span class="skolem">a</span><span class="main">,</span> Blank<span class="main">)</span> <span class="main">=</span>
      Some <span class="main">(</span>STATE <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">,</span> drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> qs'_def m_def qs'_nonempty Nil<span class="main">(</span>9<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">≥</span> t'"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> r_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> step
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> q_q''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">↝</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">,</span> drop <span class="skolem">n</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs''</span><span class="main">)</span> <span class="skolem">q''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> computation.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> act_q_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="skolem">q</span> <span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> q_q'' Cons<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> active_mono
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> active_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> act_q<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="skolem">q</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> q_q'' Cons<span class="main">(</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> active_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> append_Nil2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> act_q_b<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="skolem">q</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> active_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> q_n_qs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>7<span class="main">,</span>8<span class="main">,</span>9<span class="main">,</span>11<span class="main">)</span> act_q
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def active_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> q'_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">,</span>8<span class="main">)</span> δ_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">≥</span> t'"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">=</span> upd_qs <span class="skolem">a</span> <span class="skolem">bs</span> <span class="skolem">qs</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> qs_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>length <span class="skolem">bs</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>10<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_Q_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> n_cs_le_bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span> <span class="main">≤</span> length <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">qs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> finite_Q finite_subset qs_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qm</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qm</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>11<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> init_qm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="skolem">bs'</span><span class="main">)</span> <span class="skolem">qm</span>"</span></span> <span class="quoted"><span class="quoted">"active <span class="skolem">qm</span> <span class="skolem">bs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>11<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> init_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="skolem">bs'</span> <span class="main">@</span> take <span class="skolem">n</span> <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"active <span class="skolem">q</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> q_n_qs Cons<span class="main">(</span>11<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> act_q_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="skolem">q</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> init_q<span class="main">(</span>2<span class="main">)</span> active_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> act_qm<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="skolem">qm</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> init_qm<span class="main">(</span>2<span class="main">)</span> Cons<span class="main">(</span>9<span class="main">)</span> active_mono
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> bounded'<span class="main">[</span><span class="operator">OF</span> init_q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> act_q_empty init_qm<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> act_qm<span class="main">]</span> Cons<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">cs</span> <span class="main">≤</span> output_speed"</span></span>
          <span class="keyword1"><span class="command">using</span></span> output_speed_step Cons<span class="main">(</span>2<span class="main">,</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">unfolding</span></span> t'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> cs'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>5<span class="main">)</span> n_cs_le_bs
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> add.commute add_le_imp_le_left append_eq_append_conv_if drop_drop
            le_add_diff_inverse length_drop<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> act_q'<span class="main">:</span> <span class="quoted"><span class="quoted">"active <span class="skolem">q'</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> act_q Cons<span class="main">(</span>2<span class="main">)</span> n_cs_le_bs
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> active_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cs'_def step.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> step.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> cs_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n_cs_le_bs Cons<span class="main">(</span>5<span class="main">)</span> append_eq_conv_conj cs'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> q'_qs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cs_take act_q' n_cs_le_bs q_n_qs upd_qs_def Cons<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_def qs'_def upd_qs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qs'_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> qs'_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>length <span class="skolem">bs</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> qs_sub δ_closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def upd_qs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> snd_qs'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> <span class="skolem">qs'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_Q finite_subset qs'_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> m_n_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m_def Min_le<span class="main">[</span><span class="operator">OF</span> snd_qs'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> q'_qs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> inv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> length <span class="skolem">bs</span> <span class="main">∧</span> tdfa_inv_aligned <span class="main">(</span><span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bs'</span> <span class="main">@</span> take <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">)</span>
        <span class="main">(</span>Symb <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tdfa_inv_drop_upd_qs<span class="main">[</span><span class="operator">OF</span> _ qs'_def qs'_nonempty m_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">as'</span></span> <span class="quoted"><span class="skolem">bs'</span></span><span class="main">]</span> Cons<span class="main">(</span>11<span class="main">)</span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> q'_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">,</span>8<span class="main">)</span> δ_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> drop_tdfa_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"STATE <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">,</span> drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span> <span class="main">∈</span> tdfa_Q"</span></span>
        <span class="keyword1"><span class="command">using</span></span> qs'_def m_def drop_qs_tdfa_Q<span class="main">[</span><span class="operator">OF</span> upd_qs_tdfa_Q<span class="main">]</span> Cons<span class="main">(</span>10<span class="main">)</span> qs'_nonempty
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def m_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> init'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="skolem">bs'</span> <span class="main">@</span> take <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">@</span> take <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">,</span>7<span class="main">)</span> cs_take m_n_cs computation_snoc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc le_add_diff_inverse take_add<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> cs'_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">cs</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cs'_def m_n_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_def<span class="main">:</span>
        <span class="quoted"><span class="quoted">"tdfa.computation <span class="main">(</span>STATE <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">,</span> drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
        <span class="quoted"><span class="quoted">"tdfa_accept <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ _ init' q'_Q _ drop_tdfa_Q<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs''</span>"</span></span><span class="main">]</span> Cons<span class="main">(</span>6<span class="main">)</span> n_cs_le_bs m_n_cs
          cs'_def conjunct2<span class="main">[</span><span class="operator">OF</span> inv'<span class="main">]</span> cs'_def'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def<span class="main">)</span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa_step <span class="main">(</span>STATE <span class="main">(</span><span class="skolem">bs</span><span class="main">,</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Symb <span class="skolem">a</span><span class="main">,</span> Symb <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span>
        Some <span class="main">(</span>STATE <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">,</span> drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span><span class="main">,</span> True<span class="main">,</span> False<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>10<span class="main">)</span> qs'_def m_def qs'_nonempty True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> r_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> step
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">=</span> ext_qs <span class="skolem">b</span> <span class="skolem">bs</span> <span class="skolem">qs</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> qs'_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> q_n_qs Cons<span class="main">(</span>9<span class="main">)</span> act_q_b
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def ext_qs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa_step <span class="main">(</span>STATE <span class="main">(</span><span class="skolem">bs</span><span class="main">,</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Symb <span class="skolem">a</span><span class="main">,</span> Symb <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span>
        Some <span class="main">(</span>STATE <span class="main">(</span>drop <span class="skolem">m</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span><span class="main">,</span> False<span class="main">,</span> True<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>10<span class="main">)</span> qs'_def m_def qs'_nonempty False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> inv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> tdfa_inv_aligned <span class="skolem">as'</span> <span class="main">(</span><span class="skolem">bs'</span> <span class="main">@</span> take <span class="skolem">m</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>drop <span class="skolem">m</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>safe_hd <span class="skolem">bs''</span><span class="main">)</span> <span class="main">(</span>drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>11<span class="main">)</span> tdfa_inv_drop_ext_qs<span class="main">[</span><span class="operator">OF</span> _ qs'_def qs'_nonempty m_def<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> drop_tdfa_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"STATE <span class="main">(</span>drop <span class="skolem">m</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> drop_qs <span class="skolem">m</span> <span class="main">(</span>ext_qs <span class="skolem">b</span> <span class="skolem">bs</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> tdfa_Q"</span></span>
        <span class="keyword1"><span class="command">using</span></span> qs'_def m_def drop_qs_tdfa_Q<span class="main">[</span><span class="operator">OF</span> ext_qs_tdfa_Q<span class="main">,</span> <span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span><span class="main">]</span> False qs'_nonempty
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def m_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> q_n_qs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> q_n_qs Cons<span class="main">(</span>9<span class="main">)</span> act_q_b
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def ext_qs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> qs_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>length <span class="skolem">bs</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_Q_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qs'_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>length <span class="skolem">bs</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qs'_def ext_qs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> snd_qs'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> <span class="skolem">qs'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_Q finite_subset qs'_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> m_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> q_n_qs' m_def Min_le<span class="main">[</span><span class="operator">OF</span> snd_qs'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> cs_app_cs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">@</span> <span class="skolem">cs'</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m_n conjunct1<span class="main">[</span><span class="operator">OF</span> inv'<span class="main">]</span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="skolem">m</span> <span class="main">≤</span> length <span class="main">(</span>drop <span class="skolem">m</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> inv'<span class="main">]</span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">↝</span><span class="main">(</span><span class="skolem">as'</span><span class="main">,</span> <span class="main">(</span><span class="skolem">bs'</span> <span class="main">@</span> take <span class="skolem">m</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> take <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>7<span class="main">)</span> m_n conjunct1<span class="main">[</span><span class="operator">OF</span> inv'<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> append_Nil2 append_eq_append_conv2 append_eq_conv_conj
            diff_is_0_eq' le_add_diff_inverse list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> take_add take_append<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_def<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa.computation <span class="main">(</span>STATE <span class="main">(</span>drop <span class="skolem">m</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">bs''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"tdfa_accept <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> _ cs_app_cs' Cons<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> _ Cons<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> _
          drop_tdfa_Q<span class="main"><span class="main">[</span></span><span class="operator">folded</span> qs'_def<span class="main"><span class="main">]</span></span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv'<span class="main"><span class="main">]</span></span><span class="main">]</span> Cons<span class="main">(</span>4<span class="main">)</span> m_n conjunct1<span class="main">[</span><span class="operator">OF</span> inv'<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> r_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> step
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tdfa_τ_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa.computation <span class="main">(</span>STATE <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟹</span>
  tdfa_accept <span class="free">r</span> <span class="main">⟹</span> tdfa_inv_aligned <span class="free">as'</span> <span class="free">bs'</span> <span class="free">bs</span> <span class="main">(</span>safe_hd <span class="free">bs''</span><span class="main">)</span> <span class="free">qs</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">as'</span> <span class="main">@</span> <span class="free">as</span><span class="main">,</span> <span class="free">bs'</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs''</span><span class="main">)</span> <span class="main">∈</span> τ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"STATE <span class="main">(</span><span class="free">bs</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="main">[]</span> <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">bs''</span><span class="main">,</span> <span class="main">[]</span> <span class="main">::</span> <span class="tfree">'b</span> list<span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">r</span></span>
    <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">qs</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs''</span></span> <span class="quoted"><span class="free">as'</span></span> <span class="quoted"><span class="free">bs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tdfa.computation.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> qn_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">qs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> base<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tdfa_accept_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> base<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tdfa_inv_aligned_def tdfa_inv_def τ_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_TF <span class="skolem">a</span> <span class="skolem">bs''</span> <span class="skolem">q'</span> <span class="skolem">as</span> <span class="skolem">q''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">=</span> upd_qs <span class="skolem">a</span> <span class="skolem">bs</span> <span class="skolem">qs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> STATE <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">,</span> drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qs'_def m_def step_TF<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>t' <span class="main">≤</span> length <span class="skolem">bs</span> <span class="main">⟹</span> <span class="skolem">bs''</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_TF<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs''</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> length <span class="skolem">bs</span> <span class="main">∧</span>
    tdfa_inv_aligned <span class="main">(</span><span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bs'</span> <span class="main">@</span> take <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>safe_hd <span class="skolem">bs''</span><span class="main">)</span> <span class="main">(</span>drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tdfa_inv_drop_upd_qs<span class="main">[</span><span class="operator">OF</span> _ qs'_def props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> m_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">as'</span></span> <span class="quoted"><span class="skolem">bs'</span></span><span class="main">]</span> step_TF<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"t' <span class="main">≤</span> length <span class="skolem">bs</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_Nil <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> step_TF<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> step_TF<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">as'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'</span> <span class="main">@</span> take <span class="skolem">m</span> <span class="skolem">bs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> append.assoc append_take_drop_id<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step_FT <span class="skolem">as</span> <span class="skolem">b</span> <span class="skolem">q'</span> <span class="skolem">bs''</span> <span class="skolem">q''</span> <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">=</span> ext_qs <span class="skolem">b</span> <span class="skolem">bs</span> <span class="skolem">qs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Min <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> props<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">&lt;</span> t'"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> STATE <span class="main">(</span>drop <span class="skolem">m</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qs'_def m_def step_FT<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"tdfa_inv_aligned <span class="skolem">as'</span> <span class="main">(</span><span class="skolem">bs'</span> <span class="main">@</span> take <span class="skolem">m</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>drop <span class="skolem">m</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>safe_hd <span class="skolem">bs''</span><span class="main">)</span> <span class="main">(</span>drop_qs <span class="skolem">m</span> <span class="skolem">qs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tdfa_inv_drop_ext_qs<span class="main">[</span><span class="operator">OF</span> _ qs'_def props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> m_def<span class="main">]</span> step_FT<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_hd_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> step_FT<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> props<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> step_FT<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> inv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> inv<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc append_Cons append_Nil append_take_drop_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_REJECT_ACCEPT<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tdfa.computation <span class="free">q</span> <span class="main">(</span><span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">as'</span><span class="main">)</span><span class="main">,</span> <span class="free">bs</span><span class="main">,</span> <span class="free">bs'</span><span class="main">)</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> REJECT <span class="main">⟹</span> tdfa_accept <span class="free">q'</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> tdfa.comp_unreachable<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tdfa_accept_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_active_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>active <span class="free">init</span> <span class="main">[]</span> <span class="main">⟹</span> tdfa.τ <span class="main">=</span> τ"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_REJECT_ACCEPT
  <span class="keyword1"><span class="command">unfolding</span></span> tdfa.τ_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> active_def tdfa_init_def τ_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tdfa_τ_sub_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"tdfa.τ <span class="main">⊆</span> τ"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tdfa_τ_τ<span class="main">[</span><span class="operator">OF</span> _ _ tdfa_inv_init<span class="main">]</span> not_active_init
  <span class="keyword1"><span class="command">unfolding</span></span> tdfa.τ_def
  <span class="keyword1"><span class="command">unfolding</span></span> tdfa_init_def tdfa_accept_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> τ_sub_tdfa_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="main">⊆</span> tdfa.τ"</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_in_tdfa_Q
  <span class="keyword1"><span class="command">unfolding</span></span> τ_def tdfa.τ_def
  <span class="keyword1"><span class="command">unfolding</span></span> tdfa_init_def
  <span class="keyword1"><span class="command">using</span></span> τ_tdfa_τ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="main">_</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> init_in_Q tdfa_inv_init
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> active_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="comment1">(* Theorem 14; TDFA equivalent *)</span>
<span class="keyword1"><span class="command">lemma</span></span> tdfa_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="main">=</span> tdfa.τ"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tdfa_τ_sub_τ τ_sub_tdfa_τ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</body>

</html>